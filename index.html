<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¿ƒéˆæ€¥æ•‘ç®±</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        /* --- ğŸ¨ è¦–è¦ºé¢¨æ ¼è¨­è¨ˆ --- */
        :root {
            --primary: #7A9F6E;       /* æº«æš–æŠ¹èŒ¶ç¶  */
            --primary-dark: #58754F;
            --primary-light: #EBF2EA; /* æ¥µæ·ºç¶ èƒŒæ™¯ */
            
            --bg: #FCFAF7;            /* ç±³è‰²ç´™å¼µè³ªæ„Ÿ */
            --card-bg: #FFFFFF;
            
            --text-main: #5C5552;     /* æ·±æš–ç° */
            --text-sub: #9E9894;
            
            --accent-warm: #D67D68;   /* è±†æ²™ç´… (æ„›å¿ƒè‰²) */
            
            --radius-box: 24px;
            --radius-btn: 16px;       /* æƒ…ç·’æŒ‰éˆ•çš„åœ“è§’ */
            
            --shadow-soft: 0 8px 20px rgba(122, 159, 110, 0.15);
        }

        body {
            font-family: "Zen Maru Gothic", sans-serif; /* å…¨ç«™åœ“é«” */
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 24px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            line-height: 1.6;
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤æ‰‹æ©Ÿé»æ“Šè—æ¡† */
        }

        /* --- Header --- */
        header { 
            text-align: center; 
            margin-bottom: 24px; 
            margin-top: 10px;
        }
        
        h1 { 
            font-weight: 900; /* æœ€ç²—é«”ï¼Œåƒé¦¬å…‹ç­†å¯«çš„æ¨™é¡Œ */
            font-size: 2.4rem;
            margin: 0; 
            color: var(--primary); 
            letter-spacing: 1px;
        }
        
        p.subtitle { 
            font-size: 1rem; 
            color: var(--text-sub); 
            margin-top: 5px; 
            font-weight: 500;
        }

        /* --- ğŸ” æœå°‹æ¬„ --- */
        .search-container {
            width: 100%;
            max-width: 500px;
            margin-bottom: 24px;
        }
        #search-input {
            width: 100%;
            padding: 16px 24px;
            border-radius: 50px;
            border: 2px solid white;
            background: white;
            font-size: 1rem;
            font-family: "Zen Maru Gothic", sans-serif;
            font-weight: 700;
            color: var(--text-main);
            outline: none;
            box-shadow: var(--shadow-soft);
            box-sizing: border-box;
            transition: all 0.3s;
        }
        #search-input:focus {
            border-color: var(--primary);
        }
        #search-input::placeholder { color: #D1CEC7; font-weight: 500; }

        /* --- ğŸš‘ æƒ…ç·’å¿«ç¯©å€ (Layout æ›´æ–°) --- */
        .triage-section {
            width: 100%;
            max-width: 500px;
            background: var(--primary-light);
            padding: 24px;
            padding-bottom: 30px; /* ç•™çµ¦å³ä¸‹è§’æŒ‰éˆ•ç©ºé–“ */
            border-radius: var(--radius-box);
            margin-bottom: 32px;
            position: relative; /* ç‚ºäº†å®šä½å³ä¸‹è§’çš„æ„›å¿ƒ */
            box-sizing: border-box;
            box-shadow: inset 0 0 0 2px rgba(255,255,255,0.5); /* åƒè²¼ç´™çš„ç™½é‚Š */
        }
        
        .triage-title { 
            font-size: 1.1rem; 
            margin-bottom: 16px; 
            color: var(--primary-dark);
            font-weight: 900;
            text-align: center;
        }

        /* æƒ…ç·’æŒ‰éˆ•ç¶²æ ¼ï¼š3åˆ— x 2è¡Œ */
        .mood-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* å…©æ¬„ */
            gap: 12px;
            margin-bottom: 10px;
        }
        
        .mood-btn {
            background: white;
            border: none;
            color: var(--text-main);
            padding: 12px 10px;
            border-radius: var(--radius-btn);
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: "Zen Maru Gothic", sans-serif;
            font-weight: 700;
            box-shadow: 0 4px 0 rgba(0,0,0,0.05); /* åƒæŒ‰éµçš„ç«‹é«”æ„Ÿ */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mood-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }
        .mood-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: inset 0 3px 5px rgba(0,0,0,0.1); /* æŒ‰ä¸‹å»çš„å‡¹é™·æ„Ÿ */
            transform: translateY(2px);
        }

        /* å³ä¸‹è§’ï¼šæˆ‘çš„æœ€æ„› (æ„›å¿ƒæ”¶è—æŒ‰éˆ•) */
        .fav-fab-container {
            position: absolute;
            bottom: -15px; /* ç¨å¾®çªå‡ºç›’å­ä¸€é»é»ï¼Œæ›´æœ‰å±¤æ¬¡ */
            right: 15px;
            z-index: 10;
        }
        .fav-fab {
            width: 70px;
            height: 70px;
            background-color: var(--accent-warm);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 15px rgba(214, 125, 104, 0.4);
            cursor: pointer;
            transition: transform 0.2s;
            border: 3px solid white;
        }
        .fav-fab:active { transform: scale(0.9); }
        .fav-fab.active { background-color: #C06048; transform: scale(0.95); box-shadow: inset 0 3px 5px rgba(0,0,0,0.2); }
        
        .fav-icon { font-size: 1.4rem; line-height: 1; margin-bottom: 2px; }
        .fav-text { font-size: 0.75rem; color: white; font-weight: 900; line-height: 1; }

        /* --- ğŸ› ï¸ å·¥å…·ç®±åˆ—è¡¨ --- */
        .toolbox-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            width: 100%;
            max-width: 500px;
            padding-bottom: 40px;
        }

        .feature-card {
            background: var(--card-bg);
            border-radius: var(--radius-box);
            padding: 20px 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: var(--shadow-soft);
            cursor: pointer;
            transition: transform 0.2s;
            height: 145px;
            position: relative;
        }
        .feature-card:active { transform: scale(0.96); }
        
        .card-icon { font-size: 2.8rem; margin-bottom: 8px; }
        .card-title { 
            font-size: 1.1rem; 
            color: var(--text-main);
            font-weight: 700;
        }
        .card-tag { font-size: 0.8rem; color: #B0B0B0; margin-top: 5px; font-weight: 500;}

        /* å¡ç‰‡ä¸Šçš„å°æ„›å¿ƒ */
        .card-fav-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.2rem;
            color: #EEE;
            padding: 8px;
            z-index: 5;
            transition: color 0.3s;
        }
        .card-fav-btn.is-active { color: var(--accent-warm); }

        /* --- ğŸ“± åŠŸèƒ½ç•«é¢ (Modal) --- */
        #active-feature-container {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg);
            z-index: 1000;
            display: none; /* JS æ§åˆ¶ */
            flex-direction: column;
            padding: 24px;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 40px;
        }
        .close-btn {
            padding: 10px 20px;
            background: #EBEAE6;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-family: "Zen Maru Gothic", sans-serif;
            font-weight: 700;
            color: var(--text-main);
        }

    </style>
</head>
<body>

    <header>
        <h1>Safe Space</h1>
        <p class="subtitle">åœ¨é€™è£¡ï¼Œä½ ä¸éœ€è¦å‹‰å¼·è‡ªå·±ã€‚</p>
    </header>

    <div class="search-container">
        <input type="text" id="search-input" placeholder="ğŸ” æœå°‹ï¼šå¡”ç¾…ã€å‘¼å¸ã€è¿·æƒ˜...">
    </div>

    <section class="triage-section">
        <div class="triage-title">ç¾åœ¨çš„å¿ƒæƒ…åƒä»€éº¼å¤©æ°£ï¼Ÿ</div>
        
        <div class="mood-grid" id="mood-grid-container">
            </div>

        <div style="text-align:center; margin-top:15px; font-size:0.9rem; color:var(--text-sub); cursor:pointer; text-decoration:underline;" onclick="resetFilter()">
            é¡¯ç¤ºå…¨éƒ¨åŠŸèƒ½
        </div>

        <div class="fav-fab-container" onclick="filterFavorites()">
            <div class="fav-fab" id="fav-fab-btn">
                <div class="fav-icon">ğŸ¤</div> <div class="fav-text">æ”¶è—</div>
            </div>
        </div>
    </section>

    <section class="toolbox-grid" id="toolbox">
        </section>

    <div id="active-feature-container">
        <div class="modal-header">
            <button class="close-btn" onclick="history.back()">é—œé–‰ âœ•</button>
        </div>
        
        <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <h2 id="feature-title-display" style="text-align: center; font-size: 2rem; color: var(--primary); margin-bottom: 20px; font-weight:900;">åŠŸèƒ½åç¨±</h2>
            <div id="feature-content-area" style="text-align: center;">
                <p style="font-size: 1.1rem; color: var(--text-sub);">âœ¨ è¼•è¼•åœ°å¸æ°£ï¼Œæ…¢æ…¢åœ°åæ°£ âœ¨</p>
                <p style="font-size: 0.9rem; color: #CCC; margin-top:10px;">(åŠŸèƒ½å»ºç½®ä¸­)</p>
            </div>
        </div>
    </div>

    <script>
        // --- ğŸ§  1. è³‡æ–™åº« ---
        const featuresDB = [
            { id: 'dbt_cards', name: 'è‡ªæˆ‘ç…§é¡§å¡', icon: 'ğŸƒ', tag: 'DBTç­–ç•¥', moods: ['anxious', 'low', 'numb'], keywords: 'å¡ç‰‡,æŠ½å¡,ç­–ç•¥' },
            { id: 'quotes', name: 'ç™‚ç™’é‡‘å¥', icon: 'ğŸ“œ', tag: 'æ–‡å­—åŠ›é‡', moods: ['low', 'stress'], keywords: 'èªéŒ„,å¥å­,é¼“å‹µ' },
            { id: 'tarot', name: 'å¡”ç¾…æŒ‡å¼•', icon: 'ğŸ”®', tag: 'æ½›æ„è­˜', moods: ['anxious', 'confused'], keywords: 'å¡”ç¾…,å åœ' },
            { id: 'answer_book', name: 'è§£ç­”ä¹‹æ›¸', icon: 'ğŸ“–', tag: 'éˆæ„ŸæŒ‡å¼•', moods: ['confused', 'anxious'], keywords: 'è§£ç­”,å›°æƒ‘,è¿·æƒ˜' }, 
            { id: 'questions', name: 'å•å¥å¼•å°', icon: 'ğŸ’¡', tag: 'è‡ªæˆ‘å°è©±', moods: ['low', 'confused', 'numb'], keywords: 'æ•˜äº‹,sfbt,æ€è€ƒ' }, 
            { id: 'jokes', name: 'ç¬‘è©±æ€¥è½‰å½', icon: 'ğŸ¤£', tag: 'è½‰æ›å¿ƒæƒ…', moods: ['stress', 'low'], keywords: 'ç¬‘è©±,é–‹å¿ƒ' },
            { id: 'animals', name: 'æ¯›å­©ç™‚ç™’', icon: 'ğŸ±', tag: 'è¦–è¦ºå®‰æ’«', moods: ['stress', 'low', 'angry'], keywords: 'è²“,ç‹—,å¯æ„›' },
            { id: 'tasks', name: 'å¾®å°æˆå°±', icon: 'ğŸŒ±', tag: 'è¡Œå‹•', moods: ['numb', 'low'], keywords: 'ä»»å‹™,å‹•åŠ›' },
            { id: 'breathing', name: 'å‘¼å¸ç·´ç¿’', icon: 'ğŸŒ¬ï¸', tag: 'ç”Ÿç†èª¿ç¯€', moods: ['anxious', 'angry', 'panic'], keywords: 'å‘¼å¸,æ”¾é¬†,å†¥æƒ³' },
            { id: 'clicker', name: 'ç´“å£“æ³¡æ³¡', icon: 'ğŸ«§', tag: 'é‡‹æ”¾å£“åŠ›', moods: ['stress', 'angry'], keywords: 'æŒ‰éˆ•,æ³¡æ³¡ç´™' },
            { id: 'whiteboard', name: 'æƒ…ç·’å¡—é´‰', icon: 'ğŸ¨', tag: 'è¡¨é”', moods: ['angry', 'confused', 'numb'], keywords: 'ç•«ç•«,å¯«å­—,ç™½æ¿' },
            { id: 'conveyor', name: 'å¿µé ­è¼¸é€å¸¶', icon: 'ğŸŒŠ', tag: 'ACTè„«é‰¤', moods: ['anxious', 'stress'], keywords: 'å¿µé ­,æƒ³æ³•' },
            { id: 'worry_jar', name: 'ç…©æƒ±å¯„æ”¾', icon: 'ğŸº', tag: 'é‚Šç•Œè¨­å®š', moods: ['anxious', 'stress'], keywords: 'ç…©æƒ±,ç¡ä¸è‘—' },
            { id: 'sos', name: 'å®‰å…¨ç¶² SOS', icon: 'ğŸ†˜', tag: 'å±æ©Ÿæ±‚åŠ©', moods: ['panic', 'low'], keywords: 'æ±‚æ•‘,é›»è©±' }
        ];

        // é€™è£¡ç¢ºä¿åªæœ‰ 6 å€‹é¸é …ï¼Œç¬¦åˆ 3x2 ä½ˆå±€
        const moodOptions = [
            { id: 'anxious', label: 'ğŸ˜° ç„¦æ…®æ…Œå¼µ' },
            { id: 'low', label: 'ğŸ˜ ä½è½ç„¡åŠ›' },
            { id: 'angry', label: 'ğŸ˜¡ ç”Ÿæ°£æ†¤æ€’' },
            { id: 'numb', label: 'ğŸ˜¶ éº»æœ¨æ”¾ç©º' },
            { id: 'confused', label: 'ğŸ¤” è¿·æƒ˜å›°æƒ‘' },
            { id: 'panic', label: 'ğŸ†˜ å¿«å´©æ½°äº†' }
        ];

        let favorites = JSON.parse(localStorage.getItem('safeSpaceFavs')) || [];

        // --- ğŸ—ï¸ 2. å»ºæ§‹ä»‹é¢ ---
        const toolboxEl = document.getElementById('toolbox');
        const moodGrid = document.getElementById('mood-grid-container');
        const searchInput = document.getElementById('search-input');
        const favFabBtn = document.getElementById('fav-fab-btn');

        function initApp() {
            renderMoodButtons();
            renderFeatures(featuresDB);
        }

        // ç”¢ç”Ÿ 3x2 æƒ…ç·’æŒ‰éˆ•
        function renderMoodButtons() {
            moodGrid.innerHTML = '';
            moodOptions.forEach(mood => {
                const btn = document.createElement('button');
                btn.className = 'mood-btn';
                btn.innerText = mood.label;
                btn.dataset.mood = mood.id; // æ–¹ä¾¿è­˜åˆ¥
                btn.onclick = () => filterByMood(mood.id, btn);
                moodGrid.appendChild(btn);
            });
        }

        function renderFeatures(list) {
            toolboxEl.innerHTML = '';
            if (list.length === 0) {
                toolboxEl.innerHTML = `<div style="grid-column:span 2; text-align:center; padding:30px; color:#aaa; font-weight:700;">ğŸ‚<br>é€™è£¡ç©ºç©ºçš„</div>`;
                return;
            }
            list.forEach(feature => {
                const isFav = favorites.includes(feature.id);
                const card = document.createElement('div');
                card.className = 'feature-card';
                card.innerHTML = `
                    <div class="card-fav-btn ${isFav ? 'is-active' : ''}" onclick="toggleFavorite(event, '${feature.id}')">
                        ${isFav ? 'â¤ï¸' : 'ğŸ¤'}
                    </div>
                    <div class="card-icon">${feature.icon}</div>
                    <div class="card-title">${feature.name}</div>
                    <div class="card-tag">${feature.tag}</div>
                `;
                card.onclick = (e) => {
                    if(e.target.classList.contains('card-fav-btn')) return;
                    openFeature(feature);
                };
                toolboxEl.appendChild(card);
            });
        }

        // --- â¤ï¸ 3. æ”¶è—èˆ‡éæ¿¾ ---
        
        // åˆ‡æ›æ„›å¿ƒç‹€æ…‹
        function toggleFavorite(event, id) {
            event.stopPropagation();
            if (favorites.includes(id)) {
                favorites = favorites.filter(favId => favId !== id);
            } else {
                favorites.push(id);
            }
            localStorage.setItem('safeSpaceFavs', JSON.stringify(favorites));
            
            // å¦‚æœç›®å‰æ­£åœ¨çœ‹ã€Œæˆ‘çš„æœ€æ„›ã€ï¼Œéœ€è¦é‡ç¹ª
            if (favFabBtn.classList.contains('active')) {
                filterFavorites();
            } else {
                // åŸåœ°æ›´æ–°åœ–ç¤º
                const btn = event.currentTarget;
                const isNowFav = favorites.includes(id);
                btn.innerHTML = isNowFav ? 'â¤ï¸' : 'ğŸ¤';
                btn.classList.toggle('is-active');
            }
        }

        // æŒ‰ä¸‹å³ä¸‹è§’å¤§æ„›å¿ƒï¼šç¯©é¸æœ€æ„›
        function filterFavorites() {
            // æ¸…é™¤å…¶ä»–æƒ…ç·’æŒ‰éˆ•çš„ active
            document.querySelectorAll('.mood-btn').forEach(btn => btn.classList.remove('active'));
            searchInput.value = '';
            
            // å•Ÿç”¨è‡ªå·±
            favFabBtn.classList.add('active');
            
            const favList = featuresDB.filter(item => favorites.includes(item.id));
            renderFeatures(favList);
        }

        // æŒ‰ä¸‹æƒ…ç·’æŒ‰éˆ•
        function filterByMood(moodId, clickedBtn) {
            // æ¸…é™¤æœ€æ„›çš„ active
            favFabBtn.classList.remove('active');
            
            document.querySelectorAll('.mood-btn').forEach(btn => btn.classList.remove('active'));
            clickedBtn.classList.add('active');
            searchInput.value = '';

            const filtered = featuresDB.filter(item => item.moods.includes(moodId));
            renderFeatures(filtered);
        }

        function resetFilter() {
            favFabBtn.classList.remove('active');
            document.querySelectorAll('.mood-btn').forEach(btn => btn.classList.remove('active'));
            searchInput.value = '';
            renderFeatures(featuresDB);
        }
        
        // æœå°‹ç›£è½
        searchInput.addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase().trim();
            favFabBtn.classList.remove('active');
            document.querySelectorAll('.mood-btn').forEach(btn => btn.classList.remove('active'));

            if (keyword === '') { renderFeatures(featuresDB); return; }
            const filtered = featuresDB.filter(item => 
                item.name.includes(keyword) || item.keywords.includes(keyword) || item.tag.includes(keyword)
            );
            renderFeatures(filtered);
        });

        // --- ğŸ“± 4. åŠŸèƒ½é–‹é—œèˆ‡æ‰‹æ©Ÿè¿”å›éµå„ªåŒ– (History API) ---
        
        const modal = document.getElementById('active-feature-container');
        const title = document.getElementById('feature-title-display');

        function openFeature(feature) {
            // 1. é¡¯ç¤º Modal
            modal.style.display = 'flex';
            title.innerText = feature.name;
            
            // 2. æ¨é€ä¸€å€‹ç‹€æ…‹åˆ°æ­·å²ç´€éŒ„
            // é€™æ¨£æŒ‰æ‰‹æ©Ÿçš„ã€Œè¿”å›ã€ï¼Œå°±æœƒè§¸ç™¼ popstateï¼Œè€Œä¸æ˜¯é›¢é–‹ç¶²é 
            history.pushState({ modalOpen: true }, null, "#feature");
        }

        // ç›£è½æ­·å²ç´€éŒ„è®ŠåŒ– (æŒ‰äº†ä¸Šä¸€é )
        window.addEventListener('popstate', function(event) {
            // ç•¶ popstate ç™¼ç”Ÿæ™‚ï¼Œä»£è¡¨ä½¿ç”¨è€…æŒ‰äº†è¿”å›
            // æˆ‘å€‘ç›´æ¥æŠŠ modal é—œæ‰
            modal.style.display = 'none';
        });

        initApp();
    </script>
</body>
</html>