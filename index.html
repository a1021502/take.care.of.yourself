<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Safe Space</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Cinzel:wght@700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg viewBox='0 0 100 100' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M50 15C30 15 10 30 10 60C10 85 25 95 50 95C75 95 90 85 90 60C90 30 70 15 50 15Z' fill='%23FFFFFF' stroke='%23E0E0E0' stroke-width='3'/%3E%3Ccircle cx='35' cy='55' r='4' fill='%235C5552'/%3E%3Ccircle cx='65' cy='55' r='4' fill='%235C5552'/%3E%3Ccircle cx='28' cy='62' r='3' fill='%23FFD1DC' opacity='0.8'/%3E%3Ccircle cx='72' cy='62' r='3' fill='%23FFD1DC' opacity='0.8'/%3E%3C/svg%3E">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        /* --- ğŸ¨ æ ¸å¿ƒè¦–è¦ºè®Šæ•¸ (æ—¥å¤œåˆ‡æ›ç³»çµ±) --- */
        :root {
            /* æ—¥é–“æ¨¡å¼ (é è¨­) */
            --primary: #7A9F6E;       /* æŠ¹èŒ¶ç¶  */
            --primary-dark: #58754F;
            --primary-light: #EBF2EA;
            --bg: #FCFAF7;            /* ç±³ç™½ */
            --card-bg: #FFFFFF;
            --text-main: #5C5552;     /* æ·±æš–ç° */
            --text-sub: #9E9894;
            --accent-warm: #D67D68;
            --radius-box: 24px;
            --radius-btn: 16px;
            --shadow-soft: 0 8px 20px rgba(122, 159, 110, 0.15);
            --glass: rgba(255, 255, 255, 0.90);
            --border-color: rgba(0,0,0,0.05);
            --pet-glow: drop-shadow(0 4px 6px rgba(0,0,0,0.15)); /* éºµåœ˜é™°å½± */
        }

        /* ğŸŒ™ æ·±è‰²æ¨¡å¼ (æº«æš–çš„æ·±å¤œå¯å¯è‰²) */
        body.dark-mode {
            --primary: #9BC58B;       /* äº®ä¸€é»çš„ç¶ ï¼Œå°æ¯”æ‰å¤  */
            --primary-dark: #BCE0AF;
            --primary-light: #3D3A37; /* æ·±å¡å…¶èƒŒæ™¯ */
            --bg: #2C2927;            /* æ·±å’–å•¡é»‘ */
            --card-bg: #383533;       /* ç¨å¾®äº®ä¸€é»çš„ç°è¤ */
            --text-main: #EDE8E4;     /* æš–ç™½ */
            --text-sub: #ACA59F;      /* æš–ç° */
            --shadow-soft: 0 8px 20px rgba(0, 0, 0, 0.4);
            --glass: rgba(44, 41, 39, 0.90);
            --border-color: rgba(255,255,255,0.1);
            --pet-glow: drop-shadow(0 0 10px rgba(255, 255, 255, 0.2)); /* å¤œæ™šç™¼å…‰ */
        }

        body {
            font-family: "Zen Maru Gothic", sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 24px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            line-height: 1.6;
            -webkit-tap-highlight-color: transparent;
            /* é—œéµï¼šé è¨­éš±è—æ²è»¸ï¼Œç­‰ Splash çµæŸæ‰æ‰“é–‹ */
            overflow: hidden; 
            transition: background-color 0.5s, color 0.5s;
        }

        /* --- ğŸ¬ å•Ÿå‹•ç•«é¢ (å‹•æ…‹æ•˜äº‹ç‰ˆ) --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg); z-index: 9999;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            transition: opacity 0.8s ease-out;
            /* é˜²æ­¢æ‰‹æ©Ÿæ»‘å‹•çœ‹åˆ°å¾Œé¢ */
            touch-action: none; 
        }
        
        .splash-content { text-align: center; position: relative; }

        .splash-logo-container {
            width: 140px; height: 140px; margin: 0 auto 30px auto;
            position: relative;
            /* 1. éºµåœ˜æ…¢æ…¢é€²ä¾† (å¾ä¸Šæ–¹é™è½) */
            animation: doughEnter 2s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            opacity: 0; /* åˆå§‹éš±è— */
        }

        /* ç¦ªæ„éºµåœ˜ */
        .zen-dough {
            width: 100%; height: 100%;
            /* 2. é€²å ´å¾Œæ¥çºŒå‘¼å¸å‹•ç•« */
            animation: deepBreathe 6s ease-in-out infinite 2s; /* å»¶é²2ç§’ç­‰é€²å ´å®Œ */
            filter: var(--pet-glow);
        }

        .splash-title {
            font-size: 1.8rem; font-weight: 900; color: var(--primary);
            letter-spacing: 2px; margin-bottom: 5px;
            /* 3. æ¨™é¡Œæ…¢æ…¢å‡ºç¾ */
            opacity: 0;
            animation: fadeInUp 1.5s ease-out 1.5s forwards;
        }
        .splash-subtitle {
            font-size: 0.9rem; color: var(--text-sub); font-weight: 500;
            margin-bottom: 50px; opacity: 0;
            animation: fadeInUp 1.5s ease-out 1.8s forwards;
        }

        .start-btn {
            font-size: 1rem; color: white; font-weight: 700;
            padding: 14px 40px; 
            background: var(--primary);
            border: none;
            border-radius: 50px; cursor: pointer;
            box-shadow: 0 5px 15px rgba(122, 159, 110, 0.3);
            transition: all 0.3s;
            letter-spacing: 1px;
            opacity: 0;
            /* 4. æŒ‰éˆ•æ·¡å…¥ + æ–å‹•ä¸€ä¸‹ */
            animation: fadeInUp 1s ease-out 2.5s forwards, shakeBtn 0.5s ease-in-out 3s;
        }
        .start-btn:active { transform: scale(0.95); }

        /* å‹•ç•«å®šç¾© */
        @keyframes doughEnter {
            0% { transform: translateY(-50px) scale(0.8); opacity: 0; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }
        @keyframes deepBreathe {
            0%, 100% { transform: scale(1) translateY(0); }
            50% { transform: scale(1.05) translateY(-5px); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes shakeBtn {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }


        /* --- ğŸ  ä¸»ä»‹é¢ --- */
        /* æ¨™é¡Œé¡è‰²èˆ‡å•Ÿå‹•é åŒæ­¥ var(--primary) */
        header { text-align: center; margin-bottom: 24px; margin-top: 20px; width: 100%; max-width: 500px;}
        h1 { font-weight: 900; font-size: 2rem; margin: 0; color: var(--primary); letter-spacing: 1px; transition: color 0.5s; }
        p.subtitle { font-size: 0.95rem; color: var(--text-sub); margin-top: 5px; font-weight: 500; }

        /* --- ğŸ” æœå°‹æ¬„ --- */
        .search-container { width: 100%; max-width: 500px; margin-bottom: 24px; }
        #search-input {
            width: 100%; padding: 16px 24px; border-radius: 50px;
            border: 2px solid transparent; background: var(--card-bg);
            font-size: 1rem; font-family: "Zen Maru Gothic", sans-serif; font-weight: 700;
            color: var(--text-main); outline: none;
            box-shadow: var(--shadow-soft); box-sizing: border-box;
            transition: all 0.3s;
        }
        #search-input:focus { border-color: var(--primary); }
        #search-input::placeholder { color: var(--text-sub); font-weight: 500; opacity: 0.7; }

        /* --- ğŸš‘ æƒ…ç·’å¿«ç¯©å€ --- */
        .triage-section {
            width: 100%; max-width: 500px;
            background: var(--primary-light);
            padding: 24px; padding-bottom: 30px;
            border-radius: var(--radius-box);
            margin-bottom: 32px;
            position: relative;
            box-sizing: border-box;
            box-shadow: inset 0 0 0 2px rgba(255,255,255,0.1); /* å¾®èª¿æ·±è‰²æ¨¡å¼ä¸‹çš„é‚Šæ¡† */
            transition: background 0.5s;
        }
        .triage-title { 
            font-size: 1.1rem; margin-bottom: 16px; 
            color: var(--primary-dark); font-weight: 900; text-align: center; 
        }

        .mood-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr; 
            gap: 12px; margin-bottom: 10px;
        }
        
        .mood-card {
            background: var(--card-bg); border: 3px solid transparent; 
            color: var(--text-main);
            padding: 10px 5px; border-radius: var(--radius-btn);
            cursor: pointer; transition: all 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 4px 0 rgba(0,0,0,0.05);
            height: 110px;
        }
        .mood-card:active { transform: translateY(4px); box-shadow: none; }
        .mood-card.active {
            background: var(--card-bg);
            transform: translateY(2px);
            box-shadow: inset 0 3px 5px rgba(0,0,0,0.2);
        }
        
        .mood-icon-svg { width: 60px; height: 60px; margin-bottom: 5px; }
        .mood-label { font-size: 0.85rem; font-weight: 700; line-height: 1.2; text-align: center;}

        /* --- ğŸ› ï¸ å·¥å…·ç®±åˆ—è¡¨ --- */
        .toolbox-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
            width: 100%; max-width: 500px; padding-bottom: 100px;
        }
        .feature-card {
            background: var(--card-bg); border-radius: var(--radius-box);
            padding: 20px 10px; display: flex; flex-direction: column;
            align-items: center; justify-content: flex-start; text-align: center;
            box-shadow: var(--shadow-soft); cursor: pointer;
            transition: transform 0.2s; height: 160px; position: relative;
            overflow: hidden; 
        }
        .feature-card:active { transform: scale(0.96); }
        
        .card-visual { 
            width: 90px; height: 90px; 
            margin-bottom: 10px; 
            position: relative;
        }
        .feature-svg { width: 100%; height: 100%; filter: var(--pet-glow); }

        .card-title { font-size: 1.1rem; color: var(--text-main); font-weight: 700; margin-bottom: 2px;}
        .card-tag { font-size: 0.8rem; color: var(--text-sub); font-weight: 500; }
        
        .card-fav-btn {
            position: absolute; top: 10px; right: 10px;
            font-size: 1.2rem; color: #EEE; padding: 8px;
            z-index: 5; transition: color 0.3s;
        }
        /* æ·±è‰²æ¨¡å¼ä¸‹æ„›å¿ƒåº•è‰²èª¿æ•´ */
        body.dark-mode .card-fav-btn { color: #555; }
        .card-fav-btn.is-active { color: var(--accent-warm) !important; }

        .fav-fab-container { position: absolute; bottom: -15px; right: 15px; z-index: 10; }
        .fav-fab {
            width: 70px; height: 70px;
            background-color: var(--card-bg); color: var(--accent-warm);
            border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 6px 15px rgba(122, 159, 110, 0.2);
            cursor: pointer; transition: all 0.2s;
            border: 3px solid var(--card-bg);
        }
        .fav-fab:active { transform: scale(0.9); }
        .fav-fab.active { background-color: var(--accent-warm); color: white; transform: scale(0.95); }
        .fav-icon { font-size: 1.4rem; line-height: 1; margin-bottom: 2px; }
        .fav-text { font-size: 0.75rem; font-weight: 900; line-height: 1; }

        /* --- ğŸ“± Modal --- */
        #active-feature-container {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg); z-index: 1000;
            display: none; flex-direction: column; padding: 24px;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header { display: flex; justify-content: flex-end; margin-bottom: 40px; }
        .close-btn {
            padding: 10px 20px; background: var(--primary-light); border-radius: 20px;
            border: none; cursor: pointer; font-family: "Zen Maru Gothic", sans-serif;
            font-weight: 700; color: var(--text-main);
        }

        /* --- âš™ï¸ è¨­å®šé½’è¼ª (æ›´æ˜é¡¯ç²¾ç·») --- */
        .settings-fab {
            position: fixed; bottom: 30px; left: 20px; z-index: 2000;
            width: 60px; height: 60px; /* åŠ å¤§ */
            background: var(--card-bg); 
            backdrop-filter: blur(10px);
            border-radius: 50%;
            /* åŠ å¼·é™°å½±èˆ‡é‚Šæ¡†å…‰æ¾¤ */
            box-shadow: 0 8px 25px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.5);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s;
        }
        .settings-fab:hover { transform: scale(1.05); }
        .settings-fab:active { transform: rotate(90deg) scale(0.95); }
        .gear-icon { width: 32px; height: 32px; fill: var(--text-main); }

        /* --- âš™ï¸ è¨­å®š Modal (æº«æš–ç£¨ç ‚è³ªæ„Ÿ) --- */
        #settings-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 3000;
            display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        #settings-modal.show { opacity: 1; }
        .settings-content {
            background: var(--glass);
            width: 85%; max-width: 360px;
            border-radius: var(--radius-box);
            padding: 24px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
            backdrop-filter: blur(25px);
            border: 1px solid var(--border-color);
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-height: 80vh; overflow-y: auto;
        }
        #settings-modal.show .settings-content { transform: scale(1); }
        
        .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; }
        .settings-title { font-size: 1.3rem; font-weight: 900; color: var(--text-main); }
        
        .setting-section-title {
            font-size: 0.85rem; font-weight: 900; color: var(--primary);
            margin-top: 15px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;
        }

        .setting-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; border-bottom: 1px solid var(--border-color);
        }
        .setting-item:last-child { border-bottom: none; }
        
        .st-label { font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 10px; font-size: 0.95rem; }
        .st-icon { font-size: 1.2rem; width: 25px; text-align: center; }
        
        .setting-input {
            border: 2px solid var(--border-color); background: rgba(255,255,255,0.1);
            padding: 8px 12px; border-radius: 12px;
            font-family: inherit; font-weight: 700; color: var(--text-main);
            width: 120px; text-align: right; outline: none; transition: border 0.3s;
        }
        .setting-input:focus { border-color: var(--primary); background: var(--card-bg); }

        .toggle-switch {
            width: 46px; height: 26px; background: #DDD;
            border-radius: 20px; position: relative; cursor: pointer; transition: background 0.3s;
        }
        /* æ·±è‰²æ¨¡å¼ä¸‹çš„ Toggle èƒŒæ™¯è®Šæ·±ä¸€é» */
        body.dark-mode .toggle-switch { background: #555; }
        
        .toggle-switch::after {
            content: ''; position: absolute; top: 3px; left: 3px;
            width: 20px; height: 20px; background: white;
            border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: left 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .toggle-switch.active { background: var(--primary); }
        .toggle-switch.active::after { left: 23px; }

        .btn-action {
            width: 100%; padding: 12px; background: var(--card-bg);
            border: 1px solid var(--border-color); border-radius: 12px;
            font-weight: 700; color: var(--text-main); margin-top: 5px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: background 0.2s;
        }
        .btn-action:active { filter: brightness(0.95); }
        .danger-btn { color: #FF6B6B; border-color: #FF6B6B; margin-top: 10px; background: transparent; }


        /* --- â˜ï¸ éºµåœ˜ç²¾éˆæœ¬é«” --- */
        #spirit-pet {
            position: fixed; width: 80px; height: 80px; z-index: 2001;
            cursor: grab; touch-action: none; display: none;
            -webkit-tap-highlight-color: transparent;
        }
        #spirit-pet:active { cursor: grabbing; }
        #spirit-pet.auto-moving { transition: top 3s ease-in-out, left 3s ease-in-out; }
        .pet-svg-body {
            width: 100%; height: 100%;
            filter: var(--pet-glow); /* æ”¯æ´å¤œé–“ç™¼å…‰ */
            animation: petFloat 4s ease-in-out infinite;
        }
        @keyframes petFloat {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-6px) scale(1.03); }
        }
        .pet-shake { animation: shake 0.4s ease-in-out; }
        @keyframes shake {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            50% { transform: rotate(10deg); }
            75% { transform: rotate(-5deg); }
            100% { transform: rotate(0deg); }
        }
        .pet-speech-bubble {
            position: absolute; top: -60px; left: 50%;
            transform: translateX(-50%) scale(0);
            background: var(--card-bg); padding: 10px 16px; border-radius: 18px;
            font-size: 0.9rem; color: var(--text-main); font-weight: 700;
            white-space: nowrap; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            opacity: 0; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none; border: 2px solid var(--primary-light); z-index: 2002;
        }
        .pet-speech-bubble::after {
            content: ''; position: absolute; bottom: -8px; left: 50%;
            transform: translateX(-50%); border-width: 8px 8px 0; border-style: solid;
            border-color: var(--card-bg) transparent transparent transparent;
        }
        .pet-speech-bubble.show { transform: translateX(-50%) scale(1); opacity: 1; top: -75px; }
        /* é¡æ–‡å­—å°ˆç”¨å­—é«” (å¼·åˆ¶ Arial) */
        .kaomoji { font-family: "Arial", sans-serif; font-weight: normal; display: inline-block; }

        /* --- SVG å‹•ç•«é—œéµå½±æ ¼ --- */
        @keyframes blink { 0%, 90%, 100% { transform: scaleY(1); } 95% { transform: scaleY(0.1); } }
        @keyframes sway { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        @keyframes breathe { 0%, 100% { transform: scale(0.95); } 50% { transform: scale(1.05); } }
        @keyframes floatItem { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes spinEye { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes tearDrop { 0% { opacity: 0; transform: translateY(0); } 50% { opacity: 1; } 100% { opacity: 0; transform: translateY(10px); } }
        @keyframes panicWave { 0%, 100% { transform: rotate(-20deg); } 50% { transform: rotate(20deg); } }
        @keyframes muscleFlex { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        @keyframes lidOpen { 0%, 100% { transform: rotate(0); } 50% { transform: rotate(-20deg) translateY(-5px); } }
        @keyframes conveyorMove { 0% { transform: translateX(0); opacity: 1; } 100% { transform: translateX(40px); opacity: 0; } }
/* --- â˜ï¸ éºµåœ˜ç²¾éˆ DBT æš–éŠ€ç™‚ç™’ç‰ˆ CSS --- */

:root {
    --dbt-bg: transparent;
    --dbt-text: #5C5552; /* æš–æ·±ç° */
    --dbt-card-bg: #fff;
    --dbt-shadow: rgba(92, 85, 82, 0.15);
    
    /* ç™‚ç™’ç³»é‹ç®”ï¼šå¸¶ä¸€é»é»æš–è‰²èª¿çš„éŠ€ */
    --foil-light: #f7f7f7;
    --foil-mid: #e8e6e3;
    --foil-dark: #d1cfcc;
    --foil-shine: rgba(255, 255, 255, 0.8);
    --tear-line: rgba(0,0,0,0.1);
}

body.dark-mode {
    --dbt-text: #e0e0e0;
    --dbt-card-bg: #2d2d2d;
    --dbt-shadow: rgba(0,0,0,0.6);
    
    /* æš—é»‘æ¨¡å¼é‹ç®”ï¼šæ·±é‚ƒé‡‘å±¬ */
    --foil-light: #4a4a4a;
    --foil-mid: #333333;
    --foil-dark: #222222;
    --foil-shine: rgba(255, 255, 255, 0.15);
    --tear-line: rgba(255,255,255,0.1);
}

/* 1. å®¹å™¨èˆ‡åŸºç¤ */
.dbt-wrapper {
    width: 100%; height: 100%;
    display: flex; flex-direction: column;
    position: relative;
    color: var(--dbt-text);
    overscroll-behavior: none;
    font-family: inherit;
}

.dbt-stage {
    flex: 1; width: 100%;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    animation: dbtFadeIn 0.5s ease-out;
    position: relative;
    z-index: 2;
    overflow: visible !important; /* é˜²æ­¢ 3D è¢«åˆ‡ */
    padding: 20px 0;
}
@keyframes dbtFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* --- éšæ®µ 1: éºµåœ˜é¸æ“‡ --- */
.dough-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 25px;
    width: 100%; max-width: 340px; margin-top: 10px;
}
.dough-btn {
    display: flex; flex-direction: column; align-items: center;
    cursor: pointer; transition: transform 0.2s;
    -webkit-tap-highlight-color: transparent;
    padding: 10px; border-radius: 16px;
}
.dough-btn:active { transform: scale(0.95); background: rgba(0,0,0,0.03); }
.dough-svg {
    width: 90px; height: 90px; transition: 0.3s;
    filter: drop-shadow(0 6px 10px var(--dbt-shadow));
}
.dough-label {
    margin-top: 12px; font-size: 1rem; font-weight: bold; letter-spacing: 1px; opacity: 0.9;
    color: var(--dbt-text);
}

/* --- éšæ®µ 2: 3D è½‰ç›¤ (æš–éŠ€è³ªæ„Ÿ) --- */
.carousel-container {
    width: 100%; height: 360px;
    perspective: 1100px;
    display: flex; align-items: center; justify-content: center;
    overflow: visible; padding: 30px 0;
}
.pack-carousel {
    position: relative; width: 220px; height: 320px;
    transform-style: preserve-3d;
    transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
    cursor: grab;
}
.pack-carousel:active { cursor: grabbing; }

/* å¡åŒ…æœ¬é«” (æš–éŠ€æ¼¸å±¤) */
.pack-3d-item {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-color: var(--foil-mid);
    border-radius: 10px;
    /* ç™‚ç™’æš–éŠ€æ¼¸å±¤ */
    background: linear-gradient(135deg, var(--foil-light) 0%, var(--foil-mid) 50%, var(--foil-dark) 100%);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    /* æŸ”å’Œçš„ç«‹é«”é™°å½± */
    box-shadow: 
        inset 0 0 30px rgba(0,0,0,0.02),
        inset 1px 1px 2px var(--foil-shine),
        0 10px 25px var(--dbt-shadow);
    backface-visibility: hidden;
    border: 1px solid rgba(255,255,255,0.2);
}

/* å´é¢åšåº¦ */
.pack-3d-item::before {
    content: ''; position: absolute; left: -8px; top: 2px;
    width: 8px; height: 98%;
    background: linear-gradient(to bottom, var(--foil-dark), var(--foil-mid), var(--foil-dark));
    transform: rotateY(-90deg); transform-origin: right;
    border-radius: 2px 0 0 2px;
}

/* ä¸Šä¸‹å£“ç—• (ç´°ç·»åŒ–) */
.pack-crimp-top, .pack-crimp-bottom {
    position: absolute; left: 0; width: 100%; height: 16px;
    background-image: repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0,0,0,0.05) 3px, transparent 4px);
    z-index: 5; opacity: 0.6;
}
.pack-crimp-top { top: 0; border-bottom: 1px solid rgba(0,0,0,0.1); border-radius: 10px 10px 2px 2px; }
.pack-crimp-bottom { bottom: 0; border-top: 1px solid rgba(0,0,0,0.1); border-radius: 2px 2px 10px 10px; }

/* è²¼ç´™ */
.pack-sticker {
    background: var(--dbt-card-bg);
    width: 70%; padding: 20px 10px; border-radius: 6px;
    display: flex; flex-direction: column; align-items: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transform: translateZ(2px);
}

/* --- éšæ®µ 3: æ’•å¡åŒ… (é ‚éƒ¨æ’•é–‹ + åŒæè³ª) --- */
.rip-container {
    position: relative; width: 240px; height: 340px; margin-top: 15px;
}
.rip-pack-main {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    /* èˆ‡è½‰ç›¤å¡åŒ…ä¸€è‡´çš„æè³ª */
    background: linear-gradient(135deg, var(--foil-light) 0%, var(--foil-mid) 50%, var(--foil-dark) 100%);
    border-radius: 10px; z-index: 2;
    box-shadow: 0 10px 30px var(--dbt-shadow);
    overflow: hidden;
    transition: transform 0.3s, opacity 0.3s;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    border: 1px solid rgba(255,255,255,0.2);
}
/* é›œè¨Šç´‹ç† */
.rip-pack-main::after {
    content:''; position:absolute; top:0; left:0; width:100%; height:100%;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.05'/%3E%3C/svg%3E");
    opacity: 0.5; pointer-events: none;
}

/* é ‚éƒ¨æ’•æ¢ (Top Strip) - æ”¹å¾—å¥½çœ‹ä¸€é» */
.rip-strip-top {
    position: absolute; top: 0; left: 0; width: 100%; height: 50px;
    /* å»¶çºŒå¡åŒ…æè³ªï¼Œä½†ç¨å¾®äº®ä¸€é» */
    background: linear-gradient(to bottom, var(--foil-light), var(--foil-mid));
    z-index: 10; cursor: grab;
    display: flex; align-items: center; padding-left: 15px;
    border-bottom: 1px dashed var(--tear-line); /* è™›ç·šç¸« */
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    border-radius: 10px 10px 0 0;
}
.rip-strip-top:active { cursor: grabbing; filter: brightness(0.98); }

.rip-arrow {
    font-size: 0.8rem; letter-spacing: 2px; color: var(--dbt-text); opacity: 0.5;
    display: flex; align-items: center; gap: 5px;
}

/* æ’•è£‚å¾Œçš„ç—•è·¡ (Jagged Edge) */
.rip-trace-top {
    position: absolute; top: 50px; left: 0; width: 0%; height: 12px;
    background: rgba(0,0,0,0.1); /* é™°å½±è‰² */
    z-index: 5; pointer-events: none; opacity: 0;
    /* é‹¸é½’é‚Šç·£ */
    clip-path: polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%, 
        5% 80%, 10% 100%, 15% 80%, 20% 100%, 25% 80%, 30% 100%, 35% 80%, 40% 100%,
        45% 80%, 50% 100%, 55% 80%, 60% 100%, 65% 80%, 70% 100%, 75% 80%, 80% 100%,
        85% 80%, 90% 100%, 95% 80%);
}

/* --- éšæ®µ 4: æŠ½å¡èˆ‡å…‰æ¾¤ (é™åˆ¶ç¯„åœ) --- */
.real-card-stack { 
    width: 260px; height: 400px; position: relative; perspective: 1000px; 
    z-index: 10; margin-top: -10px;
}
.real-card-item {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    border-radius: 16px;
    transition: transform 0.6s cubic-bezier(0.23, 1, 0.32, 1);
    transform-style: preserve-3d;
    box-shadow: 0 8px 20px var(--dbt-shadow);
}

/* é—œéµä¿®æ­£ï¼šoverflow hidden ç¢ºä¿å…‰æ¾¤ä¸å¤–æº¢ */
.real-card-face {
    position: absolute; width: 100%; height: 100%;
    backface-visibility: hidden;
    border-radius: 16px;
    background-color: var(--dbt-card-bg);
    overflow: hidden; /* â˜… é–ä½å…‰æ¾¤ â˜… */
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 24px; box-sizing: border-box;
    /* ç´™å¼µè³ªæ„Ÿ */
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='1.2' numOctaves='3'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    border: 1px solid rgba(0,0,0,0.05);
}

/* éŠ€ç™½å…‰æ¾¤ (åœ¨å¡ç‰‡å…§éƒ¨) */
.shine-inner::after {
    content: "";
    position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
    background: linear-gradient(
        to bottom right, 
        transparent 35%, 
        rgba(255, 255, 255, 0) 40%, 
        var(--foil-shine) 48%, /* äº®å…‰ */
        var(--foil-shine) 52%, 
        transparent 60%
    );
    transform: rotate(30deg) translateY(-100%);
    animation: shineMove 1.2s ease-out forwards;
    pointer-events: none; z-index: 20;
    mix-blend-mode: overlay;
}
@keyframes shineMove {
    0% { transform: rotate(30deg) translateY(-100%); }
    100% { transform: rotate(30deg) translateY(100%); }
}

.real-card-back {
    background-color: var(--card-theme-bg); 
    border: 10px solid var(--dbt-card-bg);
    box-shadow: inset 0 0 15px rgba(0,0,0,0.05);
}

.real-card-front { transform: rotateY(180deg); }
.flipped { transform: rotateY(180deg); }
.discarded { transform: translateX(250%) rotate(20deg); opacity: 0; }

/* --- éšæ®µ 5: ç¸½è¦½èˆ‡å…¨è¢å¹•æ”¾å¤§ (Lightbox) --- */
.summary-grid {
    display: flex; justify-content: flex-start; gap: 15px;
    width: 100%; overflow-x: auto; 
    padding: 20px 50vw 40px 20px; /* é˜²åˆ‡é‚Š Padding */
    scroll-snap-type: x mandatory;
    box-sizing: border-box;
    -webkit-overflow-scrolling: touch;
}
.summary-grid::after { content: ''; display: block; width: 20px; flex-shrink: 0; }

.mini-card {
    flex: 0 0 140px; height: 210px;
    background: var(--dbt-card-bg); border-radius: 12px;
    box-shadow: 0 4px 10px var(--dbt-shadow);
    padding: 15px;
    display: flex; flex-direction: column; align-items: center; text-align: center;
    border-top: 5px solid #ccc;
    scroll-snap-align: center;
    cursor: zoom-in;
    color: var(--dbt-text);
    position: relative;
    border: 1px solid rgba(0,0,0,0.05);
}

/* Lightbox Modal */
.card-lightbox {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.92); /* èƒŒæ™¯å…¨æš— */
    z-index: 3000;
    display: flex; align-items: center; justify-content: center;
    animation: fadeIn 0.3s;
    backdrop-filter: blur(5px);
    padding: 20px; box-sizing: border-box;
}
.lightbox-content {
    width: 100%; max-width: 340px; 
    background: transparent;
    animation: zoomUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.lightbox-card-face {
    width: 100%; height: auto; min-height: 480px;
    background: var(--dbt-card-bg); border-radius: 18px;
    padding: 30px; 
    display: flex; flex-direction: column; align-items: center;
    box-sizing: border-box;
    overflow-y: auto; max-height: 80vh;
    box-shadow: 0 0 50px rgba(255,255,255,0.1);
}
@keyframes zoomUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

.dbt-btn {
    border: 1px solid var(--dbt-text); background: transparent;
    padding: 10px 30px; border-radius: 30px;
    color: var(--dbt-text); font-family: inherit; font-size: 1rem;
    cursor: pointer; margin-top: 20px; margin-bottom: 20px;
}
.dbt-btn:active { background: rgba(128,128,128,0.2); }
/* --- è§£ç­”ä¹‹æ›¸å°ˆç”¨æ¨£å¼ (Namespace: .ab-) --- */
/* --- è§£ç­”ä¹‹æ›¸ : çš‡å®¶å…¸è— Â· ç¥ç´šå®Œå…¨é«” --- */

/* 1. èˆå°è¨­å®š (ğŸ”¥ ä¿®æ­£ï¼šæ•´é«”ä¸Šç§») */
.ab-container {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    /* æ”¹ç”¨ flex-start é…åˆä¸Šé‚Šè·ä¾†æ§åˆ¶å‚ç›´ä½ç½®ï¼Œæˆ–è€…ç”¨ padding-bottom æŠŠä¸­å¿ƒé»é ‚ä¸Šå» */
    justify-content: center; 
    width: 100%;
    min-height: 600px;
    /* ğŸ”¥ é—œéµï¼šå¢åŠ åº•éƒ¨ç•™ç™½ï¼ŒæŠŠè¦–è¦ºä¸­å¿ƒå¾€ä¸Šæ¨ */
    padding-bottom: 25vh; 
    perspective: 2500px;
    overflow: visible;
    touch-action: none;
}

/* 2. æ›¸æœ¬å®¹å™¨ */
.ab-book {
    position: relative;
    width: 280px; height: 400px; 
    transform-style: preserve-3d;
    /* è¦–å·®è®Šæ•¸ */
    transform: rotateY(calc(-30deg + var(--rY, 0deg))) rotateX(calc(10deg + var(--rX, 0deg)));
    transition: transform 0.1s ease-out; 
    cursor: pointer;
    z-index: 10;
}

/* æ‡¸æµ®å‹•ç•« */
.ab-book { animation: floatBook 6s ease-in-out infinite; }
@keyframes floatBook {
    0%, 100% { top: 0px; }
    50% { top: -20px; }
}

/* æ‰“é–‹ç‹€æ…‹ */
.ab-book.is-open {
    transform: rotateY(-5deg) rotateX(0deg) translateX(60px) !important;
    transition: transform 1.2s cubic-bezier(0.2, 0.8, 0.2, 1);
}

/* 3. æ›¸è„Š (Spine) */
.ab-spine {
    position: absolute; top: 0; bottom: 0; 
    left: -40px; width: 40px;
    background-color: #16213e;
    transform-origin: right; 
    transform: rotateY(-90deg);
    display: flex; align-items: center; justify-content: center;
    z-index: 5;
    border: 1px solid rgba(0,0,0,0.2);
    box-shadow: inset 10px 0 20px rgba(0,0,0,0.6);
}
.ab-spine-text {
    writing-mode: vertical-rl; transform: rotate(180deg);
    color: #c9a227; font-family: 'Cinzel', serif; font-size: 1rem;
    letter-spacing: 4px; opacity: 0.8;
}

/* 4. å°é¢ç¾¤çµ„ */
.ab-cover-group {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    transform-origin: left; transform-style: preserve-3d;
    transition: transform 1.8s cubic-bezier(0.645, 0.045, 0.355, 1);
    z-index: 50;
}
.ab-book.is-open .ab-cover-group { transform: rotateY(-165deg); }

/* 4.1 å°é¢æ­£é¢ (ç²—æ› ç´‹è·¯) */
.ab-cover-front {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-color: #151b29;
    background-image: 
        repeating-linear-gradient(45deg, rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 2px, transparent 2px, transparent 10px),
        repeating-linear-gradient(-45deg, rgba(255,255,255,0.02) 0px, rgba(255,255,255,0.02) 2px, transparent 2px, transparent 15px),
        radial-gradient(circle at 50% 50%, rgba(201, 162, 39, 0.1) 1px, transparent 1px);
    background-size: auto, auto, 24px 24px;
    backface-visibility: hidden; border-radius: 0 8px 8px 0;
    border: 2px solid #0b101a;
    box-shadow: inset 0 0 0 4px #c9a227;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    color: #c9a227; overflow: hidden; 
}

/* å…‰ç…§å±¤ */
.ab-shine {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background: radial-gradient(circle at var(--light-x, 50%) var(--light-y, 50%), rgba(255,255,255,0.3) 0%, transparent 50%);
    mix-blend-mode: overlay; pointer-events: none; z-index: 10;
}

/* 4.2 å°é¢å…§é¢ */
.ab-cover-back {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-color: #1a1a2e; 
    transform: rotateY(180deg); backface-visibility: hidden;
    border-radius: 8px 0 0 8px;
    box-shadow: inset 0 0 0 3px #c9a227;
    display: flex; align-items: center; justify-content: center;
}
.ab-cover-back::after {
    content: ''; width: 88%; height: 92%;
    background-color: #fdfbf7; border-radius: 2px;
    background-image: linear-gradient(to right, rgba(0,0,0,0.05) 1px, transparent 1px);
    background-size: 4px 4px;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.1), 0 0 0 1px rgba(0,0,0,0.1);
}

/* 5. å¯¦é«”å°åº• (Exterior Back) */
.ab-cover-exterior-back {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-color: #151b29;
    transform: translateZ(-40px) rotateY(180deg); 
    border-radius: 8px 0 0 8px;
    border: 2px solid #0b101a;
    background-image: 
        repeating-linear-gradient(45deg, rgba(255,255,255,0.03) 0px, rgba(255,255,255,0.03) 2px, transparent 2px, transparent 10px),
        repeating-linear-gradient(-45deg, rgba(255,255,255,0.02) 0px, rgba(255,255,255,0.02) 2px, transparent 2px, transparent 15px);
    box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
    z-index: 0;
}

/* 6. å…§é ä¸»é«” (ç½®ä¸­) */
.ab-pages {
    position: absolute; top: 8px; bottom: 8px; left: 4px; right: 12px;
    background-color: #fdfbf7; z-index: 1; transform-style: preserve-3d;
    transform: translateZ(-20px); 
    box-shadow: 
        inset 20px 0 30px rgba(0,0,0,0.15),
        1px 1px 0 #dcdcdc, 2px 2px 0 #dcdcdc, 3px 3px 0 #dcdcdc, 4px 4px 0 #dcdcdc, 5px 5px 0 #dcdcdc,
        6px 6px 0 #dcdcdc, 7px 7px 0 #dcdcdc, 8px 8px 0 #dcdcdc, 9px 9px 0 #dcdcdc, 10px 10px 0 #dcdcdc,
        15px 15px 0 #dcdcdc, 30px 30px 50px rgba(0,0,0,0.6);
    display: flex; align-items: center; justify-content: center;
    text-align: center; padding: 20px; overflow: hidden;
}

/* å¯¦é«”å°å£ */
.ab-pages-bottom {
    position: absolute; bottom: -18px; left: 0; width: 100%; height: 18px;
    background-color: #e6e6e6; transform-origin: top; transform: rotateX(-90deg);
    background-image: repeating-linear-gradient(to bottom, #e0e0e0 0px, #e0e0e0 1px, #f0f0f0 1px, #f0f0f0 2px);
    box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
}
.ab-pages-top {
    position: absolute; top: -18px; left: 0; width: 100%; height: 18px;
    background-color: #e6e6e6; transform-origin: bottom; transform: rotateX(90deg);
    background-image: repeating-linear-gradient(to bottom, #e0e0e0 0px, #e0e0e0 1px, #f0f0f0 1px, #f0f0f0 2px);
}
.ab-pages::before {
    content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 40px;
    background: linear-gradient(to right, rgba(0,0,0,0.2), transparent); pointer-events: none;
}

/* 7. SVG åœ–æ¨™ */
.ab-star-icon {
    position: relative; width: 120px; height: 120px; margin-bottom: 25px;
    display: flex; align-items: center; justify-content: center;
    filter: drop-shadow(0 0 5px rgba(201, 162, 39, 0.5));
    animation: breatheIcon 5s ease-in-out infinite; z-index: 5;
}
@keyframes breatheIcon {
    0%, 100% { transform: scale(1); opacity: 0.95; filter: drop-shadow(0 0 5px rgba(201, 162, 39, 0.5)); }
    50% { transform: scale(1.03); opacity: 1; filter: drop-shadow(0 0 15px rgba(201, 162, 39, 0.8)); }
}

/* 8. æ–‡å­—èˆ‡å‹•ç•« (ğŸ”¥ ä¿®å¾©ï¼šç·©æ…¢å¢¨æ°´æµ®ç¾ + å‘¼å¸) */
.ab-content-box { 
    opacity: 0; 
    transform: translateZ(0); 
}

/* æµ®ç¾å‹•ç•« (Reveal) */
.ab-text-reveal {
    /* 0.4s å»¶é²ï¼Œç­‰æ›¸æ‰“é–‹ä¸€é»å†é–‹å§‹æµ®ç¾ */
    animation: inkReveal 2.5s cubic-bezier(0.2, 1, 0.3, 1) 0.4s forwards, 
               textBreathe 4s ease-in-out infinite 2.9s; /* å‘¼å¸æ¥åœ¨æµ®ç¾ä¹‹å¾Œ */
}

@keyframes inkReveal {
    0% { opacity: 0; transform: scale(0.92); filter: blur(12px); }
    30% { opacity: 0.6; filter: blur(4px); }
    100% { opacity: 1; transform: scale(1); filter: blur(0px); }
}

@keyframes textBreathe {
    0%, 100% { opacity: 1; text-shadow: 0 0 0 rgba(0,0,0,0); }
    50% { opacity: 0.85; text-shadow: 0 0 12px rgba(201, 162, 39, 0.3); }
}

.ab-answer-text { font-family: 'Noto Serif TC', serif; font-size: 1.5rem; font-weight: 700; color: #333; line-height: 1.6; }
.ab-en { display: block; font-family: 'Cinzel', serif; font-size: 0.8rem; color: #8b7d6b; margin-top: 15px; font-weight: 400; text-transform: uppercase; }

.ab-cover-title-en { 
    font-family: 'Cinzel', serif; font-size: 1.6rem; font-weight: 700; 
    letter-spacing: 3px; margin-bottom: 8px; 
    text-shadow: 0 2px 5px rgba(0,0,0,0.8);
    background: linear-gradient(to bottom, #f0dfa8, #c9a227);
/* æ¨™æº–å±¬æ€§å…ˆå¯«ï¼Œæˆ–è€…è£œä¸Šæ¨™æº–å±¬æ€§ */
background-clip: text;             /* æ¨™æº–å¯«æ³• (é›–ç„¶ç›®å‰ç€è¦½å™¨æ”¯æ´åº¦é‚„éœ€é  -webkit) */
-webkit-background-clip: text;     /* é‡å° Chrome, Safari, Edge */
color: transparent;                /* é€™æ˜¯ text-fill-color çš„æ¨™æº–å›é€€æ–¹æ¡ˆ */
-webkit-text-fill-color: transparent;
z-index: 5;}
.ab-cover-title-zh { font-family: 'Noto Serif TC', serif; font-size: 0.9rem; letter-spacing: 3px; opacity: 0.8; z-index: 5; }
.ab-hint { margin-top: 50px; font-size: 0.9rem; color: #888; opacity: 0.6; letter-spacing: 1px; }

/* ğŸŒ™ Dark Mode */
.dark-mode .ab-book { box-shadow: 0 0 30px rgba(20, 30, 50, 0.8), 0 0 10px rgba(201, 162, 39, 0.2); }
.dark-mode .ab-pages { background-color: #2b2b2b; box-shadow: inset 15px 0 20px rgba(0,0,0,0.3), 1px 1px 0 #3d3d3d, 2px 2px 0 #3d3d3d, 3px 3px 0 #3d3d3d, 4px 4px 0 #3d3d3d, 5px 5px 0 #3d3d3d, 6px 6px 0 #3d3d3d, 25px 25px 50px rgba(0,0,0,0.9); }
.dark-mode .ab-answer-text { color: #e0e0e0; }
.dark-mode .ab-en { color: #aaa; }
.dark-mode .ab-cover-back::after { background-color: #2b2b2b; box-shadow: inset 0 0 20px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.05); }
.dark-mode .ab-pages-bottom, .dark-mode .ab-pages-top { background-color: #3d3d3d; background-image: repeating-linear-gradient(to bottom, #3d3d3d 0px, #3d3d3d 1px, #444 1px, #444 2px); }
  /* === ä¿®å¾©æ»¿ç‰ˆè¦–çª—çš„æ»‘å‹•å•é¡Œ === */

/* 1. ç¢ºä¿å…§å®¹å€åŸŸæœ‰é«˜åº¦é™åˆ¶ï¼Œä¸¦ä¸”å…è¨±æº¢å‡ºæ²å‹• */
#feature-content-area {
    /* é—œéµï¼šè¨­å®šæœ€å¤§é«˜åº¦ï¼Œæ‰£é™¤æ‰é ‚éƒ¨æ¨™é¡Œçš„é«˜åº¦ */
    max-height: calc(100vh - 120px); 
    overflow-y: auto !important; /* å¼·åˆ¶é–‹å•Ÿå‚ç›´æ²è»¸ */
    -webkit-overflow-scrolling: touch; /* è®“ iPhone æ»‘å‹•æ›´é †æš¢ */
    padding-bottom: 80px; /* åº•éƒ¨ç•™ç™½ï¼Œé¿å…æœ€å¾Œä¸€å€‹é …ç›®è¢«åˆ‡æ‰ */
    width: 100%; /* ç¢ºä¿å¯¬åº¦åƒæ»¿ */
}

/* 2. éš±è—é†œé†œçš„æ²è»¸æ¢ (ä½†åœ¨æ»‘å‹•æ™‚é‚„æ˜¯æœ‰æ•ˆ) */
#feature-content-area::-webkit-scrollbar {
    display: none;
}

/* 3. é˜²æ­¢æ»‘å‹•ç©¿é€ (é¿å…æ»‘åˆ°åº•æ™‚é€£å¸¶å‹•åˆ°å¾Œé¢çš„é¦–é ) */
#active-feature-container {
    overscroll-behavior: contain;
}
  </style>
</head>
<body>

    <div id="splash-screen">
        <div class="splash-content">
            <div class="splash-logo-container">
                <svg viewBox="0 0 100 100" fill="none" class="zen-dough">
                    <path d="M50 15C30 15 10 30 10 60C10 85 25 95 50 95C75 95 90 85 90 60C90 30 70 15 50 15Z" fill="#FFFFFF" stroke="#5C5552" stroke-width="2.5"/>
                    <circle cx="28" cy="62" r="3.5" fill="#FFD1DC" opacity="0.8"/>
                    <circle cx="72" cy="62" r="3.5" fill="#FFD1DC" opacity="0.8"/>
                    <path d="M28 55 Q35 58 42 55" stroke="#5C5552" stroke-width="2.5" fill="none" stroke-linecap="round"/>
                    <path d="M58 55 Q65 58 72 55" stroke="#5C5552" stroke-width="2.5" fill="none" stroke-linecap="round"/>
                    <path d="M45 68 Q50 71 55 68" stroke="#5C5552" stroke-width="2" fill="none" opacity="0.8"/>
                </svg>
            </div>
            <div class="splash-title">Safe Space</div>
            <div class="splash-subtitle">å±¬æ–¼ä½ çš„å¿ƒéˆé¿é¢¨æ¸¯</div>
            <button class="start-btn" id="splash-start-btn">é€²å…¥ç©ºé–“</button>
        </div>
    </div>

    <div class="settings-fab" onclick="openSettings()">
        <svg class="gear-icon" viewBox="0 0 24 24">
            <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L3.16 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.04.64.09.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
        </svg>
    </div>

    <div id="settings-modal" onclick="closeSettings(event)">
        <div class="settings-content">
            <div class="settings-header">
                <div class="settings-title">å€‹äººè¨­å®š</div>
                <button class="close-btn" style="padding: 5px 12px; font-size: 0.8rem;" onclick="toggleSettings()">âœ•</button>
            </div>

            <div class="setting-section-title">æˆ‘çš„æª”æ¡ˆ</div>
            <div class="setting-item">
                <div class="st-label"><span class="st-icon">âœï¸</span> ä½ çš„ç¨±å‘¼</div>
                <input type="text" id="nickname-input" class="setting-input" placeholder="æ—…äºº" maxlength="8">
            </div>

            <div class="setting-section-title">ç’°å¢ƒé«”é©—</div>
            
            <div class="setting-item">
                <div class="st-label"><span class="st-icon">ğŸŒ™</span> æº«æš–æ·±è‰²æ¨¡å¼</div>
                <div class="toggle-switch" id="setting-dark-toggle"></div>
            </div>

            <div class="setting-item">
                <div class="st-label"><span class="st-icon">ğŸµ</span> èƒŒæ™¯éŸ³æ¨‚</div>
                <div class="toggle-switch" id="setting-music-toggle"></div>
            </div>

            <div class="setting-item">
                <div class="st-label"><span class="st-icon">ğŸ”Š</span> äº’å‹•éŸ³æ•ˆ (SFX)</div>
                <div class="toggle-switch" id="setting-sfx-toggle"></div>
            </div>

            <div class="setting-item">
                <div class="st-label">
                    <span class="st-icon">
                        <svg viewBox="0 0 100 100" fill="none" style="width:22px;height:22px;vertical-align:middle;">
                            <path d="M50 15C30 15 10 30 10 60C10 85 25 95 50 95C75 95 90 85 90 60C90 30 70 15 50 15Z" fill="#FFFFFF" stroke="#5C5552" stroke-width="3"/>
                            <circle cx="35" cy="55" r="4" fill="#5C5552"/>
                            <circle cx="65" cy="55" r="4" fill="#5C5552"/>
                            <circle cx="28" cy="62" r="3" fill="#FFD1DC" opacity="0.8"/>
                            <circle cx="72" cy="62" r="3" fill="#FFD1DC" opacity="0.8"/>
                        </svg>
                    </span> 
                    éºµåœ˜ç²¾éˆ
                </div>
                <div class="toggle-switch" id="setting-pet-toggle"></div>
            </div>

            <div class="setting-item">
                <div class="st-label"><span class="st-icon">ğŸŒ</span> èªè¨€ / Language</div>
                <div style="font-size:0.8rem; font-weight:700; color:var(--primary);">ç¹é«”ä¸­æ–‡</div>
            </div>

            <div class="setting-section-title">ç³»çµ±</div>
            <button class="btn-action danger-btn" style="font-size:0.8rem;" onclick="resetAppData()">ğŸ—‘ï¸ é‡ç½®æ‰€æœ‰è³‡æ–™</button>

            <div style="margin-top:20px; padding-top:15px; border-top:1px solid var(--border-color);">
                <div style="font-size:0.7rem; color:var(--text-sub); text-align:center;">
                    Designed by æœæ™ºå¹³/æœçš®<br>
                    Safe Space v1.3
                </div>
            </div>
        </div>
    </div>

    <div id="spirit-pet">
        <div class="pet-speech-bubble" id="pet-speech">å˜¿å’»ï¼<span class="kaomoji">( >Ï‰&lt;)</span></div>
        <div class="pet-svg-body">
            <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M50 15C30 15 10 30 10 60C10 85 25 95 50 95C75 95 90 85 90 60C90 30 70 15 50 15Z" fill="#FFFFFF" stroke="#E0E0E0" stroke-width="3"/>
                <circle cx="35" cy="55" r="4" fill="#5C5552">
                    <animate attributeName="ry" values="4;0.5;4" dur="3s" repeatCount="indefinite" />
                </circle>
                <circle cx="65" cy="55" r="4" fill="#5C5552">
                    <animate attributeName="ry" values="4;0.5;4" dur="3s" repeatCount="indefinite" />
                </circle>
                <circle cx="28" cy="62" r="3" fill="#FFD1DC" opacity="0.6"/>
                <circle cx="72" cy="62" r="3" fill="#FFD1DC" opacity="0.6"/>
            </svg>
        </div>
    </div>

    <header>
        <h1 id="greeting-title">Safe Space</h1>
        <p class="subtitle">åœ¨é€™è£¡ï¼Œä½ ä¸éœ€è¦å‹‰å¼·è‡ªå·±ã€‚</p>
    </header>

    <div class="search-container">
        <input type="text" id="search-input" placeholder="ğŸ” æœå°‹ï¼šå¡”ç¾…ã€å‘¼å¸ã€è¿·æƒ˜...">
    </div>

    <section class="triage-section">
        <div class="triage-title">ç¾åœ¨çš„å¿ƒæƒ…åƒä»€éº¼å¤©æ°£ï¼Ÿ</div>
        <div class="mood-grid" id="mood-grid-container">
            </div>
        <div style="text-align:center; margin-top:15px; font-size:0.9rem; color:var(--text-sub); cursor:pointer; text-decoration:underline;" onclick="resetAllFilters()">
            é¡¯ç¤ºå…¨éƒ¨åŠŸèƒ½
        </div>
        
        <div class="fav-fab-container" onclick="toggleFavFilter()">
            <div class="fav-fab" id="fav-fab-btn">
                <div class="fav-icon">â¤</div>
                <div class="fav-text">æ”¶è—</div>
            </div>
        </div>
    </section>

    <section class="toolbox-grid" id="toolbox">
        </section>

    <div id="active-feature-container">
        <div class="modal-header">
            <button class="close-btn" id="feature-close-btn">é—œé–‰ âœ•</button>
        </div>
        <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <h2 id="feature-title-display" style="text-align: center; font-size: 2rem; color: var(--primary); margin-bottom: 20px; font-weight:900;">åŠŸèƒ½åç¨±</h2>
            <div id="feature-content-area" style="text-align: center;">
                <p style="font-size: 1.1rem; color: var(--text-sub);">âœ¨ è¼•è¼•åœ°å¸æ°£ï¼Œæ…¢æ…¢åœ°åæ°£ âœ¨</p>
                <p style="font-size: 0.9rem; color: #CCC; margin-top:10px;">(åŠŸèƒ½å»ºç½®ä¸­)</p>
            </div>
        </div>
    </div>

    <script>
        
        // ============================================
        // 1. è³‡æ–™åº« (SVG æ¸²æŸ“å¼•æ“)
        // ============================================

        // --- SVG å…ƒä»¶ ---
        const DOUGH_BODY = `<path d="M50 15C30 15 10 30 10 60C10 85 25 95 50 95C75 95 90 85 90 60C90 30 70 15 50 15Z" fill="#FFFFFF" stroke="#5C5552" stroke-width="2.5"/>`;
        const CHEEKS = `<circle cx="28" cy="62" r="3.5" fill="#FFD1DC" opacity="0.9"/><circle cx="72" cy="62" r="3.5" fill="#FFD1DC" opacity="0.9"/>`;

        function getMoodIcon(moodId) {
            let content = '';
            switch(moodId) {
                case 'anxious': 
                    content = `${DOUGH_BODY} ${CHEEKS}<g style="animation: sway 0.2s infinite"><circle cx="35" cy="55" r="4" fill="#5C5552"/><circle cx="65" cy="55" r="4" fill="#5C5552"/><path d="M45 68 Q50 72 55 68" stroke="#5C5552" stroke-width="2" fill="none"/></g><path d="M20 30 Q20 40 25 40 Q30 40 30 30" fill="#A0C4FF" style="animation: tearDrop 1s infinite"/>`;
                    break;
                case 'low': 
                    content = `<path d="M50 35C30 35 10 45 10 70C10 90 25 95 50 95C75 95 90 90 90 70C90 45 70 35 50 35Z" fill="#FFFFFF" stroke="#5C5552" stroke-width="2.5"/>${CHEEKS}<path d="M30 60 L40 65" stroke="#5C5552" stroke-width="2" stroke-linecap="round"/><path d="M70 60 L60 65" stroke="#5C5552" stroke-width="2" stroke-linecap="round"/><path d="M45 75 Q50 70 55 75" stroke="#5C5552" stroke-width="2" fill="none"/>`;
                    break;
                case 'angry':
                    content = `${DOUGH_BODY}<path d="M30 50 L40 55" stroke="#5C5552" stroke-width="2.5"/><path d="M70 50 L60 55" stroke="#5C5552" stroke-width="2.5"/><circle cx="35" cy="60" r="3" fill="#5C5552"/><circle cx="65" cy="60" r="3" fill="#5C5552"/><path d="M45 75 Q50 70 55 75" stroke="#5C5552" stroke-width="2" fill="none"/><path d="M50 10 L50 5" stroke="#FF6B6B" stroke-width="3" style="animation: floatItem 0.5s infinite"/><path d="M60 12 L62 6" stroke="#FF6B6B" stroke-width="3" style="animation: floatItem 0.6s infinite"/>`;
                    break;
                case 'numb':
                    content = `<path d="M50 15C30 15 10 30 10 60C10 85 25 95 50 95C75 95 90 85 90 60C90 30 70 15 50 15Z" fill="#FFFFFF" stroke="#5C5552" stroke-width="2.5" stroke-dasharray="4 4"/><circle cx="28" cy="62" r="3.5" fill="#DDD" opacity="0.9"/><circle cx="72" cy="62" r="3.5" fill="#DDD" opacity="0.9"/><circle cx="35" cy="55" r="4" stroke="#5C5552" stroke-width="2" fill="none"/><circle cx="65" cy="55" r="4" stroke="#5C5552" stroke-width="2" fill="none"/><line x1="45" y1="70" x2="55" y2="70" stroke="#5C5552" stroke-width="2"/>`;
                    break;
                case 'confused':
                    content = `${DOUGH_BODY} ${CHEEKS}<g style="animation: spinEye 3s linear infinite; transform-origin: 35px 55px"><path d="M35 55 m-3 0 a 3 3 0 1 0 6 0 a 3 3 0 1 0 -6 0" stroke="#5C5552" stroke-width="1.5" fill="none"/></g><g style="animation: spinEye 3s linear infinite reverse; transform-origin: 65px 55px"><path d="M65 55 m-3 0 a 3 3 0 1 0 6 0 a 3 3 0 1 0 -6 0" stroke="#5C5552" stroke-width="1.5" fill="none"/></g><path d="M48 70 Q50 68 52 70" stroke="#5C5552" stroke-width="2"/>`;
                    break;
                case 'panic': 
                    content = `<g style="animation: panicWave 0.2s infinite">${DOUGH_BODY} ${CHEEKS}<circle cx="35" cy="55" r="5" fill="#5C5552"/><circle cx="65" cy="55" r="5" fill="#5C5552"/><ellipse cx="50" cy="72" rx="6" ry="8" fill="#5C5552"/><path d="M10 60 L0 50" stroke="#5C5552" stroke-width="3"/><path d="M90 60 L100 50" stroke="#5C5552" stroke-width="3"/></g>`;
                    break;
            }
            return `<svg viewBox="0 0 100 100" fill="none" class="mood-icon-svg">${content}</svg>`;
        }

        function getFeatureIcon(id) {
            let content = '';
            let eyes = `<circle cx="35" cy="55" r="4" fill="#5C5552"/><circle cx="65" cy="55" r="4" fill="#5C5552"/>`;
            let mouth = `<path d="M45 68 Q50 72 55 68" stroke="#5C5552" stroke-width="2" fill="none"/>`;

            switch(id) {
                case 'dbt_cards':
                    content = `${DOUGH_BODY} ${CHEEKS} ${eyes} <path d="M45 65 Q50 75 55 65" stroke="#5C5552" stroke-width="2" fill="none"/><rect x="60" y="40" width="20" height="30" rx="2" fill="white" stroke="#5C5552" stroke-width="2" transform="rotate(15 60 40)" style="animation: floatItem 2s infinite"/><path d="M65 45 L75 50" stroke="#FFD1DC" stroke-width="2"/>`;
                    break;
                case 'quotes':
                    content = `${DOUGH_BODY} ${CHEEKS} <path d="M30 55 Q35 50 40 55" stroke="#5C5552" stroke-width="2" fill="none"/><path d="M60 55 Q65 50 70 55" stroke="#5C5552" stroke-width="2" fill="none"/><circle cx="50" cy="68" r="4" fill="#5C5552"/><path d="M70 20 H90 V35 H70 L65 40 V20 Z" fill="white" stroke="#5C5552" stroke-width="2"/><circle cx="76" cy="28" r="1.5" fill="#5C5552"/><circle cx="80" cy="28" r="1.5" fill="#5C5552"/><circle cx="84" cy="28" r="1.5" fill="#5C5552"/>`;
                    break;
                case 'tarot':
                    content = `${DOUGH_BODY} ${CHEEKS} <path d="M30 55 L40 55" stroke="#5C5552" stroke-width="2"/><path d="M60 55 L70 55" stroke="#5C5552" stroke-width="2"/><circle cx="50" cy="80" r="12" fill="#E0F7FA" stroke="#5C5552" stroke-width="1.5" opacity="0.8"/><path d="M50 75 L52 77" stroke="white" stroke-width="2"/>`;
                    break;
                case 'answer_book':
                    content = `${DOUGH_BODY} ${CHEEKS} ${eyes} ${mouth} <circle cx="35" cy="55" r="7" stroke="#5C5552" stroke-width="1.5" fill="none"/><circle cx="65" cy="55" r="7" stroke="#5C5552" stroke-width="1.5" fill="none"/><line x1="42" y1="55" x2="58" y2="55" stroke="#5C5552" stroke-width="1.5"/><rect x="75" y="50" width="15" height="25" fill="#5C5552" transform="rotate(10)"/><rect x="78" y="52" width="2" height="21" fill="white" transform="rotate(10)"/>`;
                    break;
                case 'questions':
                    content = `${DOUGH_BODY} ${CHEEKS} <path d="M30 58 L40 58" stroke="#5C5552" stroke-width="2"/><path d="M60 58 L70 58" stroke="#5C5552" stroke-width="2"/><text x="15" y="30" font-size="20" fill="#5C5552" style="animation: floatItem 2s infinite">?</text><text x="75" y="30" font-size="16" fill="#5C5552" style="animation: floatItem 3s infinite reverse">?</text>`;
                    break;
                case 'jokes':
                    content = `${DOUGH_BODY} ${CHEEKS} <path d="M30 50 L35 55 L40 50" stroke="#5C5552" stroke-width="2" fill="none"/><path d="M60 50 L65 55 L70 50" stroke="#5C5552" stroke-width="2" fill="none"/><path d="M40 65 Q50 80 60 65" fill="#5C5552"/><path d="M10 60 Q5 50 15 50" stroke="#5C5552" stroke-width="2" fill="none" style="animation: sway 0.5s infinite"/><path d="M90 60 Q95 50 85 50" stroke="#5C5552" stroke-width="2" fill="none" style="animation: sway 0.5s infinite"/>`;
                    break;
                case 'animals':
                    content = `${DOUGH_BODY} ${CHEEKS} ${eyes} ${mouth} <path d="M30 20 L40 5 L50 20" fill="white" stroke="#5C5552" stroke-width="2.5"/><path d="M50 20 L60 5 L70 20" fill="white" stroke="#5C5552" stroke-width="2.5"/><line x1="20" y1="60" x2="5" y2="55" stroke="#5C5552" stroke-width="1.5"/><line x1="20" y1="65" x2="5" y2="70" stroke="#5C5552" stroke-width="1.5"/><line x1="80" y1="60" x2="95" y2="55" stroke="#5C5552" stroke-width="1.5"/><line x1="80" y1="65" x2="95" y2="70" stroke="#5C5552" stroke-width="1.5"/><path d="M85 80 Q95 80 95 60" stroke="#5C5552" stroke-width="3" fill="none" stroke-linecap="round" style="animation: sway 2s infinite"/>`;
                    break;
                case 'tasks':
                    content = `<g style="animation: muscleFlex 1.5s infinite">${DOUGH_BODY} ${CHEEKS} <line x1="30" y1="48" x2="40" y2="55" stroke="#5C5552" stroke-width="2.5"/><line x1="70" y1="48" x2="60" y2="55" stroke="#5C5552" stroke-width="2.5"/><path d="M45 70 H55" stroke="#5C5552" stroke-width="2"/><path d="M15 60 Q5 50 15 40" stroke="#5C5552" stroke-width="4" fill="none"/><path d="M85 60 Q95 50 85 40" stroke="#5C5552" stroke-width="4" fill="none"/></g>`;
                    break;
                case 'breathing':
                    content = `<g style="animation: breathe 4s ease-in-out infinite">${DOUGH_BODY} ${CHEEKS} <path d="M30 55 Q35 50 40 55" stroke="#5C5552" stroke-width="2" fill="none"/><path d="M60 55 Q65 50 70 55" stroke="#5C5552" stroke-width="2" fill="none"/><circle cx="50" cy="70" r="3" fill="#5C5552"/><path d="M48 85 Q50 90 52 85" stroke="#5C5552" stroke-width="2"/></g>`;
                    break;
                case 'clicker':
                    content = `${DOUGH_BODY} ${CHEEKS} ${mouth} <circle cx="35" cy="55" r="4" fill="#5C5552"/><circle cx="37" cy="53" r="1.5" fill="white"/><circle cx="65" cy="55" r="4" fill="#5C5552"/><circle cx="67" cy="53" r="1.5" fill="white"/><circle cx="80" cy="40" r="5" stroke="#5C5552" fill="white" opacity="0.7"/><circle cx="20" cy="80" r="4" stroke="#5C5552" fill="white" opacity="0.7"/><path d="M80 60 L85 50" stroke="#5C5552" stroke-width="2.5" style="animation: floatItem 0.5s infinite"/>`;
                    break;
                case 'whiteboard':
                    content = `${DOUGH_BODY} ${CHEEKS} ${eyes} ${mouth} <path d="M30 20 Q50 5 70 20 H30 Z" fill="#5C5552"/><rect x="48" y="10" width="4" height="6" fill="#5C5552"/><circle cx="20" cy="70" r="10" fill="white" stroke="#5C5552" stroke-width="1.5"/><circle cx="18" cy="68" r="2" fill="#FF6B6B"/><circle cx="22" cy="72" r="2" fill="#4ECDC4"/><line x1="80" y1="70" x2="90" y2="60" stroke="#5C5552" stroke-width="2"/>`;
                    break;
                case 'conveyor':
                    content = `${DOUGH_BODY} ${CHEEKS} ${eyes} <path d="M45 68 Q50 72 55 68" stroke="#5C5552" stroke-width="2" fill="none"/><rect x="60" y="30" width="15" height="10" rx="2" stroke="#5C5552" fill="white" style="animation: conveyorMove 2s linear infinite"/><line x1="10" y1="85" x2="90" y2="85" stroke="#5C5552" stroke-width="2" stroke-dasharray="5 5"/>`;
                    break;
                case 'worry_jar':
                    content = `<path d="M50 35C30 35 10 45 10 60C10 85 25 95 50 95C75 95 90 85 90 60C90 45 70 35 50 35Z" fill="#FFFFFF" stroke="#5C5552" stroke-width="1.5" stroke-dasharray="2 2"/> ${CHEEKS} ${eyes} ${mouth} <g style="animation: lidOpen 3s infinite"> <path d="M50 35 C30 35 10 45 10 50 L90 50 C90 45 70 35 50 35Z" fill="white" stroke="#5C5552" stroke-width="2"/> </g>`;
                    break;
                case 'sos':
                    content = `${DOUGH_BODY} ${CHEEKS} <path d="M35 55 L40 50 L35 45" stroke="#5C5552" stroke-width="2" fill="none"/><path d="M65 55 L60 50 L65 45" stroke="#5C5552" stroke-width="2" fill="none"/><path d="M45 70 Q50 65 55 70" stroke="#5C5552" stroke-width="2" fill="none"/><rect x="20" y="80" width="60" height="15" fill="#FF6B6B" stroke="#5C5552" rx="2"/><text x="32" y="91" font-family="Arial" font-weight="bold" font-size="10" fill="white">SOS</text><path d="M20 75 L20 80" stroke="#5C5552" stroke-width="2"/><path d="M80 75 L80 80" stroke="#5C5552" stroke-width="2"/>`;
                    break;
                default: 
                    content = `${DOUGH_BODY} ${CHEEKS} ${eyes} ${mouth}`;
                    break;
            }
            return `<svg viewBox="0 0 100 100" fill="none" class="feature-svg">${content}</svg>`;
        }

        // --- åŠŸèƒ½èˆ‡æƒ…ç·’è³‡æ–™ ---
        const featuresDB = [
            { id: 'dbt_cards', name: 'è‡ªæˆ‘ç…§é¡§å¡', tag: 'DBTç­–ç•¥', moods: ['anxious', 'low', 'numb'], keywords: 'å¡ç‰‡,æŠ½å¡,ç­–ç•¥' },
            { id: 'quotes', name: 'ç™‚ç™’é‡‘å¥', tag: 'æ–‡å­—åŠ›é‡', moods: ['low', 'stress'], keywords: 'èªéŒ„,å¥å­,é¼“å‹µ' },
            { id: 'tarot', name: 'å¡”ç¾…æŒ‡å¼•', tag: 'æ½›æ„è­˜', moods: ['anxious', 'confused'], keywords: 'å¡”ç¾…,å åœ' },
            { id: 'answer_book', name: 'è§£ç­”ä¹‹æ›¸', tag: 'éˆæ„ŸæŒ‡å¼•', moods: ['confused', 'anxious'], keywords: 'è§£ç­”,å›°æƒ‘,è¿·æƒ˜' }, 
            { id: 'questions', name: 'å•å¥å¼•å°', tag: 'è‡ªæˆ‘å°è©±', moods: ['low', 'confused', 'numb'], keywords: 'æ•˜äº‹,sfbt,æ€è€ƒ' }, 
            { id: 'jokes', name: 'ç¬‘è©±æ€¥è½‰å½', tag: 'è½‰æ›å¿ƒæƒ…', moods: ['stress', 'low'], keywords: 'ç¬‘è©±,é–‹å¿ƒ' },
            { id: 'animals', name: 'æ¯›å­©ç™‚ç™’', tag: 'è¦–è¦ºå®‰æ’«', moods: ['stress', 'low', 'angry'], keywords: 'è²“,ç‹—,å¯æ„›' },
            { id: 'tasks', name: 'å¾®å°æˆå°±', tag: 'è¡Œå‹•', moods: ['numb', 'low'], keywords: 'ä»»å‹™,å‹•åŠ›' },
            { id: 'breathing', name: 'å‘¼å¸ç·´ç¿’', tag: 'ç”Ÿç†èª¿ç¯€', moods: ['anxious', 'angry', 'panic'], keywords: 'å‘¼å¸,æ”¾é¬†,å†¥æƒ³' },
            { id: 'clicker', name: 'ç´“å£“æ³¡æ³¡', tag: 'é‡‹æ”¾å£“åŠ›', moods: ['stress', 'angry'], keywords: 'æŒ‰éˆ•,æ³¡æ³¡ç´™' },
            { id: 'whiteboard', name: 'æƒ…ç·’å¡—é´‰', tag: 'è¡¨é”', moods: ['angry', 'confused', 'numb'], keywords: 'ç•«ç•«,å¯«å­—,ç™½æ¿' },
            { id: 'conveyor', name: 'å¿µé ­è¼¸é€å¸¶', tag: 'ACTè„«é‰¤', moods: ['anxious', 'stress'], keywords: 'å¿µé ­,æƒ³æ³•' },
            { id: 'worry_jar', name: 'ç…©æƒ±å¯„æ”¾', tag: 'é‚Šç•Œè¨­å®š', moods: ['anxious', 'stress'], keywords: 'ç…©æƒ±,ç¡ä¸è‘—' },
            { id: 'sos', name: 'å®‰å…¨ç¶² SOS', tag: 'å±æ©Ÿæ±‚åŠ©', moods: ['panic', 'low'], keywords: 'æ±‚æ•‘,é›»è©±' }
        ];

        const moodOptions = [
            { id: 'anxious', label: 'ğŸ˜° ç„¦æ…®æ…Œå¼µ', color: '#A0C4FF' },
            { id: 'low', label: 'ğŸ˜ ä½è½ç„¡åŠ›', color: '#5C5552' },
            { id: 'angry', label: 'ğŸ˜¡ ç”Ÿæ°£æ†¤æ€’', color: '#FF6B6B' },
            { id: 'numb', label: 'ğŸ˜¶ éº»æœ¨æ”¾ç©º', color: '#CCCCCC' },
            { id: 'confused', label: 'ğŸ¤” è¿·æƒ˜å›°æƒ‘', color: '#BDB2FF' },
            { id: 'panic', label: 'ğŸ†˜ å¿«å´©æ½°äº†', color: '#FFADAD' }
        ];

        // ============================================
        // 2. é‚è¼¯æ§åˆ¶ (Logic Controller)
        // ============================================

        // ç‹€æ…‹è®Šæ•¸
        let favorites = JSON.parse(localStorage.getItem('safeSpaceFavs')) || [];
        let userNickname = localStorage.getItem('safeSpaceName') || "";
        let isMusicOn = JSON.parse(localStorage.getItem('safeSpaceMusicOn')) ?? true; 
        let isSfxOn = JSON.parse(localStorage.getItem('safeSpaceSfxOn')) ?? true; 
        let isPetActive = JSON.parse(localStorage.getItem('safeSpacePetActive')) ?? true; 
        let isDarkMode = JSON.parse(localStorage.getItem('safeSpaceDarkMode')) ?? false;
        
        let selectedMoods = new Set();
        let isFavFilterActive = false;
        let searchKeyword = "";

        // DOM Elements
        const toolboxEl = document.getElementById('toolbox');
        const moodGrid = document.getElementById('mood-grid-container');
        const searchInput = document.getElementById('search-input');
        const favFabBtn = document.getElementById('fav-fab-btn');
        const petEl = document.getElementById('spirit-pet');
        const greetingTitle = document.getElementById('greeting-title');
        const splashScreen = document.getElementById('splash-screen');
        
        // è¨­å®šç›¸é—œ DOM
        const settingsModal = document.getElementById('settings-modal');
        const nicknameInput = document.getElementById('nickname-input');
        const musicToggle = document.getElementById('setting-music-toggle');
        const sfxToggle = document.getElementById('setting-sfx-toggle');
        const petToggle = document.getElementById('setting-pet-toggle');
        const darkToggle = document.getElementById('setting-dark-toggle');

        function initApp() {
            // å¥—ç”¨æ·±è‰²æ¨¡å¼
            if (isDarkMode) document.body.classList.add('dark-mode');

            renderMoodButtons();
            updateResults();
            initPetSystem();
            initSettings(); 
            updateGreeting(); 
            
            // ç¶å®š Splash é»æ“Š (è§¸ç™¼ AudioContext èˆ‡è‡ªå‹•æ’­æ”¾)
            const splashBtn = document.getElementById('splash-start-btn');
            splashBtn.onclick = () => {
                splashScreen.style.opacity = '0';
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    document.body.style.overflow = 'auto'; // é–‹æ”¾æ²å‹•
                }, 800);
                
                // å•Ÿå‹•éŸ³è¨Šæ ¸å¿ƒ
                resumeAudioContext();
                if(isMusicOn) playNextNote(); // è‡ªå‹•æ’­æ”¾
            };
        }

        function updateGreeting() {
            if (userNickname && userNickname.trim() !== "") {
                const hour = new Date().getHours();
                let greet = "ä½ å¥½";
                if (hour < 6) greet = "å¤œæ·±äº†";
                else if (hour < 11) greet = "æ—©å®‰";
                else if (hour < 14) greet = "åˆå®‰";
                else if (hour < 18) greet = "ä¸‹åˆå¥½";
                else greet = "æ™šå®‰";
                
                // å¼·åˆ¶é¡æ–‡å­—ç”¨ Arialï¼Œé¿å…è·‘ç‰ˆ
                greetingTitle.innerHTML = `${greet}ï¼Œ${userNickname} <span class="kaomoji" style="font-size:0.8em; margin-left:5px;">( Ë˜ Â³Ë˜)</span>`;
            } else {
                greetingTitle.innerHTML = 'Safe Space <span class="kaomoji" style="font-size:0.8em; margin-left:5px;">( Ë˜ Â³Ë˜)</span>';
            }
        }

        // --- è¨­å®šåŠŸèƒ½æ•´åˆ ---
        function initSettings() {
            // 1. æš±ç¨±
            nicknameInput.value = userNickname;
            nicknameInput.addEventListener('input', (e) => {
                userNickname = e.target.value;
                localStorage.setItem('safeSpaceName', userNickname);
                updateGreeting();
            });

            // 2. æ·±è‰²æ¨¡å¼
            updateToggleUI(darkToggle, isDarkMode);
            darkToggle.onclick = () => {
                isDarkMode = !isDarkMode;
                localStorage.setItem('safeSpaceDarkMode', isDarkMode);
                updateToggleUI(darkToggle, isDarkMode);
                if(isDarkMode) document.body.classList.add('dark-mode');
                else document.body.classList.remove('dark-mode');
            };

            // 3. éŸ³æ¨‚é–‹é—œ
            updateToggleUI(musicToggle, isMusicOn);
            musicToggle.onclick = () => {
                isMusicOn = !isMusicOn;
                localStorage.setItem('safeSpaceMusicOn', isMusicOn);
                updateToggleUI(musicToggle, isMusicOn);
                
                if (isMusicOn) {
                    resumeAudioContext();
                    if (!bgmTimeout) playNextNote();
                } else {
                    clearTimeout(bgmTimeout);
                    bgmTimeout = null;
                }
            };

            // 4. éŸ³æ•ˆé–‹é—œ
            updateToggleUI(sfxToggle, isSfxOn);
            sfxToggle.onclick = () => {
                isSfxOn = !isSfxOn;
                localStorage.setItem('safeSpaceSfxOn', isSfxOn);
                updateToggleUI(sfxToggle, isSfxOn);
            };

            // 5. ç²¾éˆé–‹é—œ
            updateToggleUI(petToggle, isPetActive);
            petToggle.onclick = () => {
                isPetActive = !isPetActive;
                localStorage.setItem('safeSpacePetActive', isPetActive);
                updateToggleUI(petToggle, isPetActive);
                updatePetVisibility();
            };
        }

        function updateToggleUI(el, isActive) {
            if(isActive) el.classList.add('active');
            else el.classList.remove('active');
        }

        function openSettings() {
            settingsModal.style.display = 'flex';
            void settingsModal.offsetWidth; 
            settingsModal.classList.add('show');
            // æ¨å…¥æ­·å²ç´€éŒ„ä»¥æ”¯æ´è¿”å›éµé—œé–‰
            history.pushState({ type: 'settings' }, null, "#settings");
        }
        function closeSettings(e) {
            if(e.target === settingsModal) {
                history.back(); // è§¸ç™¼ popstate ä¾†é—œé–‰
            }
        }
        function toggleSettings() {
            if(settingsModal.classList.contains('show')) {
                history.back();
            } else {
                openSettings();
            }
        }

        function resetAppData() {
            if(confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¨­å®šå’Œæ”¶è—å—ï¼Ÿé€™å°‡ç„¡æ³•å¾©åŸã€‚')) {
                localStorage.clear();
                location.reload();
            }
        }


        // --- æ ¸å¿ƒäº’å‹•é‚è¼¯ ---
        function renderMoodButtons() {
            moodGrid.innerHTML = '';
            moodOptions.forEach(mood => {
                const btn = document.createElement('div');
                btn.className = 'mood-card';
                btn.dataset.id = mood.id;
                btn.onclick = () => toggleMood(mood.id);
                btn.innerHTML = `
                    ${getMoodIcon(mood.id)}
                    <div class="mood-label">${mood.label}</div>
                `;
                btn.style.setProperty('--mood-color', mood.color);
                moodGrid.appendChild(btn);
            });
        }

        function updateResults() {
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.mood-card').forEach(btn => {
                const id = btn.dataset.id;
                const moodData = moodOptions.find(m => m.id === id);
                if(selectedMoods.has(id)) {
                    btn.classList.add('active');
                    btn.style.borderColor = moodData.color; 
                } else {
                    btn.classList.remove('active');
                    btn.style.borderColor = 'transparent';
                }
            });

            // æ›´æ–°æ”¶è—æŒ‰éˆ•
            if(isFavFilterActive) favFabBtn.classList.add('active');
            else favFabBtn.classList.remove('active');

            // ç¯©é¸é‚è¼¯
            let filtered = featuresDB.filter(item => {
                const matchKeyword = searchKeyword === "" || item.name.includes(searchKeyword) || item.keywords.includes(searchKeyword) || item.tag.includes(searchKeyword);
                const itemMoodsSet = new Set(item.moods);
                const hasMoodIntersection = [...selectedMoods].some(mood => itemMoodsSet.has(mood));
                const matchMood = selectedMoods.size === 0 || hasMoodIntersection;
                const matchFav = !isFavFilterActive || favorites.includes(item.id);
                return matchKeyword && matchMood && matchFav;
            });
            renderFeatures(filtered);
        }

        function renderFeatures(list) {
            toolboxEl.innerHTML = '';
            if (list.length === 0) {
                toolboxEl.innerHTML = `<div style="grid-column:span 2; text-align:center; padding:30px; color:#aaa; font-weight:700;">ğŸ‚<br>é€™è£¡ç©ºç©ºçš„</div>`;
                return;
            }
            list.forEach(feature => {
                const isFav = favorites.includes(feature.id);
                const card = document.createElement('div');
                card.className = 'feature-card';
                card.innerHTML = `
                    <div class="card-fav-btn ${isFav ? 'is-active' : ''}" onclick="toggleCardFav(event, '${feature.id}')">
                        ${isFav ? 'â¤ï¸' : 'ğŸ¤'}
                    </div>
                    <div class="card-visual">${getFeatureIcon(feature.id)}</div>
                    <div class="card-title">${feature.name}</div>
                    <div class="card-tag">${feature.tag}</div>
                `;
                card.onclick = (e) => {
                    if(e.target.classList.contains('card-fav-btn')) return;
                    openFeature(feature);
                };
                toolboxEl.appendChild(card);
            });
        }

        function toggleMood(moodId) {
            if (selectedMoods.has(moodId)) selectedMoods.delete(moodId);
            else selectedMoods.add(moodId);
            ensureHistoryState();
            updateResults();
        }

        function toggleFavFilter() {
            isFavFilterActive = !isFavFilterActive;
            ensureHistoryState();
            updateResults();
        }

        function toggleCardFav(event, id) {
            event.stopPropagation();
            if (favorites.includes(id)) favorites = favorites.filter(favId => favId !== id);
            else favorites.push(id);
            localStorage.setItem('safeSpaceFavs', JSON.stringify(favorites));
            
            if (isSfxOn) { /* å¯ä»¥åœ¨é€™è£¡åŠ ä¸€å€‹è¼•å¾®çš„é»æ“ŠéŸ³æ•ˆ */ }
            
            if(isFavFilterActive) updateResults();
            else {
                const btn = event.currentTarget;
                const isNowFav = favorites.includes(id);
                btn.innerHTML = isNowFav ? 'â¤ï¸' : 'ğŸ¤';
                btn.classList.toggle('is-active');
            }
        }

        searchInput.addEventListener('input', (e) => {
            searchKeyword = e.target.value.toLowerCase().trim();
            if(searchKeyword !== "") ensureHistoryState();
            updateResults();
        });

        function resetAllFilters() {
            selectedMoods.clear();
            isFavFilterActive = false;
            searchKeyword = "";
            searchInput.value = "";
            updateResults();
        }

        function ensureHistoryState() {
            if (window.location.hash !== '#filter' && window.location.hash !== '#feature') {
                history.pushState({ type: 'filter' }, null, '#filter');
            }
        }
        
       /* =========================================
   1. å®šç¾©å…·é«”çš„å…§å®¹æ¸²æŸ“é‚è¼¯ (Renderers)
   ========================================= */
const renderers = {
// --- ğŸƒ Feature: DBT Cards (ä¿®å¾©è®Šæ•¸é †åºèˆ‡æ‰€æœ‰åŠŸèƒ½) ---
    renderDbtCards: (container) => {
               // 4. å®šç¾© DBT è³‡æ–™
        const dbt_data = [
            { id:1, type:'mindfulness', title:'æ‰¾å‡ºå°ç«ç·š', subtitle:'éˆé–åˆ†æ', desc:'è©³ç´°åˆ—å‡ºå°è‡´å•é¡Œè¡Œç‚ºçš„é€£ä¸²äº‹ä»¶ï¼šèª˜ç™¼äº‹ä»¶ -> æƒ³æ³• -> æƒ…ç·’ -> è¡Œç‚º -> å¾Œæœã€‚' },
            { id:2, type:'mindfulness', title:'æ‰¾å‡ºå¡é—œé»', subtitle:'ç¼ºå¤±éˆé–', desc:'åˆ†ææ˜¯ä»€éº¼é˜»ç¤™äº†æœ‰æ•ˆè¡Œç‚ºï¼Ÿæ˜¯ç¼ºä¹æŠ€èƒ½ã€ææ‡¼ã€é‚„æ˜¯ç’°å¢ƒå› ç´ ï¼Ÿ' },
            { id:3, type:'mindfulness', title:'æ˜æ™ºä¹‹å¿ƒ', subtitle:'Wise Mind', desc:'åœ¨æ¥µç«¯æƒ…ç·’èˆ‡å†·é…·é‚è¼¯ä¹‹é–“ï¼Œæ‰¾åˆ°å…§åœ¨çš„ç›´è¦ºèˆ‡æ™ºæ…§ã€‚' },
            { id:4, type:'mindfulness', title:'è§€å¯Ÿ', subtitle:'Observe', desc:'åªç”¨æ„Ÿå®˜å»é«”é©—ç•¶ä¸‹ï¼Œåƒä¸æ²¾é‹ä¸€æ¨£ï¼Œè®“å¿µé ­ä¾†å»è€Œä¸æŠ“å–ã€‚' },
            { id:5, type:'mindfulness', title:'æè¿°', subtitle:'Describe', desc:'è²¼æ¨™ç±¤ã€‚æŠŠã€Œæˆ‘å¾ˆçˆ›ã€æ”¹æˆã€Œæˆ‘ç¾åœ¨æ„Ÿåˆ°ç¾æ„§ã€ï¼Œåªé™³è¿°äº‹å¯¦ã€‚' },
            { id:6, type:'mindfulness', title:'åƒèˆ‡', subtitle:'Participate', desc:'å®Œå…¨æŠ•å…¥ç•¶ä¸‹çš„æ´»å‹•ï¼Œä¸Ÿæ‰è‡ªæˆ‘æ„è­˜ï¼Œèˆ‡ç•¶ä¸‹åˆä¸€ã€‚' },
            { id:7, type:'mindfulness', title:'ä¸æ‰¹åˆ¤', subtitle:'Non-judgmental', desc:'å€åˆ†äº‹å¯¦èˆ‡è©•åƒ¹ã€‚ä¸èªªã€Œé€™å¾ˆç³Ÿã€ï¼Œæ”¹èªªã€Œé€™è®“æˆ‘ä¸èˆ’æœã€ã€‚' },
            { id:8, type:'mindfulness', title:'å°ˆæ³¨ç•¶ä¸‹', subtitle:'One-mindfully', desc:'ä¸€æ¬¡åªåšä¸€ä»¶äº‹ã€‚èµ°è·¯æ™‚åªèµ°è·¯ï¼Œåƒé£¯æ™‚åªåƒé£¯ã€‚' },
            { id:9, type:'mindfulness', title:'æœ‰æ•ˆç‡', subtitle:'Effectively', desc:'åšå°ç›®æ¨™æœ‰å¹«åŠ©çš„äº‹ï¼Œæ”¾æ£„çˆ­è«–ã€Œå°éŒ¯ã€æˆ–ã€Œå…¬å¹³ã€ã€‚' },
            { id:10, type:'interpersonal', title:'DEAR', subtitle:'åŠ‡æœ¬æºé€š', desc:'Describe(æè¿°), Express(è¡¨é”), Assert(è¦æ±‚), Reinforce(å¢å¼·)ã€‚' },
            { id:11, type:'interpersonal', title:'MAN', subtitle:'è«‡åˆ¤å§¿æ…‹', desc:'Mindful(å°ˆæ³¨ç›®æ¨™), Appear confident(è‡ªä¿¡), Negotiate(å”å•†)ã€‚' },
            { id:12, type:'interpersonal', title:'GIVE-G', subtitle:'æº«å’Œ', desc:'Gentle: èªªè©±æº«å’Œï¼Œä¸æ”»æ“Šã€ä¸å¨è„…ã€ä¸æ‰¹åˆ¤ã€‚' },
            { id:13, type:'interpersonal', title:'GIVE-I', subtitle:'èˆˆè¶£', desc:'Interested: å±•ç¾èˆˆè¶£ï¼Œçœ¼ç¥æ¥è§¸ï¼Œå°ˆå¿ƒå‚¾è½ï¼Œä¸æ‰“æ–·ã€‚' },
            { id:14, type:'interpersonal', title:'GIVE-V', subtitle:'èªå¯', desc:'Validate: é€éè©±èªæˆ–è¡¨æƒ…ï¼Œèªå¯å°æ–¹çš„æ„Ÿå—èˆ‡è™•å¢ƒã€‚' },
            { id:15, type:'interpersonal', title:'GIVE-E', subtitle:'è¼•é¬†', desc:'Easy manner: æ…‹åº¦è¼•é¬†ï¼Œé‹ç”¨å¹½é»˜ï¼Œæ”¾é¬†å˜´è§’ã€‚' },
            { id:16, type:'interpersonal', title:'FAST-A', subtitle:'ä¸äº‚é“æ­‰', desc:'Apologies: æ²’åšéŒ¯å°±ä¸èªªå°ä¸èµ·ï¼Œä¸éœ€ç‚ºå­˜åœ¨æ„Ÿåˆ°æŠ±æ­‰ã€‚' },
            { id:17, type:'interpersonal', title:'FAST-S', subtitle:'åƒ¹å€¼è§€', desc:'Stick to values: å …å®ˆè‡ªå·±çš„åº•ç·šèˆ‡åƒ¹å€¼è§€ã€‚' },
            { id:18, type:'interpersonal', title:'FAST-T', subtitle:'èª å¯¦', desc:'Truthful: ä¸æ’’è¬Šï¼Œä¸èª‡å¤§ï¼Œä¸ç‚ºäº†é¿æˆ°è€Œæ¬ºé¨™ã€‚' },
            { id:19, type:'interpersonal', title:'è¾¯è­‰æ³•', subtitle:'Middle Path', desc:'å°‹æ±‚ä¸­é“ã€‚é€™ä¸æ˜¯äºŒé¸ä¸€ï¼Œè€Œæ˜¯å…©å€‹å°ç«‹é¢å¯èƒ½åŒæ™‚æˆç«‹ã€‚' },
            { id:20, type:'emotion', title:'æª¢æŸ¥äº‹å¯¦', subtitle:'Check Facts', desc:'æˆ‘çš„æƒ…ç·’åæ‡‰æ˜¯å¦ç¬¦åˆå®¢è§€äº‹å¯¦ï¼Ÿå¦‚æœä¸ç¬¦ï¼Œæ”¹è®Šæƒ³æ³•ã€‚' },
            { id:21, type:'emotion', title:'ç›¸åå‹•ä½œ', subtitle:'Opposite Action', desc:'ç•¶æƒ…ç·’ä¸ç¬¦åˆäº‹å¯¦æˆ–ç„¡æ•ˆæ™‚ï¼Œåšèˆ‡æƒ…ç·’è¡å‹•å®Œå…¨ç›¸åçš„äº‹ã€‚' },
            { id:22, type:'emotion', title:'è§£æ±ºå•é¡Œ', subtitle:'Problem Solving', desc:'é‡å°å¤–åœ¨å•é¡Œåˆ—å‡ºæ­¥é©Ÿï¼šå®šç¾©å•é¡Œ -> åˆ—å‡ºæ–¹æ¡ˆ -> åŸ·è¡Œã€‚' },
            { id:23, type:'emotion', title:'ç´¯ç©æ­£å‘', subtitle:'Positive Exp', desc:'çŸ­æœŸï¼šæ¯å¤©åšä¸€ä»¶è®“è‡ªå·±å¿«æ¨‚çš„å°äº‹ã€‚é•·æœŸï¼šç‚ºäººç”Ÿç›®æ¨™åŠªåŠ›ã€‚' },
            { id:24, type:'emotion', title:'å»ºç«‹æŒæ§', subtitle:'Mastery', desc:'æ¯å¤©åšä¸€ä»¶ç¨å¾®æœ‰æŒ‘æˆ°æ€§ä½†èƒ½å®Œæˆçš„äº‹ï¼Œå»ºç«‹å‹ä»»æ„Ÿã€‚' },
            { id:25, type:'emotion', title:'é å…ˆæ‡‰å°', subtitle:'Cope Ahead', desc:'æƒ³åƒæœªä¾†å¯èƒ½çš„å£“åŠ›æƒ…å¢ƒï¼Œä¸¦åœ¨è…¦ä¸­æ¼”ç·´æœ‰æ•ˆçš„æ‡‰å°æ–¹å¼ã€‚' },
            { id:26, type:'emotion', title:'PLEASE', subtitle:'é¡§å¥½èº«é«”', desc:'æ²»ç™‚ç–¾ç—…ã€å¹³è¡¡é£²é£Ÿã€é¿å…è—¥ç‰©æ¿«ç”¨ã€å……è¶³ç¡çœ ã€é©åº¦é‹å‹•ã€‚' },
            { id:27, type:'emotion', title:'æƒ…ç·’è¡æµª', subtitle:'Surfing', desc:'æŠŠæƒ…ç·’æƒ³åƒæˆæµ·æµªï¼Œä½ ç«™åœ¨è¡æµªæ¿ä¸Šï¼Œè§€å¯Ÿå®ƒçš„èµ·ä¼è€Œä¸è¢«æ·¹æ²’ã€‚' },
            { id:28, type:'distress', title:'STOP', subtitle:'åœçœ‹è½', desc:'Stop(åœä¸‹), Take a step back(å¾Œé€€), Observe(è§€å¯Ÿ), Proceed(è¡Œå‹•)ã€‚' },
            { id:29, type:'distress', title:'åˆ©å¼Šåˆ†æ', subtitle:'Pros & Cons', desc:'åˆ—å‡ºè¡å‹•è¡Œç‚ºçš„å„ªé»èˆ‡ç¼ºé»ï¼Œä»¥åŠã€Œå¿ä½ä¸è¡å‹•ã€çš„å„ªé»èˆ‡ç¼ºé»ã€‚' },
            { id:30, type:'distress', title:'TIP-T', subtitle:'å†°æ°´é™æº«', desc:'Temperature: ç”¨å†·æ°´æ½‘è‡‰æˆ–æ¡ä½å†°å¡Šï¼Œå•Ÿå‹•æ½›æ°´åå°„ï¼Œå¿«é€Ÿå†·éœã€‚' },
            { id:31, type:'distress', title:'TIP-I', subtitle:'åŠ‡çƒˆé‹å‹•', desc:'Intense exercise: çŸ­æ™‚é–“é«˜å¼·åº¦é‹å‹•ï¼Œæ¶ˆè€—éå‰©çš„æƒ…ç·’èƒ½é‡ã€‚' },
            { id:32, type:'distress', title:'ACCEPTS', subtitle:'è½‰ç§»æ³¨æ„', desc:'æ´»å‹•ã€è²¢ç»ã€æ¯”è¼ƒã€ç›¸åæƒ…ç·’ã€æ¨é–‹ã€æƒ³åˆ¥çš„äº‹ã€å¼·çƒˆæ„Ÿå®˜åˆºæ¿€ã€‚' },
            { id:33, type:'distress', title:'è‡ªæˆ‘å®‰æ’«', subtitle:'Self-Soothe', desc:'é‹ç”¨äº”æ„Ÿ(è¦–ã€è½ã€å—…ã€å‘³ã€è§¸)ä¾†æº«æŸ”åœ°ç…§é¡§è‡ªå·±ã€‚' },
            { id:34, type:'distress', title:'å¾¹åº•æ¥å—', subtitle:'Radical Accept', desc:'é€™ä¸æ˜¯èªåŒï¼Œè€Œæ˜¯åœæ­¢èˆ‡ç¾å¯¦å°æŠ—ã€‚æ·±å‘¼å¸ï¼Œæ¥å—ã€Œäº‹æƒ…å°±æ˜¯é€™æ¨£ã€ã€‚' },
            { id:35, type:'distress', title:'è½‰å‘å¿ƒæ™º', subtitle:'Turning Mind', desc:'åƒé‡åˆ°å²”è·¯ä¸€æ¨£ï¼Œåè¦†åœ°é¸æ“‡è½‰å‘ã€Œæ¥å—ã€çš„é“è·¯ã€‚' },
            { id:36, type:'distress', title:'æ„é¡˜', subtitle:'Willingness', desc:'åƒçƒå“¡æ¥å—æ•™ç·´æŒ‡å°ä¸€æ¨£ï¼Œæ”¾ä¸‹ä»»æ€§(Willfulness)ï¼Œåšç•¶ä¸‹è©²åšçš„äº‹ã€‚' },
            { id:37, type:'distress', title:'åŠç¬‘', subtitle:'Half-Smile', desc:'æ”¾é¬†è‡‰éƒ¨è‚Œè‚‰ï¼Œå˜´è§’å¾®å¾®ä¸Šæšã€‚ç”Ÿç†å›é¥‹æœƒå‘Šè¨´å¤§è…¦ä½ æ˜¯å®‰å…¨çš„ã€‚' },
            { id:38, type:'distress', title:'æˆ’ç™®', subtitle:'Abstinence', desc:'è¾¯è­‰æ€§æˆ’ç™®ï¼šæ‰¿èªæœƒè·Œå€’ï¼Œä½†è‡´åŠ›æ–¼å¾¹åº•æˆ’é™¤ã€‚ç‡’æ‰å¾Œè·¯ã€‚' }
        ];

        // --- 1. éºµåœ˜ SVG (ä¿æŒç²¾ç·»è»Ÿé™¶è³ªæ„Ÿ) ---
        const createDough = (type, contentSvg) => {
            const theme = {
                'mindfulness': { color: '#9B6E9F', blush: '#E1BEE7' },
                'interpersonal': { color: '#6E8F9F', blush: '#B3E5FC' },
                'emotion': { color: '#D67D68', blush: '#FFCDD2' },
                'distress': { color: '#78909C', blush: '#CFD8DC' }
            }[type] || { color: '#555', blush: '#FFB7B2' };

            return `
            <svg viewBox="0 0 100 100" style="width:100%; height:100%; overflow:visible;">
                <defs>
                    <filter id="softGlow-${type}" x="-20%" y="-20%" width="140%" height="140%">
                        <feGaussianBlur in="SourceAlpha" stdDeviation="2" result="blur"/>
                        <feOffset in="blur" dx="0" dy="2" result="offsetBlur"/>
                        <feMerge>
                            <feMergeNode in="offsetBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>
                <g filter="url(#softGlow-${type})">
                    <path d="M50 12 C20 12 5 30 5 62 C5 88 22 98 50 98 C78 98 95 88 95 62 C95 30 80 12 50 12 Z" 
                          fill="#FDFBF7" stroke="${theme.color}" stroke-width="2.5" stroke-linejoin="round" />
                    <circle cx="25" cy="62" r="7" fill="${theme.blush}" opacity="0.6" filter="blur(1px)"/>
                    <circle cx="75" cy="62" r="7" fill="${theme.blush}" opacity="0.6" filter="blur(1px)"/>
                    <g stroke="${theme.color}" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        ${contentSvg}
                    </g>
                </g>
            </svg>`;
        };

        const svgs = {
            mindfulness: createDough('mindfulness', `<path d="M30 55 Q35 58 40 55 M60 55 Q65 58 70 55" /><path d="M48 48 Q50 65 52 48" opacity="0.4"/><path d="M45 68 Q50 72 55 68" />`),
            interpersonal: createDough('interpersonal', `<circle cx="32" cy="55" r="2.5" fill="#6E8F9F" stroke="none"/><circle cx="68" cy="55" r="2.5" fill="#6E8F9F" stroke="none"/><path d="M45 66 Q50 71 55 66" /><path d="M75 22 L92 22 L92 38 L82 38 L78 44 L75 38 Z" fill="#E1F5FE" stroke-width="1.5"/><text x="80" y="34" font-size="9" fill="#6E8F9F" stroke="none" font-weight="bold" font-family="sans-serif">Hi</text>`),
            emotion: createDough('emotion', `<circle cx="32" cy="55" r="2.5" fill="#D67D68" stroke="none"/><circle cx="68" cy="55" r="2.5" fill="#D67D68" stroke="none"/><path d="M48 66 Q50 62 52 66"/><path d="M50 78 C40 74 36 78 36 84 C36 90 50 95 50 95 C50 95 64 90 64 84 C64 78 60 74 50 78 Z" fill="#FFEBEE" />`),
            distress: createDough('distress', `<circle cx="32" cy="55" r="2.5" fill="#78909C" stroke="none"/><circle cx="68" cy="55" r="2.5" fill="#78909C" stroke="none"/><path d="M28 48 L40 52 M72 48 L60 52" stroke-width="2"/><path d="M45 68 L55 68" /><path d="M22 75 L38 75 L38 88 Q30 93 22 88 Z" fill="#ECEFF1" />`)
        };

        // (Data çœç•¥ï¼Œä¿æŒä¸è®Š)
        
        let state = { phase: 'SELECT', type: null, cards: [] };

        // æ¸²æŸ“ä¸»æ§
        const render = () => {
            container.innerHTML = '';
            const wrapper = document.createElement('div');
            wrapper.className = 'dbt-wrapper';

            if(state.phase === 'SELECT') renderSelect(wrapper);
            else if(state.phase === 'CAROUSEL') renderCarousel(wrapper);
            else if(state.phase === 'RIP') renderRip(wrapper);
            else if(state.phase === 'REVEAL') renderReveal(wrapper);
            else if(state.phase === 'SUMMARY') renderSummary(wrapper);

            container.appendChild(wrapper);
            updateBackLogic();
        };

        const updateBackLogic = () => {
            window.currentFeatureBack = () => {
                if (state.phase === 'SELECT') return false;
                if (state.phase === 'SUMMARY') state.phase = 'SELECT';
                else if (state.phase === 'REVEAL') state.phase = 'RIP';
                else if (state.phase === 'RIP') state.phase = 'CAROUSEL';
                else if (state.phase === 'CAROUSEL') state.phase = 'SELECT';
                render();
                return true;
            };
        };

        const go = (phase, data = {}) => {
            state = { ...state, phase, ...data };
            render();
        };

        const getMeta = (type) => {
            const map = {
                'mindfulness': { color: '#9B6E9F', bg: '#F3E5F5', title: 'æ­£å¿µè¦ºå¯Ÿ', icon: svgs.mindfulness },
                'interpersonal': { color: '#6E8F9F', bg: '#E1F5FE', title: 'äººéš›æ•ˆèƒ½', icon: svgs.interpersonal },
                'emotion': { color: '#D67D68', bg: '#FFEBEE', title: 'æƒ…ç·’èª¿ç¯€', icon: svgs.emotion },
                'distress': { color: '#78909C', bg: '#ECEFF1', title: 'ç—›è‹¦è€å—', icon: svgs.distress }
            };
            return map[type] || map['mindfulness'];
        };

        // 1. SELECT
        const renderSelect = (root) => {
            root.innerHTML = `
                <div class="dbt-stage">
                    <div style="font-size:1.1rem; margin-bottom:15px; opacity:0.8; font-weight:bold;">ä½ éœ€è¦å“ªæ–¹é¢çš„æŒ‡å¼•ï¼Ÿ</div>
                    <div class="dough-grid">
                        ${['mindfulness','interpersonal','emotion','distress'].map(type => {
                            const meta = getMeta(type);
                            return `
                            <div class="dough-btn" onclick="window.dbtToCarousel('${type}')">
                                <div class="dough-svg">${meta.icon}</div>
                                <div class="dough-label" style="color:${meta.color}">${meta.title}</div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            `;
            window.dbtToCarousel = (type) => go('CAROUSEL', { type });
        };

        // 2. CAROUSEL (æš–éŠ€è‰²)
        const renderCarousel = (root) => {
            const meta = getMeta(state.type);
            root.innerHTML = `
                <div class="dbt-stage">
                    <div class="carousel-container" id="c-stage">
                        <div class="pack-carousel" id="c-pack">
                            ${Array(8).fill(0).map((_, i) => `
                                <div class="pack-3d-item" style="transform: rotateY(${i * 45}deg) translateZ(300px); border-color:rgba(255,255,255,0.5)">
                                    <div class="pack-crimp-top"></div>
                                    <div class="pack-sticker">
                                        <div style="width:65px; height:65px; filter:drop-shadow(0 4px 6px rgba(0,0,0,0.1));">${meta.icon}</div>
                                        <div style="font-weight:bold; margin-top:8px; color:${meta.color}; font-size:1rem;">${meta.title}</div>
                                    </div>
                                    <div style="font-size:0.8em; opacity:0.6; margin-top:15px; color:var(--dbt-text); letter-spacing:1px;">Vol. ${i+1}</div>
                                    <div class="pack-crimp-bottom"></div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div style="opacity:0.6; margin-top:10px; font-size:0.9rem;">å·¦å³æ»‘å‹•æ—‹è½‰ â€¢ é»æ“Šç¢ºèª</div>
                </div>
            `;
            
            // ... (è½‰ç›¤é‚è¼¯ä¿æŒä¸è®Šï¼Œç•¥) ...
            const stage = root.querySelector('#c-stage');
            const pack = root.querySelector('#c-pack');
            let startX = 0, currentRot = 0, isDragging = false;
            const update = () => pack.style.transform = `rotateY(${currentRot}deg)`;
            stage.onmousedown = e => { isDragging=true; startX=e.clientX; };
            stage.ontouchstart = e => { isDragging=true; startX=e.touches[0].clientX; };
            const move = x => {
                if(!isDragging) return;
                currentRot += (x - startX) * 0.4; 
                startX = x;
                update();
            };
            stage.onmousemove = e => move(e.clientX);
            stage.ontouchmove = e => move(e.touches[0].clientX);
            const end = () => {
                isDragging = false;
                const snap = Math.round(currentRot / 45) * 45;
                currentRot = snap;
                update();
            };
            stage.onmouseup = end;
            stage.ontouchend = end;
            stage.onclick = (e) => {
                if(Math.abs(startX - e.clientX) < 5) {
                    if(navigator.vibrate) navigator.vibrate(40);
                    go('RIP');
                }
            };
        };

        // 3. RIP (é ‚éƒ¨æ’•é–‹ + æš–éŠ€è³ªæ„Ÿ)
        const renderRip = (root) => {
            const meta = getMeta(state.type);
            root.innerHTML = `
                <div class="dbt-stage">
                    <div class="rip-container">
                        <div class="rip-strip-top" id="rip-strip">
                            <div class="rip-arrow">â¤ PULL</div>
                        </div>

                        <div class="rip-pack-main" id="pack-body">
                            <div style="margin-top:40px; transform:scale(1.1); display:flex; flex-direction:column; align-items:center;">
                                <div style="width:90px; height:90px; filter:drop-shadow(0 5px 10px rgba(0,0,0,0.1));">${meta.icon}</div>
                                <h3 style="color:${meta.color}; margin-top:15px; font-size:1.4rem;">${meta.title}</h3>
                            </div>
                            <div class="pack-crimp-bottom"></div>
                            <div class="rip-trace-top" id="rip-trace"></div>
                        </div>
                    </div>
                    <div style="margin-top:25px; font-size:0.9rem; opacity:0.6;">æŒ‰ä½ä¸Šæ–¹æ¨™ç±¤å‘å³æ’•é–‹</div>
                </div>
            `;

            const strip = root.querySelector('#rip-strip');
            const trace = root.querySelector('#rip-trace');
            const body = root.querySelector('#pack-body');
            let startX = 0, isDragging = false;
            const packWidth = 240; 

            const update = (x) => {
                if(!isDragging) return;
                let delta = x - startX;
                if(delta < 0) delta = 0;
                
                // æ’•é–‹é€²åº¦
                const progress = Math.min(delta / (packWidth * 0.95), 1);
                
                // é ‚éƒ¨æ’•æ¢ç§»å‹• (Xè»¸) & æ—‹è½‰
                strip.style.transform = `translateX(${delta}px) rotate(${delta * 0.05}deg)`;
                strip.style.opacity = 1 - (progress * 0.5);
                
                // æ’•ç—•é¡¯ç¾
                trace.style.width = `${delta + 20}px`;
                trace.style.opacity = progress * 0.8;

                if(progress >= 1) {
                    isDragging = false;
                    finishRip();
                }
            };

            const finishRip = () => {
                if(navigator.vibrate) navigator.vibrate([50, 30, 50]);
                strip.style.transition = '0.4s ease-out';
                strip.style.transform = `translateX(${packWidth + 80}px) rotate(20deg)`;
                strip.style.opacity = '0';
                
                setTimeout(() => {
                    body.style.transition = '0.5s cubic-bezier(0.6, -0.28, 0.735, 0.045)';
                    body.style.transform = 'scale(1.1) rotate(5deg)';
                    body.style.opacity = '0';
                    
                    const pool = dbt_data.filter(c => c.type === state.type);
                    const picks = [];
                    const temp = [...pool];
                    for(let i=0; i<3; i++) {
                        if(temp.length) {
                            const idx = Math.floor(Math.random() * temp.length);
                            picks.push(temp[idx]);
                            temp.splice(idx,1);
                        }
                    }
                    setTimeout(() => go('REVEAL', { cards: picks }), 400);
                }, 200);
            };

            const start = (x) => { isDragging = true; startX = x; };
            const end = () => { 
                if(isDragging) {
                    isDragging = false;
                    strip.style.transition = '0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    strip.style.transform = 'translateX(0)';
                    trace.style.width = '0';
                }
            };

            strip.onmousedown = e => start(e.clientX);
            strip.ontouchstart = e => start(e.touches[0].clientX);
            window.onmousemove = e => update(e.clientX);
            window.ontouchmove = e => update(e.touches[0].clientX);
            window.onmouseup = end;
            window.ontouchend = end;
        };

        // 4. REVEAL (å…§éƒ¨é–ƒå…‰)
        const renderReveal = (root) => {
            const meta = getMeta(state.type);
            let idx = 0;
            root.innerHTML = `
                <div class="dbt-stage" id="reveal-stage">
                    <div class="real-card-stack" id="stack"></div>
                    <div style="margin-top:25px; font-size:0.9rem; opacity:0.8;" id="hint">é»æ“Šå¡ç‰‡ç¿»é–‹</div>
                </div>
            `;
            const stack = root.querySelector('#stack');
            state.cards.forEach((c, i) => {
                const el = document.createElement('div');
                el.className = 'real-card-item';
                el.style.zIndex = 10 - i;
                el.id = `card-${i}`;
                el.innerHTML = `
                    <div class="real-card-face real-card-front" id="front-${i}">
                        <div class="shine-inner"></div>
                        
                        <div class="real-card-content">
                            <div style="width:60px; height:60px; margin-bottom:15px; filter:drop-shadow(0 2px 4px rgba(0,0,0,0.1));">${meta.icon}</div>
                            <h3 style="color:${meta.color}; font-size:1.4rem; margin-bottom:5px;">${c.title}</h3>
                            <div style="font-size:0.95rem; opacity:0.6; margin-bottom:15px; border-bottom:1px solid #ddd; padding-bottom:5px; width:80%; text-align:center;">${c.subtitle}</div>
                            <p style="text-align:justify; line-height:1.6; color:var(--dbt-text); font-size:1rem;">${c.desc}</p>
                        </div>
                    </div>
                    <div class="real-card-face real-card-back" style="--card-theme-bg: ${meta.bg}">
                        <div style="width:90px; opacity:0.5; filter:grayscale(0.3);">${meta.icon}</div>
                    </div>
                `;
                stack.appendChild(el);
            });

            let step = 'FLIP';
            root.querySelector('#reveal-stage').onclick = () => {
                if(idx >= 3) return;
                const card = stack.querySelector(`#card-${idx}`);
                const front = stack.querySelector(`#front-${idx}`);
                const shine = front.querySelector('.shine-inner'); // æŠ“å–å…§éƒ¨é–ƒå…‰å±¤
                const hint = root.querySelector('#hint');

                if(step === 'FLIP') {
                    card.classList.add('flipped');
                    if(navigator.vibrate) navigator.vibrate(25);
                    // è§¸ç™¼å…§éƒ¨é–ƒå…‰
                    setTimeout(() => shine.classList.add('shine-silver'), 200); 
                    
                    hint.innerText = idx < 2 ? "å†æ¬¡é»æ“Šæ”¶èµ·" : "å†æ¬¡é»æ“ŠæŸ¥çœ‹çµæœ";
                    step = 'NEXT';
                } else {
                    card.classList.add('discarded');
                    idx++;
                    step = 'FLIP';
                    if(idx >= 3) {
                        setTimeout(() => go('SUMMARY'), 400);
                    } else {
                        hint.innerText = "é»æ“Šä¸‹ä¸€å¼µ";
                    }
                }
            };
        };

        // 5. SUMMARY (Lightbox Full Screen)
        const renderSummary = (root) => {
            const meta = getMeta(state.type);
            root.innerHTML = `
                <div class="dbt-stage" style="justify-content: flex-start; padding-top: 20px;">
                    <h2 style="color:${meta.color}; margin-bottom:5px;">ä»Šæ—¥æŒ‡å¼•</h2>
                    <div style="font-size:0.9rem; opacity:0.6; margin-bottom:15px;">é»æ“Šå¡ç‰‡æ”¾å¤§æŸ¥çœ‹</div>
                    <div class="summary-grid">
                        ${state.cards.map((c, i) => `
                            <div class="mini-card" onclick="window.dbtZoom(${i})" style="border-top-color:${meta.color}">
                                <div style="width:45px; height:45px; margin-bottom:8px;">${meta.icon}</div>
                                <div style="font-weight:bold; margin-bottom:5px; color:${meta.color}">${c.title}</div>
                                <div style="font-size:0.75rem; line-height:1.4; text-align:justify; overflow:hidden; height:75px; opacity:0.8;">${c.desc}</div>
                            </div>
                        `).join('')}
                    </div>
                    <button class="dbt-btn" onclick="window.dbtBackToSelect()" style="margin-top:30px;">å›åˆ°é¸æ“‡</button>
                </div>
                <div id="zoom-modal-container"></div>
            `;
            
            window.dbtBackToSelect = () => go('SELECT');
            
            window.dbtZoom = (index) => {
                const c = state.cards[index];
                const modalContainer = root.querySelector('#zoom-modal-container');
                // å…¨è¢å¹•å±•ç¤º
                modalContainer.innerHTML = `
                    <div class="card-lightbox" onclick="this.remove()">
                        <div class="lightbox-content" onclick="event.stopPropagation()">
                             <div class="lightbox-card-face">
                                <div style="width:90px; height:90px; margin-bottom:20px; flex-shrink:0;">${meta.icon}</div>
                                <h3 style="color:${meta.color}; font-size:1.6rem; margin-bottom:10px;">${c.title}</h3>
                                <div style="font-size:1.1rem; opacity:0.6; margin-bottom:20px; border-bottom:1px solid #ccc; padding-bottom:5px; width:80%; text-align:center;">${c.subtitle}</div>
                                <p style="text-align:justify; line-height:1.6; font-size:1.1rem; color:var(--dbt-text);">${c.desc}</p>
                                <div style="margin-top:30px; font-size:0.8rem; opacity:0.5;">é»æ“ŠèƒŒæ™¯é—œé–‰</div>
                             </div>
                        </div>
                    </div>
                `;
            };
        };

        render();
    },
renderAnswerBook: (container) => {
    // 1. å®šç¾©æ¨¡ç³Šä½†å…·å•Ÿç™¼æ€§çš„ç­”æ¡ˆåº« (å¯ä»¥è‡ªå·±ç„¡é™æ“´å……)
   // ğŸ”® æ“´å……å¾Œçš„ 200+ å¥è§£ç­”åº«
const ab_answers = [
    // --- æ­£å‘è‚¯å®š (Action & Yes) ---
    "æ¯«ç„¡ç–‘å•ã€‚<span class='ab-en'>Without a doubt.</span>",
    "é€™å°±æ˜¯ä½ æƒ³è¦çš„ç­”æ¡ˆã€‚<span class='ab-en'>This is the answer you seek.</span>",
    "æ”¾æ‰‹å»åšã€‚<span class='ab-en'>Just do it.</span>",
    "çµ•å°æ˜¯ã€‚<span class='ab-en'>Absolutely.</span>",
    "ç¾åœ¨å°±æ˜¯æœ€ä½³æ™‚æ©Ÿã€‚<span class='ab-en'>Now is the perfect time.</span>",
    "é€™æ˜¯ä¸€å€‹å¾ˆæ£’çš„è¨ˆç•«ã€‚<span class='ab-en'>It is a great plan.</span>",
    "çµæœæœƒè®“ä½ é©šå–œã€‚<span class='ab-en'>The outcome will surprise you.</span>",
    "å‹‡å¾€ç›´å‰ã€‚<span class='ab-en'>Go for it.</span>",
    "ç›¸ä¿¡ä½ çš„ç›´è¦ºã€‚<span class='ab-en'>Trust your intuition.</span>",
    "æ˜¯çš„ï¼Œç«‹åˆ»ã€‚<span class='ab-en'>Yes, immediately.</span>",
    "é€™å€¼å¾—å†’éšªã€‚<span class='ab-en'>It is worth the risk.</span>",
    "ä½ æœƒæˆåŠŸçš„ã€‚<span class='ab-en'>You will succeed.</span>",
    "ä¸è¦çŒ¶è±«ã€‚<span class='ab-en'>Don't hesitate.</span>",
    "é€™å°‡å¸¶ä¾†å¥½é‹ã€‚<span class='ab-en'>It will bring good luck.</span>",
    "å…¨åŠ›ä»¥èµ´ã€‚<span class='ab-en'>Give it your all.</span>",
    "é€™æ˜¯æ­£ç¢ºçš„æ–¹å‘ã€‚<span class='ab-en'>You are on the right path.</span>",
    "ä½ çš„é¸æ“‡æ˜¯å°çš„ã€‚<span class='ab-en'>Your choice is correct.</span>",
    "å®ƒæœƒå¸¶ä¾†å¿«æ¨‚ã€‚<span class='ab-en'>It will bring joy.</span>",
    "ä¿æŒæ¨‚è§€ã€‚<span class='ab-en'>Stay optimistic.</span>",
    "å»åšå°±å°äº†ã€‚<span class='ab-en'>Just go ahead.</span>",
    "ä½ å·²ç¶“æº–å‚™å¥½äº†ã€‚<span class='ab-en'>You are ready.</span>",
    "é€™å°ä½ æœ‰åˆ©ã€‚<span class='ab-en'>The odds are in your favor.</span>",
    "é€™æ˜¯ä¸€æ¬¡åƒè¼‰é›£é€¢çš„æ©Ÿæœƒã€‚<span class='ab-en'>Once in a lifetime opportunity.</span>",
    "é€™ä»¶äº‹æœƒå¾ˆé †åˆ©ã€‚<span class='ab-en'>It will go smoothly.</span>",
    "ç›¡åŠ›è€Œç‚ºï¼Œå¿…æœ‰å›å ±ã€‚<span class='ab-en'>Do your best, and it will pay off.</span>",
    "ä½ æœƒå¾—åˆ°æ”¯æŒã€‚<span class='ab-en'>You will be supported.</span>",
    "æƒ…æ³æ­£åœ¨å¥½è½‰ã€‚<span class='ab-en'>Things are getting better.</span>",
    "ç›¸ä¿¡ä½ è‡ªå·±ã€‚<span class='ab-en'>Believe in yourself.</span>",
    "é€™æ˜¯ä¸€æ¢åº·èŠå¤§é“ã€‚<span class='ab-en'>It is a promising path.</span>",
    "ä½ æœƒç‚ºæ­¤æ„Ÿåˆ°è‡ªè±ªã€‚<span class='ab-en'>You will be proud of this.</span>",
    "ç¾åœ¨é–‹å§‹ã€‚<span class='ab-en'>Start now.</span>",
    "åˆ¥å›é ­ã€‚<span class='ab-en'>Don't look back.</span>",
    "ä½ æ¯”æƒ³åƒä¸­æ›´å¼·å¤§ã€‚<span class='ab-en'>You are stronger than you think.</span>",
    "é€™æ˜¯å‘½é‹çš„å®‰æ’ã€‚<span class='ab-en'>It is destiny.</span>",
    "å»çˆ­å–ã€‚<span class='ab-en'>Fight for it.</span>",
    "æ¥å—é€™å€‹æŒ‘æˆ°ã€‚<span class='ab-en'>Accept the challenge.</span>",
    "ä½ æœƒå–œæ­¡çµæœçš„ã€‚<span class='ab-en'>You will love the result.</span>",
    "é€™ä¸€é å°‡æ˜¯ç²¾å½©çš„ã€‚<span class='ab-en'>This chapter will be amazing.</span>",
    "æ˜¯çš„ã€‚<span class='ab-en'>Yes.</span>",
    "ç•¶ç„¶ã€‚<span class='ab-en'>Of course.</span>",

    // --- å¦å®šèˆ‡ç…è»Š (Stop & No) ---
    "çµ•å°ä¸æ˜¯ã€‚<span class='ab-en'>Absolutely not.</span>",
    "ä¸è¦é€™éº¼åšã€‚<span class='ab-en'>Don't do it.</span>",
    "ç¾åœ¨ä¸æ˜¯æ™‚å€™ã€‚<span class='ab-en'>Now is not the time.</span>",
    "é€™æ˜¯ä¸€å€‹é™·é˜±ã€‚<span class='ab-en'>It is a trap.</span>",
    "ä½ éœ€è¦åœä¸‹ä¾†ã€‚<span class='ab-en'>You need to stop.</span>",
    "é‚„ä¸æ˜¯æ™‚å€™ã€‚<span class='ab-en'>Not yet.</span>",
    "å†è€ƒæ…®ä¸€ä¸‹ã€‚<span class='ab-en'>Reconsider it.</span>",
    "é€™ä¸æ˜¯å€‹å¥½ä¸»æ„ã€‚<span class='ab-en'>It's not a good idea.</span>",
    "çµæœå¯èƒ½ä¸å¦‚é æœŸã€‚<span class='ab-en'>The outcome may disappoint you.</span>",
    "æœ€å¥½ä¸è¦ã€‚<span class='ab-en'>Better not.</span>",
    "è«‹ä¸‰æ€è€Œå¾Œè¡Œã€‚<span class='ab-en'>Think twice.</span>",
    "é€™æ¢è·¯è¡Œä¸é€šã€‚<span class='ab-en'>This way won't work.</span>",
    "é¢¨éšªå¤ªå¤§äº†ã€‚<span class='ab-en'>The risk is too high.</span>",
    "æ”¾ä¸‹å®ƒã€‚<span class='ab-en'>Let it go.</span>",
    "é€™ä¸å€¼å¾—ã€‚<span class='ab-en'>It is not worth it.</span>",
    "ä½ æœƒå¾Œæ‚”çš„ã€‚<span class='ab-en'>You will regret it.</span>",
    "ä¿æŒç¾ç‹€ã€‚<span class='ab-en'>Stay as you are.</span>",
    "ä¸è¦å¼·æ±‚ã€‚<span class='ab-en'>Don't force it.</span>",
    "é€™ä»¶äº‹æœ‰è®Šæ•¸ã€‚<span class='ab-en'>Variables exist.</span>",
    "å°å¿ƒè¡Œäº‹ã€‚<span class='ab-en'>Proceed with caution.</span>",
    "æš«æ™‚æ“±ç½®ã€‚<span class='ab-en'>Put it on hold.</span>",
    "é€™æ˜¯éŒ¯èª¤çš„é¸æ“‡ã€‚<span class='ab-en'>It is the wrong choice.</span>",
    "ä¸è¦è¡å‹•ã€‚<span class='ab-en'>Don't be impulsive.</span>",
    "ç¾åœ¨ä¸è¦ã€‚<span class='ab-en'>Not now.</span>",
    "ä½ éœ€è¦æ›´å¤šè³‡è¨Šã€‚<span class='ab-en'>You need more information.</span>",
    "é€™æœƒè®“ä½ åˆ†å¿ƒã€‚<span class='ab-en'>It will distract you.</span>",
    "æ‹’çµ•ã€‚<span class='ab-en'>Refuse.</span>",
    "ä¸è¦æµªè²»æ™‚é–“ã€‚<span class='ab-en'>Don't waste time.</span>",
    "çµæœä¸æ¨‚è§€ã€‚<span class='ab-en'>The outlook is not good.</span>",
    "é€™ä¸æ˜¯ä½ è©²ç®¡çš„äº‹ã€‚<span class='ab-en'>It's none of your business.</span>",
    "é é›¢å®ƒã€‚<span class='ab-en'>Stay away from it.</span>",
    "ä½ æœƒå¤±æœ›çš„ã€‚<span class='ab-en'>You will be disappointed.</span>",
    "ä¸è¦æŠ±å¤ªå¤§æœŸæœ›ã€‚<span class='ab-en'>Don't expect too much.</span>",
    "é€™æœƒå¾ˆå›°é›£ã€‚<span class='ab-en'>It will be difficult.</span>",
    "ä¸è¦è¢«è¡¨è±¡è¿·æƒ‘ã€‚<span class='ab-en'>Don't be fooled by appearances.</span>",
    "é€™ä¸é©åˆä½ ã€‚<span class='ab-en'>It's not for you.</span>",

    // --- æ™‚é–“ç›¸é—œ (Timing) ---
    "ç­‰å¾…ã€‚<span class='ab-en'>Wait.</span>",
    "è€å¿ƒæ˜¯é—œéµã€‚<span class='ab-en'>Patience is key.</span>",
    "ä¸€å€‹æœˆå¾Œã€‚<span class='ab-en'>In a month.</span>",
    "æ˜å¹´ã€‚<span class='ab-en'>Next year.</span>",
    "æ˜å¤©å†æ±ºå®šã€‚<span class='ab-en'>Decide tomorrow.</span>",
    "å¾ˆå¿«ã€‚<span class='ab-en'>Very soon.</span>",
    "é‚„éœ€è¦ä¸€é»æ™‚é–“ã€‚<span class='ab-en'>It needs more time.</span>",
    "æ™‚æ©Ÿå°šæœªæˆç†Ÿã€‚<span class='ab-en'>The time is not ripe.</span>",
    "ç¾åœ¨å¤ªæ—©äº†ã€‚<span class='ab-en'>Too early.</span>",
    "å†ç­‰ä¸€ç­‰ã€‚<span class='ab-en'>Wait a little longer.</span>",
    "é€™éœ€è¦æ™‚é–“ç™¼é…µã€‚<span class='ab-en'>Let it brew.</span>",
    "åˆ¥æ€¥ã€‚<span class='ab-en'>No rush.</span>",
    "æ™‚é–“æœƒè­‰æ˜ä¸€åˆ‡ã€‚<span class='ab-en'>Time will tell.</span>",
    "ä½ éœ€è¦ä¼‘æ¯ã€‚<span class='ab-en'>You need rest.</span>",
    "é€™æ˜¯ä¸€å€‹æ¼«é•·çš„éç¨‹ã€‚<span class='ab-en'>It is a long process.</span>",
    "ä¸è¦æ€¥æ–¼æ±‚æˆã€‚<span class='ab-en'>Don't rush success.</span>",
    "ä¸‹é€±æœƒæœ‰ç­”æ¡ˆã€‚<span class='ab-en'>Answer comes next week.</span>",
    "ç¾åœ¨ä¸æ˜¯æ“”å¿ƒçš„æ™‚åˆ»ã€‚<span class='ab-en'>Not the time to worry.</span>",
    "å¹¾å¹´å¾Œä½ æœƒæ„Ÿè¬è‡ªå·±ã€‚<span class='ab-en'>You'll thank yourself later.</span>",
    "é€™ä»¶äº‹æ€¥ä¸ä¾†ã€‚<span class='ab-en'>It cannot be rushed.</span>",
    "åœ¨æ˜¥å¤©ä¾†è‡¨ä¹‹å‰ã€‚<span class='ab-en'>Before spring comes.</span>",
    "å°±åœ¨çœ¼å‰ã€‚<span class='ab-en'>It is right in front of you.</span>",
    "é€™éœ€è¦é•·æœŸæŠ—æˆ°ã€‚<span class='ab-en'>It requires endurance.</span>",
    "æ”¾æ…¢è…³æ­¥ã€‚<span class='ab-en'>Slow down.</span>",
    "ä¸è¦è¶•é€²åº¦ã€‚<span class='ab-en'>Don't push the pace.</span>",
    "è®“å­å½ˆé£›ä¸€æœƒå…’ã€‚<span class='ab-en'>Let it unfold.</span>",
    "æ™‚é–“æ˜¯æœ€å¥½çš„è§£è—¥ã€‚<span class='ab-en'>Time is the best healer.</span>",
    "æ™‚æ©Ÿç¨ç¸±å³é€ã€‚<span class='ab-en'>Opportunity is fleeting.</span>",
    "ä½ éœ€è¦ç¡å€‹å¥½è¦ºå†ä¾†æƒ³ã€‚<span class='ab-en'>Sleep on it.</span>",
    "ä¸è¦åœ¨é€™å€‹é€±æœ«åšæ±ºå®šã€‚<span class='ab-en'>Don't decide this weekend.</span>",
    "é€™é€±ä¸é©åˆã€‚<span class='ab-en'>Not this week.</span>",
    "é‚„æœ‰æ©Ÿæœƒã€‚<span class='ab-en'>There is still a chance.</span>",

    // --- å°‹æ±‚å¤–éƒ¨è³‡æº (External Help) ---
    "å»å•å•ä½ çš„æ¯è¦ªã€‚<span class='ab-en'>Ask your mother.</span>",
    "è½å¾å°ˆå®¶çš„å»ºè­°ã€‚<span class='ab-en'>Listen to experts.</span>",
    "æœ‰äººåœ¨æš—ä¸­å¹«åŠ©ä½ ã€‚<span class='ab-en'>Someone is helping you secretly.</span>",
    "é€™éœ€è¦åˆä½œã€‚<span class='ab-en'>Collaboration is needed.</span>",
    "ä½ çš„æœ‹å‹çŸ¥é“ç­”æ¡ˆã€‚<span class='ab-en'>Your friend knows.</span>",
    "å°‹æ±‚å”åŠ©ã€‚<span class='ab-en'>Seek help.</span>",
    "ä¸è¦ç¨è‡ªæ‰¿æ“”ã€‚<span class='ab-en'>Don't bear it alone.</span>",
    "èˆ‡äººåˆ†äº«ã€‚<span class='ab-en'>Share it.</span>",
    "è½è½åˆ¥äººçš„æ„è¦‹ã€‚<span class='ab-en'>Listen to others.</span>",
    "è§€å¯Ÿåˆ¥äººçš„åšæ³•ã€‚<span class='ab-en'>Observe others.</span>",
    "ä½ éœ€è¦ä¸€å€‹å¤¥ä¼´ã€‚<span class='ab-en'>You need a partner.</span>",
    "ä¿¡ä»»ä½ çš„å°å¸«ã€‚<span class='ab-en'>Trust your mentor.</span>",
    "é€™èˆ‡æŸå€‹ä½ èªè­˜çš„äººæœ‰é—œã€‚<span class='ab-en'>It involves someone you know.</span>",
    "ä½ æœƒåœ¨å°è©±ä¸­æ‰¾åˆ°ç­”æ¡ˆã€‚<span class='ab-en'>Answer lies in conversation.</span>",
    "å»è®€æ›¸ã€‚<span class='ab-en'>Read a book.</span>",
    "æ³¨æ„è·¯æ¨™ã€‚<span class='ab-en'>Watch the signs.</span>",
    "é€™éœ€è¦åœ˜éšŠåˆä½œã€‚<span class='ab-en'>Teamwork required.</span>",
    "æ¥å—åˆ¥äººçš„å¥½æ„ã€‚<span class='ab-en'>Accept the kindness.</span>",
    "æœ‰äººæ­£åœ¨æƒ³å¿µä½ ã€‚<span class='ab-en'>Someone is missing you.</span>",
    "å»è¦‹è¦‹è€æœ‹å‹ã€‚<span class='ab-en'>See an old friend.</span>",
    "é€™å–æ±ºæ–¼ä»–äººã€‚<span class='ab-en'>It depends on others.</span>",
    "ä½ å¿½ç•¥äº†æŸå€‹äººçš„æ„Ÿå—ã€‚<span class='ab-en'>You ignored someone's feelings.</span>",
    "é€™èˆ‡å®¶åº­æœ‰é—œã€‚<span class='ab-en'>It is about family.</span>",
    "ä½ éœ€è¦é™ªä¼´ã€‚<span class='ab-en'>You need company.</span>",
    "é€™ä¸æ˜¯ä½ ä¸€å€‹äººçš„äº‹ã€‚<span class='ab-en'>It's not just about you.</span>",
    "å»å°‹æ‰¾æŒ‡å¼•ã€‚<span class='ab-en'>Seek guidance.</span>",
    "é€™éœ€è¦æºé€šã€‚<span class='ab-en'>Communication is needed.</span>",
    "é€™èˆ‡ä¸€æ®µé—œä¿‚æœ‰é—œã€‚<span class='ab-en'>It's about a relationship.</span>",
    "ä½ çš„å°æ‰‹æœƒå‘Šè¨´ä½ ç­”æ¡ˆã€‚<span class='ab-en'>Your rival holds the answer.</span>",
    "ä½ éœ€è¦å°ˆæ¥­å»ºè­°ã€‚<span class='ab-en'>Get professional advice.</span>",
    "ä¿¡ä»»é‚£å€‹æ„›ä½ çš„äººã€‚<span class='ab-en'>Trust the one who loves you.</span>",
    "é€™éœ€è¦å¦¥å”ã€‚<span class='ab-en'>Compromise is needed.</span>",

    // --- å…§åœ¨åæ€ (Reflection) ---
    "ç­”æ¡ˆå°±åœ¨ä½ å¿ƒä¸­ã€‚<span class='ab-en'>The answer is within you.</span>",
    "ä½ å…¶å¯¦å·²ç¶“çŸ¥é“ç­”æ¡ˆäº†ã€‚<span class='ab-en'>You already know the answer.</span>",
    "èª å¯¦é¢å°è‡ªå·±ã€‚<span class='ab-en'>Be honest with yourself.</span>",
    "é€™å°ä½ é‡è¦å—ï¼Ÿ<span class='ab-en'>Is this important to you?</span>",
    "ä½ åœ¨é€ƒé¿ä»€éº¼ï¼Ÿ<span class='ab-en'>What are you avoiding?</span>",
    "é€™çœŸçš„è®“ä½ å¿«æ¨‚å—ï¼Ÿ<span class='ab-en'>Does this truly make you happy?</span>",
    "å‚¾è½å…§åœ¨çš„è²éŸ³ã€‚<span class='ab-en'>Listen to your inner voice.</span>",
    "é€™èˆ‡ä½ çš„ææ‡¼æœ‰é—œã€‚<span class='ab-en'>It is related to your fear.</span>",
    "é‡æ–°è©•ä¼°ä½ çš„åƒ¹å€¼è§€ã€‚<span class='ab-en'>Re-evaluate your values.</span>",
    "é€™åªæ˜¯ä¸€å€‹éæ¸¡æœŸã€‚<span class='ab-en'>It is just a phase.</span>",
    "ä½ åœ¨å°‹æ‰¾å®‰å…¨æ„Ÿã€‚<span class='ab-en'>You are seeking safety.</span>",
    "é€™èˆ‡éå»æœ‰é—œã€‚<span class='ab-en'>It is about the past.</span>",
    "æ”¾ä¸‹åŸ·å¿µã€‚<span class='ab-en'>Let go of attachment.</span>",
    "ä½ éœ€è¦åŸè«’ã€‚<span class='ab-en'>You need to forgive.</span>",
    "é€™æ˜¯ä¸€å€‹å­¸ç¿’çš„æ©Ÿæœƒã€‚<span class='ab-en'>It is a learning opportunity.</span>",
    "ä½ åœ¨æ¬ºé¨™è‡ªå·±ã€‚<span class='ab-en'>You are fooling yourself.</span>",
    "é€™ä¸æ˜¯é‡é»ã€‚<span class='ab-en'>That is not the point.</span>",
    "ä½ çš„å‹•æ©Ÿæ˜¯ä»€éº¼ï¼Ÿ<span class='ab-en'>What is your motive?</span>",
    "é€™èˆ‡é‡‘éŒ¢ç„¡é—œã€‚<span class='ab-en'>It is not about money.</span>",
    "å°ˆæ³¨æ–¼ç•¶ä¸‹ã€‚<span class='ab-en'>Focus on the present.</span>",
    "é€™æ˜¯ä¸€å€‹è€ƒé©—ã€‚<span class='ab-en'>It is a test.</span>",
    "ä½ åœ¨é‡è¤‡èˆŠçš„æ¨¡å¼ã€‚<span class='ab-en'>You are repeating patterns.</span>",
    "é€™èˆ‡ä½ çš„ç«¥å¹´æœ‰é—œã€‚<span class='ab-en'>It relates to your childhood.</span>",
    "ä½ éœ€è¦ç™‚ç™’ã€‚<span class='ab-en'>You need healing.</span>",
    "é€™æ˜¯ä¸€å€‹ä¿¡è™Ÿã€‚<span class='ab-en'>This is a sign.</span>",
    "æ”¹è®Šä½ çš„è§€é»ã€‚<span class='ab-en'>Change your perspective.</span>",
    "é€™åªæ˜¯ä¸€å€‹å¹»è¦ºã€‚<span class='ab-en'>It is just an illusion.</span>",
    "ä½ éœ€è¦å‹‡æ°£ã€‚<span class='ab-en'>You need courage.</span>",
    "é€™èˆ‡ä½ çš„è‡ªå°Šæœ‰é—œã€‚<span class='ab-en'>It is about your self-esteem.</span>",
    "ä½ åœ¨å°‹æ‰¾èªåŒã€‚<span class='ab-en'>You are seeking approval.</span>",
    "é€™æ˜¯ä¸€å€‹è½‰æ©é»ã€‚<span class='ab-en'>This is a turning point.</span>",
    "é€™èˆ‡æ„›æœ‰é—œã€‚<span class='ab-en'>It is about love.</span>",
    "ä½ éœ€è¦é‡‹æ”¾æƒ…ç·’ã€‚<span class='ab-en'>Release your emotions.</span>",
    "é€™æ˜¯ä¸€å€‹å¾ªç’°ã€‚<span class='ab-en'>It is a cycle.</span>",
    "ä½ åœ¨å°‹æ‰¾æ„ç¾©ã€‚<span class='ab-en'>You are searching for meaning.</span>",
    "é€™èˆ‡è‡ªç”±æœ‰é—œã€‚<span class='ab-en'>It is about freedom.</span>",

    // --- æ¨¡ç³Šèˆ‡ç¥ç¥• (Ambiguous & Mystic) ---
    "ä¹Ÿè¨±ã€‚<span class='ab-en'>Maybe.</span>",
    "é€™å¾ˆè¤‡é›œã€‚<span class='ab-en'>It is complicated.</span>",
    "çµæœæœªå®šã€‚<span class='ab-en'>Outcome is uncertain.</span>",
    "é€™å–æ±ºæ–¼ä½ ã€‚<span class='ab-en'>It depends on you.</span>",
    "é€™æ˜¯ä¸€å€‹è¬ã€‚<span class='ab-en'>It is a mystery.</span>",
    "é€™ç„¡æ³•é æ¸¬ã€‚<span class='ab-en'>It is unpredictable.</span>",
    "ä½ éœ€è¦å†’éšªã€‚<span class='ab-en'>You need to adventure.</span>",
    "é€™æ˜¯ä¸€å€‹é©šå–œã€‚<span class='ab-en'>It is a surprise.</span>",
    "é€™æ˜¯ä¸€å€‹ç§˜å¯†ã€‚<span class='ab-en'>It is a secret.</span>",
    "é€™æ˜¯ä¸€å€‹å¥‡è¹Ÿã€‚<span class='ab-en'>It is a miracle.</span>",
    "é€™æ˜¯ä¸€å€‹é–‹å§‹ã€‚<span class='ab-en'>It is a beginning.</span>",
    "é€™æ˜¯ä¸€å€‹çµæŸã€‚<span class='ab-en'>It is an end.</span>",
    "é€™æ˜¯ä¸€å€‹å¾ªç’°ã€‚<span class='ab-en'>It is a loop.</span>",
    "é€™æ˜¯ä¸€å€‹å¤¢ã€‚<span class='ab-en'>It is a dream.</span>",
    "é€™æ˜¯ä¸€å€‹éŠæˆ²ã€‚<span class='ab-en'>It is a game.</span>",
    "é€™æ˜¯ä¸€å€‹ç¦®ç‰©ã€‚<span class='ab-en'>It is a gift.</span>",
    "é€™æ˜¯ä¸€å€‹è² æ“”ã€‚<span class='ab-en'>It is a burden.</span>",
    "é€™æ˜¯ä¸€å€‹è²¬ä»»ã€‚<span class='ab-en'>It is a responsibility.</span>",
    "é€™æ˜¯ä¸€å€‹æŒ‘æˆ°ã€‚<span class='ab-en'>It is a challenge.</span>",
    "é€™æ˜¯ä¸€å€‹æ©Ÿæœƒã€‚<span class='ab-en'>It is an opportunity.</span>",
    "é€™æ˜¯ä¸€å€‹é™·é˜±ã€‚<span class='ab-en'>It is a trap.</span>",
    "é€™æ˜¯ä¸€å€‹æ¸¬è©¦ã€‚<span class='ab-en'>It is a test.</span>",
    "é€™æ˜¯ä¸€å€‹ç©ç¬‘ã€‚<span class='ab-en'>It is a joke.</span>",
    "é€™æ˜¯ä¸€å€‹è­¦å‘Šã€‚<span class='ab-en'>It is a warning.</span>",
    "é€™æ˜¯ä¸€å€‹ç¥ç¦ã€‚<span class='ab-en'>It is a blessing.</span>",
    "é€™æ˜¯ä¸€å€‹è©›å’’ã€‚<span class='ab-en'>It is a curse.</span>",
    "é€™æ˜¯ä¸€å€‹æ‰¿è«¾ã€‚<span class='ab-en'>It is a promise.</span>",
    "é€™æ˜¯ä¸€å€‹è¬Šè¨€ã€‚<span class='ab-en'>It is a lie.</span>",
    "é€™æ˜¯ä¸€å€‹çœŸç›¸ã€‚<span class='ab-en'>It is the truth.</span>",
    "é€™æ˜¯ä¸€å€‹èª¤æœƒã€‚<span class='ab-en'>It is a misunderstanding.</span>",
    "é€™æ˜¯ä¸€å€‹å·§åˆã€‚<span class='ab-en'>It is a coincidence.</span>",
    "é€™æ˜¯ä¸€å€‹å‘½é‹ã€‚<span class='ab-en'>It is fate.</span>",
    "æ›å€‹è§’åº¦çœ‹ã€‚<span class='ab-en'>Look from another angle.</span>",
    "ä¸€ç¬‘ç½®ä¹‹ã€‚<span class='ab-en'>Laugh it off.</span>",
    "æ•¸åˆ°åã€‚<span class='ab-en'>Count to ten.</span>",
    "æ·±å‘¼å¸ã€‚<span class='ab-en'>Take a deep breath.</span>",
    "çœ‹å‘çª—å¤–ã€‚<span class='ab-en'>Look out the window.</span>",
    "æ•´ç†ä½ çš„æˆ¿é–“ã€‚<span class='ab-en'>Clean your room.</span>",
    "å–æ¯æ°´ã€‚<span class='ab-en'>Drink some water.</span>",
    "å‡ºå»èµ°èµ°ã€‚<span class='ab-en'>Go for a walk.</span>",
    "å¯«ä¸‹ä¾†ã€‚<span class='ab-en'>Write it down.</span>",
    "æŠŠå®ƒç•«å‡ºä¾†ã€‚<span class='ab-en'>Draw it out.</span>",
    "å”±é¦–æ­Œã€‚<span class='ab-en'>Sing a song.</span>",
    "è·³æ”¯èˆã€‚<span class='ab-en'>Dance.</span>",
    "ä¿æŒæ²‰é»˜ã€‚<span class='ab-en'>Stay silent.</span>",
    "å¤§è²èªªå‡ºä¾†ã€‚<span class='ab-en'>Say it out loud.</span>",
    "é–‰ä¸Šçœ¼ç›ã€‚<span class='ab-en'>Close your eyes.</span>",
    "å¼µé–‹é›™æ‰‹ã€‚<span class='ab-en'>Open your arms.</span>",
    "é€™æ²’ä»€éº¼å¤§ä¸äº†çš„ã€‚<span class='ab-en'>No big deal.</span>",
    "é€™å¾ˆé‡è¦ã€‚<span class='ab-en'>This is important.</span>",
    "é€™å¾®ä¸è¶³é“ã€‚<span class='ab-en'>It is trivial.</span>",
    "é€™æ„ç¾©é‡å¤§ã€‚<span class='ab-en'>It means a lot.</span>",
    "é€™å¾ˆå¯ç¬‘ã€‚<span class='ab-en'>It is ridiculous.</span>",
    "é€™å¾ˆåš´è‚…ã€‚<span class='ab-en'>It is serious.</span>",
    "é€™å¾ˆç°¡å–®ã€‚<span class='ab-en'>It is simple.</span>",
    "é€™å¾ˆå›°é›£ã€‚<span class='ab-en'>It is hard.</span>",

    // --- æœå°ˆå±¬å½©è›‹ (Easter Eggs) ---
    "å¦‚æœå¥‡è¹Ÿç™¼ç”Ÿäº†...<span class='ab-en'>If a miracle happened...</span>",
    "è©¦è‘—å¤–åŒ–é€™å€‹å•é¡Œã€‚<span class='ab-en'>Externalize the problem.</span>",
    "ä½ çš„ä¾‹å¤–ç¶“é©—åœ¨å“ªè£¡ï¼Ÿ<span class='ab-en'>Where are your exceptions?</span>",
    "é€™æ˜¯ä¸€å€‹ç¨ç‰¹çµæœã€‚<span class='ab-en'>This is a unique outcome.</span>",
    "ç…§é¡§å¥½ä½ çš„å…§åœ¨å°å­©ã€‚<span class='ab-en'>Care for your inner child.</span>",
    "é€™éœ€è¦ç³»çµ±è§€ã€‚<span class='ab-en'>Think systemically.</span>",
    "åˆ¥å¿˜äº†ä½ çš„åˆè¡·ã€‚<span class='ab-en'>Remember why you started.</span>",
    "é€™ä¹Ÿæ˜¯ä¸€ç¨®è¤‡åˆ©æ•ˆæ‡‰ã€‚<span class='ab-en'>This is compound interest.</span>",
    "ä½ çš„è‚Œè‚‰è¨˜å¾—ã€‚<span class='ab-en'>Your muscles remember.</span>",
    "é€™éœ€è¦åˆ»æ„ç·´ç¿’ã€‚<span class='ab-en'>It takes deliberate practice.</span>",
    "é€™æ˜¯ä½ çš„è‹±é›„ä¹‹æ—…ã€‚<span class='ab-en'>This is your Hero's Journey.</span>",
    "ä½ çš„æ•…äº‹ç”±ä½ æ”¹å¯«ã€‚<span class='ab-en'>Rewrite your story.</span>"
];

    // 2. éŸ³æ•ˆ
    const flipSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2411/2411-preview.mp3');
    flipSound.volume = 0.5;

    // 3. æ¸²æŸ“ HTML (åŒ…å«å¯¦é«”å°åº•)
    contentArea.innerHTML = `
        <div class="ab-container" id="ab-container">
            
            <div class="ab-book" id="ab-book">
                <div class="ab-spine"><span class="ab-spine-text">THE BOOK OF ANSWERS</span></div>

                <div class="ab-cover-group">
                    <div class="ab-cover-front" id="ab-cover-front">
                        <div class="ab-shine"></div>
                        <div class="ab-star-icon">
                            <svg viewBox="0 0 100 100" fill="none" stroke="#c9a227" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M50 0 L50 10 M50 90 L50 100 M0 50 L10 50 M90 50 L100 50 M15 15 L22 22 M78 78 L85 85 M15 85 L22 78 M78 22 L85 15" stroke-opacity="0.6" stroke-width="1.5" />
                                <circle cx="50" cy="50" r="42" stroke-width="0.5" stroke-dasharray="2 2" />
                                <circle cx="50" cy="50" r="38" stroke-width="1.2" />
                                <path d="M50 18 L78 68 L22 68 Z" stroke-opacity="0.9" />
                                <path d="M50 82 L22 32 L78 32 Z" stroke-opacity="0.9" />
                                <path d="M35 50 Q50 35 65 50 Q50 65 35 50 Z" fill="rgba(201,162,39,0.1)" stroke-width="1.5"/>
                                <circle cx="50" cy="50" r="6" fill="#c9a227" stroke="none" />
                                <circle cx="50" cy="50" r="2" fill="#fff" stroke="none" />
                                <circle cx="50" cy="50" r="14" stroke-opacity="0.5" stroke-dasharray="1 3"/>
                            </svg>
                        </div>
                        <div class="ab-cover-title-en">The Book<br>of Answers</div>
                        <div class="ab-cover-title-zh">é»˜å¿µå•é¡Œ Â· è¼•è§¸æ­ç¤º</div>
                    </div>
                    <div class="ab-cover-back"></div>
                </div>

                <div class="ab-cover-exterior-back"></div>

                <div class="ab-pages">
                    <div class="ab-pages-top"></div>
                    <div class="ab-pages-bottom"></div>
                    <div class="ab-content-box" id="ab-content-box">
                        <div class="ab-answer-text" id="ab-text">...</div>
                    </div>
                </div>
            </div>
            
            <div class="ab-hint">é»æ“Šæ›¸æœ¬ç¿»é </div>
        </div>
    `;

    // 4. è®Šæ•¸
    const abContainer = document.getElementById('ab-container'); 
    const book = document.getElementById('ab-book');
    const textEl = document.getElementById('ab-text');
    const contentBox = document.getElementById('ab-content-box');
    let lastIndex = -1;

    // --- A. è¦–å·®æ‡¸æµ® & å‹•æ…‹å…‰ç…§ ---
    const handleParallax = (clientX, clientY) => {
        if (book.classList.contains('is-open')) return;

        const x = clientX - window.innerWidth / 2;
        const y = clientY - window.innerHeight / 2;

        // ğŸ”¥ è¦–å·® X/3 å›æ­¸ï¼šå› ç‚ºæœ‰å°åº•ï¼Œç¾åœ¨å¯ä»¥æ”¾å¿ƒå¤§è†½è½‰ï¼
        const rotateY = x / 3; 
        const rotateX = -y / 15; 

        book.style.setProperty('--rY', rotateY + 'deg');
        book.style.setProperty('--rX', rotateX + 'deg');

        const rect = book.getBoundingClientRect();
        const lightX = ((clientX - rect.left) / rect.width) * 100;
        const lightY = ((clientY - rect.top) / rect.height) * 100;
        book.style.setProperty('--light-x', lightX + '%');
        book.style.setProperty('--light-y', lightY + '%');
    };

    abContainer.addEventListener('mousemove', (e) => {
        handleParallax(e.clientX, e.clientY);
    });

    // æ‰‹æ©Ÿè§¸æ§
    abContainer.addEventListener('touchmove', (e) => {
        e.preventDefault(); 
        if (e.touches.length > 0) {
            handleParallax(e.touches[0].clientX, e.touches[0].clientY);
        }
    }, { passive: false });

    // --- B. äº’å‹•é‚è¼¯ ---
    const playFlipSound = () => {
        if (typeof isSfxOn !== 'undefined' && isSfxOn) {
            flipSound.currentTime = 0;
            flipSound.play().catch(()=>{});
        }
    };

    book.addEventListener('click', () => {
        if (navigator.vibrate) navigator.vibrate(20);

        if (book.classList.contains('is-open')) {
            // --- é—œæ›¸ ---
            book.classList.remove('is-open');
            
            // é‡ç½®è¦–å·®
            book.style.setProperty('--rY', '0deg');
            book.style.setProperty('--rX', '0deg');
            
            if (typeof isSfxOn !== 'undefined' && isSfxOn) {
                flipSound.currentTime = 0;
                flipSound.playbackRate = 1.3;
                flipSound.play().catch(()=>{});
            }
            
            // ç­‰å¾…æ›¸è“‹ä¸Šå¾Œæ¸…ç©º (å¢¨æ°´æ¶ˆå¤±)
            setTimeout(() => { 
                contentBox.classList.remove('ab-text-reveal');
                textEl.innerHTML = '...'; 
            }, 1800); 

        } else {
            // --- é–‹æ›¸ ---
            flipSound.playbackRate = 1.0;
            playFlipSound(); 

            let randomIndex;
            if (ab_answers.length > 1) {
                do { randomIndex = Math.floor(Math.random() * ab_answers.length); } while (randomIndex === lastIndex);
            } else { randomIndex = 0; }
            lastIndex = randomIndex;
            
            textEl.innerHTML = ab_answers[randomIndex];
            
            // ğŸ”¥ å¢¨æ°´æµ®ç¾ (é…åˆ CSS çš„å»¶é²è¨­å®š)
            contentBox.classList.add('ab-text-reveal');
            
            book.classList.add('is-open');
        }
    });
},
    // é è¨­ç•«é¢ (çµ¦å…¶ä»–é‚„æ²’åšå¥½çš„åŠŸèƒ½ç”¨)
    renderDefault: (container) => {
        container.innerHTML = `
             <p style="font-size: 1.1rem; color: var(--text-sub);">âœ¨ è¼•è¼•åœ°å¸æ°£ï¼Œæ…¢æ…¢åœ°åæ°£ âœ¨</p>
             <p style="font-size: 0.9rem; color: #CCC; margin-top:10px;">(æ­¤åŠŸèƒ½å»ºç½®ä¸­)</p>
        `;
    }
};

/* =========================================
   2. ä¿®æ”¹åŸæœ¬çš„ openFeature å‡½å¼ (æ ¸å¿ƒå¤§è…¦)
   ========================================= */
/* --- æ”¾åœ¨åŸæœ¬çš„ openFeature é™„è¿‘ --- */

// å…¨åŸŸè®Šæ•¸ï¼šç”¨ä¾†è¨˜éŒ„ç•¶å‰åŠŸèƒ½æ˜¯å¦æœ‰ã€Œå…§éƒ¨è¿”å›ã€çš„éœ€æ±‚
    const modal = document.getElementById('active-feature-container');
    const featureTitle = document.getElementById('feature-title-display');
    const contentArea = document.getElementById('feature-content-area');
window.currentFeatureBack = null; 

function openFeature(feature) {


    // 1. æ‰“é–‹è¦–çª— & é–å®šèƒŒæ™¯æ»‘å‹• (é—œéµï¼é˜²æ­¢ç ´åœ–)
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // é–æ­»ä¸»é é¢æ²å‹•
    document.body.style.position = 'fixed';  // å¼·åˆ¶å›ºå®š iOS
    document.body.style.width = '100%';

    // 2. è¨­å®šæ¨™é¡Œ
    featureTitle.innerText = feature.name;
    
    // 3. å‘½åè½‰æ› (answer_book -> renderAnswerBook)
    const featureName = feature.id
        .toLowerCase()
        .replace(/_(\w)/g, (all, letter) => letter.toUpperCase())
        .replace(/^\w/, c => c.toUpperCase());
    const targetRendererName = `render${featureName}`;

    // 4. é‡ç½®å…§éƒ¨è¿”å›é‚è¼¯ (æ¯æ¬¡æ‰“é–‹æ–°åŠŸèƒ½éƒ½å…ˆæ¸…ç©º)
    window.currentFeatureBack = null; 

    // 5. åŸ·è¡Œæ¸²æŸ“
    if (typeof renderers[targetRendererName] === 'function') {
        renderers[targetRendererName](contentArea);
    } else {
        renderers.renderDefault(contentArea);
    }

    // 6. å¯«å…¥æ­·å²ç´€éŒ„ (è®“æ‰‹æ©ŸæŒ‰è¿”å›éµæœ‰åæ‡‰)
    // é€™è£¡æˆ‘å€‘æ¨å…¥ä¸€å€‹å¸¶æœ‰æ¨™è¨˜çš„ state
    history.pushState({ type: 'feature_modal', featureId: feature.id }, null, `#${feature.id}`);
}

/* --- ä¿®æ”¹åŸæœ¬çš„ popstate ç›£è½å™¨ --- */
window.addEventListener('popstate', function(event) {
    const modal = document.getElementById('active-feature-container');
    const settingsModal = document.getElementById('settings-modal');

    // 1. å¦‚æœè¨­å®šé é¢é–‹è‘—ï¼Œå„ªå…ˆé—œé–‰
    if (settingsModal && settingsModal.classList.contains('show')) {
        settingsModal.classList.remove('show');
        setTimeout(() => { settingsModal.style.display = 'none'; }, 300);
        return; // çµæŸï¼Œä¸ç¹¼çºŒå¾€ä¸‹
    }

    // 2. å¦‚æœåŠŸèƒ½è¦–çª—é–‹è‘—
    if (modal.style.display === 'flex') {
        // [é—œéµé‚è¼¯] è©¢å•ç•¶å‰åŠŸèƒ½ï¼šã€Œä½ å…§éƒ¨é‚„æœ‰æ­¥é©Ÿè¦é€€å›å—ï¼Ÿã€
        // å¦‚æœ currentFeatureBack å­˜åœ¨ä¸”å›å‚³ trueï¼Œè¡¨ç¤ºå®ƒåœ¨å…§éƒ¨é€€äº†ä¸€æ­¥ï¼ˆä¾‹å¦‚å¾æŠ½å¡é€€å›é¸å¡åŒ…ï¼‰
        // é€™æ™‚æˆ‘å€‘å°±ä¸é—œé–‰è¦–çª—ã€‚
        if (window.currentFeatureBack && window.currentFeatureBack()) {
            // ç‚ºäº†ä¿æŒç€è¦½å™¨æ­·å²å †ç–Šæ­£ç¢ºï¼Œæˆ‘å€‘è¦åœ¨é€™è£¡ã€ŒæŠŠå‰›å‰›è¢« pop æ‰çš„ç‹€æ…‹æ¨å›å»ã€
            // é€™æ¨£ä½¿ç”¨è€…ä¸‹æ¬¡æŒ‰è¿”å›éµæ™‚ï¼Œæ‰èƒ½å†æ¬¡è§¸ç™¼ popstate
            history.pushState({ type: 'feature_modal' }, null, location.hash);
            return;
        }

        // å¦‚æœåŠŸèƒ½èªªã€Œæ²’äº†ï¼Œæˆ‘å·²ç¶“åœ¨ç¬¬ä¸€é äº†ã€ï¼Œé‚£å°±åŸ·è¡Œé—œé–‰è¦–çª—
        closeFeatureModal();
    }
});

/* === ä¿®å¾©å¾Œçš„é—œé–‰å‡½å¼ (è§£æ±ºä¸»é å¡æ­»å•é¡Œ) === */
function closeFeatureModal() {
    const modal = document.getElementById('active-feature-container');
    const contentArea = document.getElementById('feature-content-area');
    
    // 1. éš±è—è¦–çª—
    modal.style.display = 'none';
    
    // 2. æ¸…ç©ºå…§å®¹ (ç¯€çœæ•ˆèƒ½)
    contentArea.innerHTML = ''; 
    
    // 3. é‡ç½®è¿”å›é‚è¼¯è®Šæ•¸
    window.currentFeatureBack = null;

    // 4. â˜… é—œéµä¿®å¾©ï¼šå¼·åˆ¶è§£é™¤ Body çš„é–å®šç‹€æ…‹ â˜…
    document.body.style.overflow = 'auto';      // æ¢å¾©æ²å‹•
    document.body.style.position = 'static';    // è§£é™¤å®šä½é–å®š
    document.body.style.width = '';             // ç§»é™¤å¯¬åº¦é™åˆ¶
    document.body.style.height = '';            // ç§»é™¤é«˜åº¦é™åˆ¶
    document.body.style.touchAction = 'auto';   // æ¢å¾©è§¸æ§è¡Œç‚º
}

// --- ç¶å®š UI ä¸Šçš„ã€Œé—œé–‰æŒ‰éˆ• (X)ã€é‚è¼¯ ---
/* === ä¿®æ­£å¾Œçš„ X æŒ‰éˆ•ç¶å®šé‚è¼¯ === */
// è«‹ç¢ºä¿é€™è£¡çš„ ID è·Ÿä½ çš„ HTML ä¸€æ¨£ (çœ‹æ˜¯ feature-close-btn é‚„æ˜¯ close-feature-btn)
const uiCloseBtn = document.getElementById('feature-close-btn') || document.getElementById('close-feature-btn');

if (uiCloseBtn) {
    uiCloseBtn.onclick = function() {
        // â˜… é—œéµä¿®æ­£ 1ï¼šå…ˆå»¢é™¤ã€Œå…§éƒ¨è¿”å›é‚è¼¯ã€
        // é€™æ¨£ç­‰ç­‰è§¸ç™¼ history.back() æ™‚ï¼Œpopstate ç›£è½å™¨å°±ä¸æœƒæ””æˆªæˆ‘å€‘
        window.currentFeatureBack = null; 

        // â˜… é—œéµä¿®æ­£ 2ï¼šæª¢æŸ¥æ­·å²ç´€éŒ„
        if (history.state && history.state.type === 'feature_modal') {
            history.back(); // é€™æœƒè§¸ç™¼ popstateï¼Œä½†å› ç‚ºä¸Šé¢è¨­ç‚º null äº†ï¼Œæ‰€ä»¥æœƒæˆåŠŸé—œé–‰
        } else {
            closeFeatureModal(); // å¦‚æœæ²’ç´€éŒ„ï¼Œç›´æ¥æš´åŠ›é—œé–‰
        }
    };
}


        // ============================================
        // 3. éºµåœ˜ç²¾éˆç³»çµ±
        // ============================================
        
        let petMoveInterval;
        let isDragging = false;
        let audioCtx = null;
        let speechTimeout;
        let lastInteractionTime = 0;

        const comfortMessages = [
            'è¨˜å¾—å–æ°´å–” <span class="kaomoji">( Ë˜ Â³Ë˜)â™¥</span>', 
            'æ·±å‘¼å¸ï½ <span class="kaomoji">( Â´ â–½ ` )ï¾‰</span>', 
            'æˆ‘åœ¨é€™è£¡é™ªä½  <span class="kaomoji">(Â´â€¢ Ï‰ â€¢`)</span>', 
            'ä½ åšå¾—å¾ˆå¥½ <span class="kaomoji">(à¹‘â€¢Ì€ã…‚â€¢Ì)Ùˆâœ§</span>', 
            'ä¼‘æ¯ä¸€ä¸‹å§ <span class="kaomoji">_(:3 ã€âˆ  )_</span>', 
            'æ…¢æ…¢ä¾† <span class="kaomoji">(ãƒ»âˆ€ãƒ»)</span>', 
            'æ”¾è¼•é¬†ï½ <span class="kaomoji">(ï¿£â–½ï¿£)~*</span>', 
            'æ„Ÿå—ç•¶ä¸‹ <span class="kaomoji">(âÂ´â—¡`â)</span>', 
            'æŠ±æŠ± <span class="kaomoji">(ã¤Â´Ï‰`)ã¤</span>'
        ];

        function initPetSystem() {
            const savedX = localStorage.getItem('petX');
            const savedY = localStorage.getItem('petY');
            
            if (savedX && savedY) {
                petEl.style.left = savedX + 'px';
                petEl.style.top = savedY + 'px';
            } else {
                petEl.style.left = (window.innerWidth - 100) + 'px';
                petEl.style.top = '100px';
            }

            setupPetInteraction();
            updatePetVisibility();
            if (isPetActive) startPetBehavior();
        }

        function updatePetVisibility() {
            if (isPetActive) {
                petEl.style.display = 'block';
                startPetBehavior();
                showSpeech('æˆ‘å›ä¾†äº†ï¼', 2000);
            } else {
                petEl.style.display = 'none';
                stopPetBehavior();
            }
        }

        function startPetBehavior() {
            clearInterval(petMoveInterval);
            petMoveInterval = setInterval(() => {
                if(!isDragging) movePetRandomly();
            }, 12000);
        }

        function stopPetBehavior() {
            clearInterval(petMoveInterval);
        }

        function movePetRandomly() {
            petEl.classList.add('auto-moving');
            const maxX = window.innerWidth - 90;
            const maxY = window.innerHeight - 90;
            const randomX = Math.max(20, Math.random() * maxX);
            const randomY = Math.max(80, Math.random() * maxY);

            petEl.style.left = randomX + 'px';
            petEl.style.top = randomY + 'px';

            localStorage.setItem('petX', randomX);
            localStorage.setItem('petY', randomY);
        }

        function setupPetInteraction() {
            let startX, startY, initialLeft, initialTop, moveDistance = 0;

            const startDrag = (e) => {
                if(!isPetActive) return;
                isDragging = true;
                petEl.classList.remove('auto-moving'); 
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                startX = clientX; startY = clientY;
                initialLeft = petEl.offsetLeft; initialTop = petEl.offsetTop;
                moveDistance = 0;
                resumeAudioContext(); 
            };

            const doDrag = (e) => {
                if (!isDragging) return;
                e.preventDefault(); 
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                const dx = clientX - startX;
                const dy = clientY - startY;
                moveDistance += Math.abs(dx) + Math.abs(dy);
                petEl.style.left = (initialLeft + dx) + 'px';
                petEl.style.top = (initialTop + dy) + 'px';
            };

            const endDrag = (e) => {
                if (!isDragging) return;
                isDragging = false;
                localStorage.setItem('petX', parseInt(petEl.style.left));
                localStorage.setItem('petY', parseInt(petEl.style.top));
                if (moveDistance < 10) {
                    const now = Date.now();
                    if (now - lastInteractionTime > 300) { 
                        triggerInteraction();
                        lastInteractionTime = now;
                    }
                }
            };
            petEl.addEventListener('mousedown', startDrag);
            window.addEventListener('mousemove', doDrag);
            window.addEventListener('mouseup', endDrag);
            petEl.addEventListener('touchstart', startDrag, {passive: false});
            window.addEventListener('touchmove', doDrag, {passive: false});
            window.addEventListener('touchend', endDrag);
        }

        function triggerInteraction() {
            if (navigator.vibrate) navigator.vibrate(50);
            if (isSfxOn) playExhaleSound();
            const body = petEl.querySelector('.pet-svg-body');
            body.classList.remove('pet-shake');
            void petEl.offsetWidth; 
            body.classList.add('pet-shake');
            const msg = comfortMessages[Math.floor(Math.random() * comfortMessages.length)];
            showSpeech(msg, 3500);
        }

        function showSpeech(text, duration) {
            if (speechTimeout) clearTimeout(speechTimeout);
            const petSpeech = document.getElementById('pet-speech');
            petSpeech.innerHTML = text; 
            petSpeech.classList.add('show');
            speechTimeout = setTimeout(() => {
                petSpeech.classList.remove('show');
            }, duration);
        }

        // ============================================
        // 4. éŸ³æ•ˆç³»çµ± (Audio System)
        // ============================================

        let bgmTimeout;
        let lastFreq = 220; 
        const scaleFreqs = [130.81, 146.83, 164.81, 196.00, 220.00, 261.63, 293.66, 329.63, 392.00, 440.00];

        function resumeAudioContext() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playExhaleSound() {
            if(!isSfxOn) return;
            resumeAudioContext();
            const duration = 4.0; 
            const bufferSize = audioCtx.sampleRate * duration;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(400, audioCtx.currentTime);
            filter.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + duration);
            const gainNode = audioCtx.createGain();
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.15, audioCtx.currentTime + 0.5); 
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration); 
            noise.connect(filter); filter.connect(gainNode); gainNode.connect(audioCtx.destination);
            noise.start(); noise.stop(audioCtx.currentTime + duration);
        }

        function playNextNote() {
            if (!isMusicOn) return;
            resumeAudioContext();

            // é¸æ“‡éŸ³é«˜é‚è¼¯
            let possibleIndices = [];
            const currentIdx = scaleFreqs.indexOf(lastFreq);
            [-2, -1, 1, 2].forEach(step => {
                const idx = currentIdx + step;
                if (idx >= 0 && idx < scaleFreqs.length) possibleIndices.push(idx);
            });
            if (possibleIndices.length === 0) possibleIndices = [3, 4, 5, 6];
            const nextIdx = possibleIndices[Math.floor(Math.random() * possibleIndices.length)];
            const freq = scaleFreqs[nextIdx];
            lastFreq = freq;

            // ç”¢ç”Ÿè²éŸ³
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const filter = audioCtx.createBiquadFilter(); 
            osc.type = 'triangle';
            osc.frequency.value = freq;
            filter.type = 'lowpass';
            filter.frequency.value = 400; 
            const now = audioCtx.currentTime;
            const duration = 10.0; 
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.08, now + 1.0); 
            gain.gain.exponentialRampToValueAtTime(0.001, now + duration); 
            osc.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(now + duration);

            // é ç´„ä¸‹ä¸€å€‹éŸ³ (éš¨æ©Ÿ +1ç§’é‚è¼¯å·²åŒ…å«)
            const nextTime = 2000 + Math.random() * 1500;
            bgmTimeout = setTimeout(playNextNote, nextTime);
        }

        // å•Ÿå‹•
        initApp();
        
    </script>
</body>
</html>