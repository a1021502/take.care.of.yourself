<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¿ƒéˆæ€¥æ•‘ç®±</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg viewBox='0 0 100 100' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M50 15C30 15 10 30 10 60C10 85 25 95 50 95C75 95 90 85 90 60C90 30 70 15 50 15Z' fill='%23FFFFFF' stroke='%23E0E0E0' stroke-width='3'/%3E%3Ccircle cx='35' cy='55' r='4' fill='%235C5552'/%3E%3Ccircle cx='65' cy='55' r='4' fill='%235C5552'/%3E%3Ccircle cx='28' cy='62' r='3' fill='%23FFD1DC' opacity='0.8'/%3E%3Ccircle cx='72' cy='62' r='3' fill='%23FFD1DC' opacity='0.8'/%3E%3C/svg%3E">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        /* --- ğŸ¨ è¦–è¦ºé¢¨æ ¼ --- */
        :root {
            --primary: #7A9F6E;
            --primary-dark: #58754F;
            --primary-light: #EBF2EA;
            --bg: #FCFAF7;
            --card-bg: #FFFFFF;
            --text-main: #5C5552;
            --text-sub: #9E9894;
            --accent-warm: #D67D68;
            --radius-box: 24px;
            --radius-btn: 16px;
            --shadow-soft: 0 8px 20px rgba(122, 159, 110, 0.15);
        }

        body {
            font-family: "Zen Maru Gothic", sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 24px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            line-height: 1.6;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        header { text-align: center; margin-bottom: 24px; margin-top: 50px; }
        h1 { font-weight: 900; font-size: 2.4rem; margin: 0; color: var(--primary); letter-spacing: 1px; }
        p.subtitle { font-size: 1rem; color: var(--text-sub); margin-top: 5px; font-weight: 500; }

        /* --- ğŸ” æœå°‹æ¬„ --- */
        .search-container { width: 100%; max-width: 500px; margin-bottom: 24px; }
        #search-input {
            width: 100%; padding: 16px 24px; border-radius: 50px;
            border: 2px solid white; background: white;
            font-size: 1rem; font-family: "Zen Maru Gothic", sans-serif; font-weight: 700;
            color: var(--text-main); outline: none;
            box-shadow: var(--shadow-soft); box-sizing: border-box;
            transition: all 0.3s;
        }
        #search-input:focus { border-color: var(--primary); }
        #search-input::placeholder { color: #D1CEC7; font-weight: 500; }

        /* --- ğŸš‘ æƒ…ç·’å¿«ç¯©å€ --- */
        .triage-section {
            width: 100%; max-width: 500px;
            background: var(--primary-light);
            padding: 24px; padding-bottom: 30px;
            border-radius: var(--radius-box);
            margin-bottom: 32px;
            position: relative;
            box-sizing: border-box;
            box-shadow: inset 0 0 0 2px rgba(255,255,255,0.5);
        }
        .triage-title { 
            font-size: 1.1rem; margin-bottom: 16px; 
            color: var(--primary-dark); font-weight: 900; text-align: center; 
        }

        /* æƒ…ç·’æŒ‰éˆ• Grid æ”¹ç‰ˆ */
        .mood-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr; /* 3æ¬„æ¯”è¼ƒå¥½çœ‹åœ– */
            gap: 12px; margin-bottom: 10px;
        }
        
        .mood-card {
            background: white; border: 3px solid transparent; 
            color: var(--text-main);
            padding: 10px 5px; border-radius: var(--radius-btn);
            cursor: pointer; transition: all 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 4px 0 rgba(0,0,0,0.05);
            height: 110px;
        }
        .mood-card:active { transform: translateY(4px); box-shadow: none; }
        .mood-card.active {
            background: #FFF; /* ä¿æŒç™½è‰²åº•ï¼Œçªé¡¯é‚Šæ¡† */
            transform: translateY(2px);
            box-shadow: inset 0 3px 5px rgba(0,0,0,0.1);
        }
        
        .mood-icon-svg { width: 60px; height: 60px; margin-bottom: 5px; }
        .mood-label { font-size: 0.85rem; font-weight: 700; line-height: 1.2; text-align: center;}

        /* --- ğŸ› ï¸ å·¥å…·ç®±åˆ—è¡¨ --- */
        .toolbox-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
            width: 100%; max-width: 500px; padding-bottom: 40px;
        }
        .feature-card {
            background: var(--card-bg); border-radius: var(--radius-box);
            padding: 20px 10px; display: flex; flex-direction: column;
            align-items: center; justify-content: flex-start; text-align: center;
            box-shadow: var(--shadow-soft); cursor: pointer;
            transition: transform 0.2s; height: 160px; position: relative;
            overflow: hidden; /* é˜²æ­¢å‹•ç•«è·‘å‡ºå» */
        }
        .feature-card:active { transform: scale(0.96); }
        
        /* æ–°çš„åœ–ç¤ºå®¹å™¨ */
        .card-visual { 
            width: 90px; height: 90px; 
            margin-bottom: 10px; 
            position: relative;
        }
        .feature-svg { width: 100%; height: 100%; }

        .card-title { font-size: 1.1rem; color: var(--text-main); font-weight: 700; margin-bottom: 2px;}
        .card-tag { font-size: 0.8rem; color: #B0B0B0; font-weight: 500; }
        
        /* æ”¶è—æŒ‰éˆ• (åŸæ¨£) */
        .card-fav-btn {
            position: absolute; top: 10px; right: 10px;
            font-size: 1.2rem; color: #EEE; padding: 8px;
            z-index: 5; transition: color 0.3s;
        }
        .card-fav-btn.is-active { color: var(--accent-warm); }

        /* æ”¶è—èˆ‡é‡ç½® (åŸæ¨£) */
        .fav-fab-container { position: absolute; bottom: -15px; right: 15px; z-index: 10; }
        .fav-fab {
            width: 70px; height: 70px;
            background-color: white; color: var(--accent-warm);
            border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 6px 15px rgba(122, 159, 110, 0.2);
            cursor: pointer; transition: all 0.2s;
            border: 3px solid white;
        }
        .fav-fab:active { transform: scale(0.9); }
        .fav-fab.active { background-color: var(--accent-warm); color: white; transform: scale(0.95); }
        .fav-icon { font-size: 1.4rem; line-height: 1; margin-bottom: 2px; }
        .fav-text { font-size: 0.75rem; font-weight: 900; line-height: 1; }

        /* --- ğŸ“± Modal --- */
        #active-feature-container {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg); z-index: 1000;
            display: none; flex-direction: column; padding: 24px;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header { display: flex; justify-content: flex-end; margin-bottom: 40px; }
        .close-btn {
            padding: 10px 20px; background: #EBEAE6; border-radius: 20px;
            border: none; cursor: pointer; font-family: "Zen Maru Gothic", sans-serif;
            font-weight: 700; color: var(--text-main);
        }

        /* --- â˜ï¸ éºµåœ˜ç²¾éˆç³»çµ± + éŸ³æ¨‚æ§åˆ¶ --- */
        .controls-wrapper {
            position: fixed; top: 20px; left: 20px; z-index: 2000;
            display: flex; flex-direction: column; gap: 10px; align-items: flex-start;
        }

        .sys-btn {
            display: flex; align-items: center; gap: 8px;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(5px);
            padding: 6px 14px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            cursor: pointer; transition: all 0.2s;
            border: 1px solid rgba(0,0,0,0.05);
            -webkit-user-select: none; user-select: none;
        }
        .sys-btn:active { transform: scale(0.95); }
        .sys-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;}
        .sys-text { font-size: 0.85rem; font-weight: 700; color: var(--primary); }
        .sys-btn.off { opacity: 0.6; grayscale: 1; }

        /* ç²¾éˆæœ¬é«” */
        #spirit-pet {
            position: fixed; width: 80px; height: 80px; z-index: 2001;
            cursor: grab; touch-action: none; display: none;
            -webkit-tap-highlight-color: transparent;
        }
        #spirit-pet:active { cursor: grabbing; }
        #spirit-pet.auto-moving { transition: top 3s ease-in-out, left 3s ease-in-out; }
        .pet-svg-body {
            width: 100%; height: 100%;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.15));
            animation: petFloat 4s ease-in-out infinite;
        }
        @keyframes petFloat {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-6px) scale(1.03); }
        }
        .pet-shake { animation: shake 0.4s ease-in-out; }
        @keyframes shake {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            50% { transform: rotate(10deg); }
            75% { transform: rotate(-5deg); }
            100% { transform: rotate(0deg); }
        }
        .pet-speech-bubble {
            position: absolute; top: -60px; left: 50%;
            transform: translateX(-50%) scale(0);
            background: white; padding: 10px 16px; border-radius: 18px;
            font-size: 0.9rem; color: var(--text-main); font-weight: 700;
            white-space: nowrap; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            opacity: 0; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none; border: 2px solid var(--primary-light); z-index: 2002;
        }
        .pet-speech-bubble::after {
            content: ''; position: absolute; bottom: -8px; left: 50%;
            transform: translateX(-50%); border-width: 8px 8px 0; border-style: solid;
            border-color: white transparent transparent transparent;
        }
        .pet-speech-bubble.show { transform: translateX(-50%) scale(1); opacity: 1; top: -75px; }
        .kaomoji { font-family: "Arial", sans-serif; font-weight: normal; display: inline-block; }

        /* --- SVG å‹•ç•«é—œéµå½±æ ¼ (å…¨åŸŸ) --- */
        @keyframes blink { 0%, 90%, 100% { transform: scaleY(1); } 95% { transform: scaleY(0.1); } }
        @keyframes sway { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        @keyframes breathe { 0%, 100% { transform: scale(0.95); } 50% { transform: scale(1.05); } }
        @keyframes floatItem { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes spinEye { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes tearDrop { 0% { opacity: 0; transform: translateY(0); } 50% { opacity: 1; } 100% { opacity: 0; transform: translateY(10px); } }
        @keyframes panicWave { 0%, 100% { transform: rotate(-20deg); } 50% { transform: rotate(20deg); } }
        @keyframes muscleFlex { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        @keyframes lidOpen { 0%, 100% { transform: rotate(0); } 50% { transform: rotate(-20deg) translateY(-5px); } }
        @keyframes conveyorMove { 0% { transform: translateX(0); opacity: 1; } 100% { transform: translateX(40px); opacity: 0; } }
        @keyframes pulseRed { 0%, 100% { fill: #FF6B6B; } 50% { fill: #FF0000; } }

    </style>
</head>
<body>

    <div class="controls-wrapper">
        <div class="sys-btn" id="pet-toggle-btn">
            <div class="sys-icon">
                <svg viewBox="0 0 100 100" fill="none" style="width:20px;height:20px;">
                    <path d="M50 20C30 20 10 35 10 60C10 85 25 95 50 95C75 95 90 85 90 60C90 35 70 20 50 20Z" fill="#FFFFFF" stroke="#CCCCCC" stroke-width="8"/>
                    <circle cx="35" cy="55" r="5" fill="#5C5552"/>
                    <circle cx="65" cy="55" r="5" fill="#5C5552"/>
                </svg>
            </div>
            <div class="sys-text" id="pet-toggle-label">å¬å–šéºµåœ˜</div>
        </div>
        <div class="sys-btn" id="music-toggle-btn">
            <div class="sys-icon" id="music-icon">ğŸµ</div>
            <div class="sys-text" id="music-label">èƒŒæ™¯éŸ³æ¨‚</div>
        </div>
    </div>

    <div id="spirit-pet">
        <div class="pet-speech-bubble" id="pet-speech">å˜¿å’»ï¼<span class="kaomoji">( >Ï‰&lt;)</span></div>
        <div class="pet-svg-body">
            <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M50 15C30 15 10 30 10 60C10 85 25 95 50 95C75 95 90 85 90 60C90 30 70 15 50 15Z" fill="#FFFFFF" stroke="#E0E0E0" stroke-width="3"/>
                <circle cx="35" cy="55" r="4" fill="#5C5552">
                    <animate attributeName="ry" values="4;0.5;4" dur="3s" repeatCount="indefinite" />
                </circle>
                <circle cx="65" cy="55" r="4" fill="#5C5552">
                    <animate attributeName="ry" values="4;0.5;4" dur="3s" repeatCount="indefinite" />
                </circle>
                <circle cx="28" cy="62" r="3" fill="#FFD1DC" opacity="0.6"/>
                <circle cx="72" cy="62" r="3" fill="#FFD1DC" opacity="0.6"/>
            </svg>
        </div>
    </div>

    <header>
        <h1>Safe Space</h1>
        <p class="subtitle">åœ¨é€™è£¡ï¼Œä½ ä¸éœ€è¦å‹‰å¼·è‡ªå·±ã€‚</p>
    </header>

    <div class="search-container">
        <input type="text" id="search-input" placeholder="ğŸ” æœå°‹ï¼šå¡”ç¾…ã€å‘¼å¸ã€è¿·æƒ˜...">
    </div>

    <section class="triage-section">
        <div class="triage-title">ç¾åœ¨çš„å¿ƒæƒ…åƒä»€éº¼å¤©æ°£ï¼Ÿ</div>
        <div class="mood-grid" id="mood-grid-container">
            </div>
        <div style="text-align:center; margin-top:15px; font-size:0.9rem; color:var(--text-sub); cursor:pointer; text-decoration:underline;" onclick="resetAllFilters()">
            é¡¯ç¤ºå…¨éƒ¨åŠŸèƒ½
        </div>
        
        <div class="fav-fab-container" onclick="toggleFavFilter()">
            <div class="fav-fab" id="fav-fab-btn">
                <div class="fav-icon">â¤</div>
                <div class="fav-text">æ”¶è—</div>
            </div>
        </div>
    </section>

    <section class="toolbox-grid" id="toolbox">
        </section>

    <div id="active-feature-container">
        <div class="modal-header">
            <button class="close-btn" onclick="history.back()">é—œé–‰ âœ•</button>
        </div>
        <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <h2 id="feature-title-display" style="text-align: center; font-size: 2rem; color: var(--primary); margin-bottom: 20px; font-weight:900;">åŠŸèƒ½åç¨±</h2>
            <div id="feature-content-area" style="text-align: center;">
                <p style="font-size: 1.1rem; color: var(--text-sub);">âœ¨ è¼•è¼•åœ°å¸æ°£ï¼Œæ…¢æ…¢åœ°åæ°£ âœ¨</p>
                <p style="font-size: 0.9rem; color: #CCC; margin-top:10px;">(åŠŸèƒ½å»ºç½®ä¸­)</p>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // 1. è³‡æ–™åº« (SVG æ¸²æŸ“å¼•æ“)
        // ============================================

        // å…±ç”¨çš„éºµåœ˜èº«é«” SVG Path
        const DOUGH_BODY = `<path d="M50 15C30 15 10 30 10 60C10 85 25 95 50 95C75 95 90 85 90 60C90 30 70 15 50 15Z" fill="#FFFFFF" stroke="#5C5552" stroke-width="2.5"/>`;
        const CHEEKS = `<circle cx="28" cy="62" r="3.5" fill="#FFD1DC" opacity="0.9"/><circle cx="72" cy="62" r="3.5" fill="#FFD1DC" opacity="0.9"/>`;

        // ç”Ÿæˆæƒ…ç·’ Icon SVG
        function getMoodIcon(moodId) {
            let content = '';
            switch(moodId) {
                case 'anxious': // ç„¦æ…®ï¼šç™¼æŠ–ã€æ±—æ»´
                    content = `
                        ${DOUGH_BODY} ${CHEEKS}
                        <g style="animation: sway 0.2s infinite">
                            <circle cx="35" cy="55" r="4" fill="#5C5552"/>
                            <circle cx="65" cy="55" r="4" fill="#5C5552"/>
                            <path d="M45 68 Q50 72 55 68" stroke="#5C5552" stroke-width="2" fill="none"/>
                        </g>
                        <path d="M20 30 Q20 40 25 40 Q30 40 30 30" fill="#A0C4FF" style="animation: tearDrop 1s infinite"/>
                    `;
                    break;
                case 'low': // ä½è½ï¼šèåŒ–æ‰æ‰çš„
                    content = `
                        <path d="M50 35C30 35 10 45 10 70C10 90 25 95 50 95C75 95 90 90 90 70C90 45 70 35 50 35Z" fill="#FFFFFF" stroke="#5C5552" stroke-width="2.5"/>
                        ${CHEEKS}
                        <path d="M30 60 L40 65" stroke="#5C5552" stroke-width="2" stroke-linecap="round"/>
                        <path d="M70 60 L60 65" stroke="#5C5552" stroke-width="2" stroke-linecap="round"/>
                        <path d="M45 75 Q50 70 55 75" stroke="#5C5552" stroke-width="2" fill="none"/>
                    `;
                    break;
                case 'angry': // ç”Ÿæ°£ï¼šæ¼²ç´…ã€å†’ç…™
                    content = `
                        ${DOUGH_BODY}
                        <path d="M30 50 L40 55" stroke="#5C5552" stroke-width="2.5"/>
                        <path d="M70 50 L60 55" stroke="#5C5552" stroke-width="2.5"/>
                        <circle cx="35" cy="60" r="3" fill="#5C5552"/>
                        <circle cx="65" cy="60" r="3" fill="#5C5552"/>
                        <path d="M45 75 Q50 70 55 75" stroke="#5C5552" stroke-width="2" fill="none"/>
                        <path d="M50 10 L50 5" stroke="#FF6B6B" stroke-width="3" style="animation: floatItem 0.5s infinite"/>
                        <path d="M60 12 L62 6" stroke="#FF6B6B" stroke-width="3" style="animation: floatItem 0.6s infinite"/>
                    `;
                    break;
                case 'numb': // éº»æœ¨ï¼šè™›ç·šã€ç©ºæ´çœ¼
                    content = `
                        <path d="M50 15C30 15 10 30 10 60C10 85 25 95 50 95C75 95 90 85 90 60C90 30 70 15 50 15Z" fill="#FFFFFF" stroke="#5C5552" stroke-width="2.5" stroke-dasharray="4 4"/>
                        <circle cx="28" cy="62" r="3.5" fill="#DDD" opacity="0.9"/><circle cx="72" cy="62" r="3.5" fill="#DDD" opacity="0.9"/>
                        <circle cx="35" cy="55" r="4" stroke="#5C5552" stroke-width="2" fill="none"/>
                        <circle cx="65" cy="55" r="4" stroke="#5C5552" stroke-width="2" fill="none"/>
                        <line x1="45" y1="70" x2="55" y2="70" stroke="#5C5552" stroke-width="2"/>
                    `;
                    break;
                case 'confused': // è¿·æƒ˜ï¼šèšŠé¦™çœ¼
                    content = `
                        ${DOUGH_BODY} ${CHEEKS}
                        <g style="animation: spinEye 3s linear infinite; transform-origin: 35px 55px">
                            <path d="M35 55 m-3 0 a 3 3 0 1 0 6 0 a 3 3 0 1 0 -6 0" stroke="#5C5552" stroke-width="1.5" fill="none"/>
                        </g>
                        <g style="animation: spinEye 3s linear infinite reverse; transform-origin: 65px 55px">
                            <path d="M65 55 m-3 0 a 3 3 0 1 0 6 0 a 3 3 0 1 0 -6 0" stroke="#5C5552" stroke-width="1.5" fill="none"/>
                        </g>
                        <path d="M48 70 Q50 68 52 70" stroke="#5C5552" stroke-width="2"/>
                    `;
                    break;
                case 'panic': // å´©æ½°ï¼šæ®æ‰‹
                    content = `
                        <g style="animation: panicWave 0.2s infinite">
                             ${DOUGH_BODY} ${CHEEKS}
                            <circle cx="35" cy="55" r="5" fill="#5C5552"/>
                            <circle cx="65" cy="55" r="5" fill="#5C5552"/>
                            <ellipse cx="50" cy="72" rx="6" ry="8" fill="#5C5552"/>
                            <path d="M10 60 L0 50" stroke="#5C5552" stroke-width="3"/>
                            <path d="M90 60 L100 50" stroke="#5C5552" stroke-width="3"/>
                        </g>
                    `;
                    break;
            }
            return `<svg viewBox="0 0 100 100" fill="none" class="mood-icon-svg">${content}</svg>`;
        }

        // ç”ŸæˆåŠŸèƒ½ Icon SVG
        function getFeatureIcon(id) {
            let content = '';
            // é è¨­çœ¼ç›å˜´å·´
            let eyes = `<circle cx="35" cy="55" r="4" fill="#5C5552"/><circle cx="65" cy="55" r="4" fill="#5C5552"/>`;
            let mouth = `<path d="M45 68 Q50 72 55 68" stroke="#5C5552" stroke-width="2" fill="none"/>`;

            switch(id) {
                case 'dbt_cards': // è‡ªæˆ‘ç…§é¡§å¡ï¼šèˆˆå¥®æ‹¿å¡
                    content = `
                        ${DOUGH_BODY} ${CHEEKS} ${eyes} 
                        <path d="M45 65 Q50 75 55 65" stroke="#5C5552" stroke-width="2" fill="none"/>
                        <rect x="60" y="40" width="20" height="30" rx="2" fill="white" stroke="#5C5552" stroke-width="2" transform="rotate(15 60 40)" style="animation: floatItem 2s infinite"/>
                        <path d="M65 45 L75 50" stroke="#FFD1DC" stroke-width="2"/>
                    `;
                    break;
                case 'quotes': // ç™‚ç™’é‡‘å¥ï¼šå¹¸ç¦è¡¨æƒ…èªªè©±ï¼Œå°è©±æ¡†
                    content = `
                        ${DOUGH_BODY} ${CHEEKS}
                        <path d="M30 55 Q35 50 40 55" stroke="#5C5552" stroke-width="2" fill="none"/>
                        <path d="M60 55 Q65 50 70 55" stroke="#5C5552" stroke-width="2" fill="none"/>
                        <circle cx="50" cy="68" r="4" fill="#5C5552"/>
                        <path d="M70 20 H90 V35 H70 L65 40 V20 Z" fill="white" stroke="#5C5552" stroke-width="2"/>
                        <circle cx="76" cy="28" r="1.5" fill="#5C5552"/><circle cx="80" cy="28" r="1.5" fill="#5C5552"/><circle cx="84" cy="28" r="1.5" fill="#5C5552"/>
                    `;
                    break;
                case 'tarot': // å¡”ç¾…ï¼šé–‰çœ¼æ‹¿æ°´æ™¶çƒ
                    content = `
                        ${DOUGH_BODY} ${CHEEKS}
                        <path d="M30 55 L40 55" stroke="#5C5552" stroke-width="2"/>
                        <path d="M60 55 L70 55" stroke="#5C5552" stroke-width="2"/>
                        <circle cx="50" cy="80" r="12" fill="#E0F7FA" stroke="#5C5552" stroke-width="1.5" opacity="0.8"/>
                        <path d="M50 75 L52 77" stroke="white" stroke-width="2"/>
                    `;
                    break;
                case 'answer_book': // è§£ç­”ä¹‹æ›¸ï¼šæˆ´çœ¼é¡æ‹¿æ›¸(å´é¢)
                    content = `
                        ${DOUGH_BODY} ${CHEEKS} ${eyes} ${mouth}
                        <circle cx="35" cy="55" r="7" stroke="#5C5552" stroke-width="1.5" fill="none"/>
                        <circle cx="65" cy="55" r="7" stroke="#5C5552" stroke-width="1.5" fill="none"/>
                        <line x1="42" y1="55" x2="58" y2="55" stroke="#5C5552" stroke-width="1.5"/>
                        <rect x="75" y="50" width="15" height="25" fill="#5C5552" transform="rotate(10)"/>
                        <rect x="78" y="52" width="2" height="21" fill="white" transform="rotate(10)"/>
                    `;
                    break;
                case 'questions': // å•å¥ï¼šé–‰çœ¼æ€è€ƒï¼Œå•è™Ÿ
                    content = `
                        ${DOUGH_BODY} ${CHEEKS}
                        <path d="M30 58 L40 58" stroke="#5C5552" stroke-width="2"/>
                        <path d="M60 58 L70 58" stroke="#5C5552" stroke-width="2"/>
                        <text x="15" y="30" font-size="20" fill="#5C5552" style="animation: floatItem 2s infinite">?</text>
                        <text x="75" y="30" font-size="16" fill="#5C5552" style="animation: floatItem 3s infinite reverse">?</text>
                    `;
                    break;
                case 'jokes': // ç¬‘è©±ï¼šå¤§ç¬‘
                    content = `
                        ${DOUGH_BODY} ${CHEEKS}
                        <path d="M30 50 L35 55 L40 50" stroke="#5C5552" stroke-width="2" fill="none"/>
                        <path d="M60 50 L65 55 L70 50" stroke="#5C5552" stroke-width="2" fill="none"/>
                        <path d="M40 65 Q50 80 60 65" fill="#5C5552"/>
                        <path d="M10 60 Q5 50 15 50" stroke="#5C5552" stroke-width="2" fill="none" style="animation: sway 0.5s infinite"/>
                        <path d="M90 60 Q95 50 85 50" stroke="#5C5552" stroke-width="2" fill="none" style="animation: sway 0.5s infinite"/>
                    `;
                    break;
                case 'animals': // æ¯›å­©ï¼šè²“è€³ã€é¬é¬šã€å°¾å·´
                    content = `
                        ${DOUGH_BODY} ${CHEEKS} ${eyes} ${mouth}
                        <path d="M30 20 L40 5 L50 20" fill="white" stroke="#5C5552" stroke-width="2.5"/>
                        <path d="M50 20 L60 5 L70 20" fill="white" stroke="#5C5552" stroke-width="2.5"/>
                        <line x1="20" y1="60" x2="5" y2="55" stroke="#5C5552" stroke-width="1.5"/>
                        <line x1="20" y1="65" x2="5" y2="70" stroke="#5C5552" stroke-width="1.5"/>
                        <line x1="80" y1="60" x2="95" y2="55" stroke="#5C5552" stroke-width="1.5"/>
                        <line x1="80" y1="65" x2="95" y2="70" stroke="#5C5552" stroke-width="1.5"/>
                        <path d="M85 80 Q95 80 95 60" stroke="#5C5552" stroke-width="3" fill="none" stroke-linecap="round" style="animation: sway 2s infinite"/>
                    `;
                    break;
                case 'tasks': // æˆå°±ï¼šè‚Œè‚‰èªçœŸ
                    content = `
                        <g style="animation: muscleFlex 1.5s infinite">
                            ${DOUGH_BODY} ${CHEEKS}
                            <line x1="30" y1="48" x2="40" y2="55" stroke="#5C5552" stroke-width="2.5"/>
                            <line x1="70" y1="48" x2="60" y2="55" stroke="#5C5552" stroke-width="2.5"/>
                            <path d="M45 70 H55" stroke="#5C5552" stroke-width="2"/>
                            <path d="M15 60 Q5 50 15 40" stroke="#5C5552" stroke-width="4" fill="none"/>
                            <path d="M85 60 Q95 50 85 40" stroke="#5C5552" stroke-width="4" fill="none"/>
                        </g>
                    `;
                    break;
                case 'breathing': // å‘¼å¸ï¼šå…¨èº«ç¸®æ”¾
                    content = `
                        <g style="animation: breathe 4s ease-in-out infinite">
                            ${DOUGH_BODY} ${CHEEKS}
                            <path d="M30 55 Q35 50 40 55" stroke="#5C5552" stroke-width="2" fill="none"/>
                            <path d="M60 55 Q65 50 70 55" stroke="#5C5552" stroke-width="2" fill="none"/>
                            <circle cx="50" cy="70" r="3" fill="#5C5552"/>
                            <path d="M48 85 Q50 90 52 85" stroke="#5C5552" stroke-width="2"/>
                        </g>
                    `;
                    break;
                case 'clicker': // æ³¡æ³¡ï¼šçœ¼ç›ç™¼äº®æˆ³æ³¡æ³¡
                    content = `
                        ${DOUGH_BODY} ${CHEEKS} ${mouth}
                        <circle cx="35" cy="55" r="4" fill="#5C5552"/><circle cx="37" cy="53" r="1.5" fill="white"/>
                        <circle cx="65" cy="55" r="4" fill="#5C5552"/><circle cx="67" cy="53" r="1.5" fill="white"/>
                        <circle cx="80" cy="40" r="5" stroke="#5C5552" fill="white" opacity="0.7"/>
                        <circle cx="20" cy="80" r="4" stroke="#5C5552" fill="white" opacity="0.7"/>
                        <path d="M80 60 L85 50" stroke="#5C5552" stroke-width="2.5" style="animation: floatItem 0.5s infinite"/>
                    `;
                    break;
                case 'whiteboard': // å¡—é´‰ï¼šç•«å®¶å¸½ã€èª¿è‰²ç›¤
                    content = `
                        ${DOUGH_BODY} ${CHEEKS} ${eyes} ${mouth}
                        <path d="M30 20 Q50 5 70 20 H30 Z" fill="#5C5552"/>
                        <rect x="48" y="10" width="4" height="6" fill="#5C5552"/>
                        <circle cx="20" cy="70" r="10" fill="white" stroke="#5C5552" stroke-width="1.5"/>
                        <circle cx="18" cy="68" r="2" fill="#FF6B6B"/>
                        <circle cx="22" cy="72" r="2" fill="#4ECDC4"/>
                        <line x1="80" y1="70" x2="90" y2="60" stroke="#5C5552" stroke-width="2"/>
                    `;
                    break;
                case 'conveyor': // è¼¸é€å¸¶ï¼šçœ‹è‘—å°è©±æ¡†é å»
                    content = `
                        ${DOUGH_BODY} ${CHEEKS} ${eyes}
                        <path d="M45 68 Q50 72 55 68" stroke="#5C5552" stroke-width="2" fill="none"/>
                        <rect x="60" y="30" width="15" height="10" rx="2" stroke="#5C5552" fill="white" style="animation: conveyorMove 2s linear infinite"/>
                        <line x1="10" y1="85" x2="90" y2="85" stroke="#5C5552" stroke-width="2" stroke-dasharray="5 5"/>
                    `;
                    break;
                case 'worry_jar': // ç…©æƒ±å¯„æ”¾ï¼šé ­æ‰“é–‹ï¼Œç„¡ç·šæ¢
                    content = `
                         <path d="M50 35C30 35 10 45 10 60C10 85 25 95 50 95C75 95 90 85 90 60C90 45 70 35 50 35Z" fill="#FFFFFF" stroke="#5C5552" stroke-width="1.5" stroke-dasharray="2 2"/>
                        ${CHEEKS} ${eyes} ${mouth}
                        <g style="animation: lidOpen 3s infinite">
                             <path d="M50 35 C30 35 10 45 10 50 L90 50 C90 45 70 35 50 35Z" fill="white" stroke="#5C5552" stroke-width="2"/>
                        </g>
                    `;
                    break;
                case 'sos': // å®‰å…¨ç¶²ï¼šèˆ‰ç´…å¸ƒæ¢
                    content = `
                        ${DOUGH_BODY} ${CHEEKS}
                        <path d="M35 55 L40 50 L35 45" stroke="#5C5552" stroke-width="2" fill="none"/> <path d="M65 55 L60 50 L65 45" stroke="#5C5552" stroke-width="2" fill="none"/>
                        <path d="M45 70 Q50 65 55 70" stroke="#5C5552" stroke-width="2" fill="none"/>
                        <rect x="20" y="80" width="60" height="15" fill="#FF6B6B" stroke="#5C5552" rx="2"/>
                        <text x="32" y="91" font-family="Arial" font-weight="bold" font-size="10" fill="white">SOS</text>
                        <path d="M20 75 L20 80" stroke="#5C5552" stroke-width="2"/>
                        <path d="M80 75 L80 80" stroke="#5C5552" stroke-width="2"/>
                    `;
                    break;
            }
            return `<svg viewBox="0 0 100 100" fill="none" class="feature-svg">${content}</svg>`;
        }


        // ============================================
        // 2. APP æ ¸å¿ƒè³‡æ–™
        // ============================================
        
        // æ›´æ–° featuresDBï¼Œç§»é™¤ icon å±¬æ€§ï¼Œæ”¹ç”± getFeatureIcon å‹•æ…‹ç”Ÿæˆ
        const featuresDB = [
            { id: 'dbt_cards', name: 'è‡ªæˆ‘ç…§é¡§å¡', tag: 'DBTç­–ç•¥', moods: ['anxious', 'low', 'numb'], keywords: 'å¡ç‰‡,æŠ½å¡,ç­–ç•¥' },
            { id: 'quotes', name: 'ç™‚ç™’é‡‘å¥', tag: 'æ–‡å­—åŠ›é‡', moods: ['low', 'stress'], keywords: 'èªéŒ„,å¥å­,é¼“å‹µ' },
            { id: 'tarot', name: 'å¡”ç¾…æŒ‡å¼•', tag: 'æ½›æ„è­˜', moods: ['anxious', 'confused'], keywords: 'å¡”ç¾…,å åœ' },
            { id: 'answer_book', name: 'è§£ç­”ä¹‹æ›¸', tag: 'éˆæ„ŸæŒ‡å¼•', moods: ['confused', 'anxious'], keywords: 'è§£ç­”,å›°æƒ‘,è¿·æƒ˜' }, 
            { id: 'questions', name: 'å•å¥å¼•å°', tag: 'è‡ªæˆ‘å°è©±', moods: ['low', 'confused', 'numb'], keywords: 'æ•˜äº‹,sfbt,æ€è€ƒ' }, 
            { id: 'jokes', name: 'ç¬‘è©±æ€¥è½‰å½', tag: 'è½‰æ›å¿ƒæƒ…', moods: ['stress', 'low'], keywords: 'ç¬‘è©±,é–‹å¿ƒ' },
            { id: 'animals', name: 'æ¯›å­©ç™‚ç™’', tag: 'è¦–è¦ºå®‰æ’«', moods: ['stress', 'low', 'angry'], keywords: 'è²“,ç‹—,å¯æ„›' },
            { id: 'tasks', name: 'å¾®å°æˆå°±', tag: 'è¡Œå‹•', moods: ['numb', 'low'], keywords: 'ä»»å‹™,å‹•åŠ›' },
            { id: 'breathing', name: 'å‘¼å¸ç·´ç¿’', tag: 'ç”Ÿç†èª¿ç¯€', moods: ['anxious', 'angry', 'panic'], keywords: 'å‘¼å¸,æ”¾é¬†,å†¥æƒ³' },
            { id: 'clicker', name: 'ç´“å£“æ³¡æ³¡', tag: 'é‡‹æ”¾å£“åŠ›', moods: ['stress', 'angry'], keywords: 'æŒ‰éˆ•,æ³¡æ³¡ç´™' },
            { id: 'whiteboard', name: 'æƒ…ç·’å¡—é´‰', tag: 'è¡¨é”', moods: ['angry', 'confused', 'numb'], keywords: 'ç•«ç•«,å¯«å­—,ç™½æ¿' },
            { id: 'conveyor', name: 'å¿µé ­è¼¸é€å¸¶', tag: 'ACTè„«é‰¤', moods: ['anxious', 'stress'], keywords: 'å¿µé ­,æƒ³æ³•' },
            { id: 'worry_jar', name: 'ç…©æƒ±å¯„æ”¾', tag: 'é‚Šç•Œè¨­å®š', moods: ['anxious', 'stress'], keywords: 'ç…©æƒ±,ç¡ä¸è‘—' },
            { id: 'sos', name: 'å®‰å…¨ç¶² SOS', tag: 'å±æ©Ÿæ±‚åŠ©', moods: ['panic', 'low'], keywords: 'æ±‚æ•‘,é›»è©±' }
        ];

        // å¢åŠ  color å±¬æ€§çµ¦é‚Šæ¡†ç”¨
        const moodOptions = [
            { id: 'anxious', label: 'ğŸ˜° ç„¦æ…®æ…Œå¼µ', color: '#A0C4FF' },
            { id: 'low', label: 'ğŸ˜ ä½è½ç„¡åŠ›', color: '#5C5552' },
            { id: 'angry', label: 'ğŸ˜¡ ç”Ÿæ°£æ†¤æ€’', color: '#FF6B6B' },
            { id: 'numb', label: 'ğŸ˜¶ éº»æœ¨æ”¾ç©º', color: '#CCCCCC' },
            { id: 'confused', label: 'ğŸ¤” è¿·æƒ˜å›°æƒ‘', color: '#BDB2FF' },
            { id: 'panic', label: 'ğŸ†˜ å¿«å´©æ½°äº†', color: '#FFADAD' }
        ];

        let favorites = JSON.parse(localStorage.getItem('safeSpaceFavs')) || [];
        let selectedMoods = new Set();
        let isFavFilterActive = false;
        let searchKeyword = "";

        // --- 3. åˆå§‹åŒ– ---
        const toolboxEl = document.getElementById('toolbox');
        const moodGrid = document.getElementById('mood-grid-container');
        const searchInput = document.getElementById('search-input');
        const favFabBtn = document.getElementById('fav-fab-btn');

        function initApp() {
            renderMoodButtons();
            updateResults();
            initPetSystem();
            initMusicSystem(); // å•Ÿå‹•éŸ³æ¨‚å¼•æ“
        }

        // æ¸²æŸ“æƒ…ç·’æŒ‰éˆ• (å‡ç´šç‰ˆ)
        function renderMoodButtons() {
            moodGrid.innerHTML = '';
            moodOptions.forEach(mood => {
                const btn = document.createElement('div');
                btn.className = 'mood-card';
                btn.dataset.id = mood.id;
                // é»æ“Šäº‹ä»¶
                btn.onclick = () => toggleMood(mood.id);
                
                // å…§å®¹ï¼šSVG + æ–‡å­—
                btn.innerHTML = `
                    ${getMoodIcon(mood.id)}
                    <div class="mood-label">${mood.label}</div>
                `;
                
                // å‹•æ…‹è¨­ç½®é‚Šæ¡†é¡è‰² CSS è®Šæ•¸ (é¸ä¸­æ™‚ä½¿ç”¨)
                btn.style.setProperty('--mood-color', mood.color);

                moodGrid.appendChild(btn);
            });
        }

        // æ›´æ–°çµæœ (å« Mood Active æ¨£å¼è™•ç†)
        function updateResults() {
            document.querySelectorAll('.mood-card').forEach(btn => {
                const id = btn.dataset.id;
                const moodData = moodOptions.find(m => m.id === id);
                if(selectedMoods.has(id)) {
                    btn.classList.add('active');
                    btn.style.borderColor = moodData.color; // åŠ ä¸Šé¡è‰²é‚Šæ¡†
                } else {
                    btn.classList.remove('active');
                    btn.style.borderColor = 'transparent';
                }
            });

            if(isFavFilterActive) favFabBtn.classList.add('active');
            else favFabBtn.classList.remove('active');

            let filtered = featuresDB.filter(item => {
                const matchKeyword = searchKeyword === "" || item.name.includes(searchKeyword) || item.keywords.includes(searchKeyword) || item.tag.includes(searchKeyword);
                const itemMoodsSet = new Set(item.moods);
                const hasMoodIntersection = [...selectedMoods].some(mood => itemMoodsSet.has(mood));
                const matchMood = selectedMoods.size === 0 || hasMoodIntersection;
                const matchFav = !isFavFilterActive || favorites.includes(item.id);
                return matchKeyword && matchMood && matchFav;
            });
            renderFeatures(filtered);
        }

        function renderFeatures(list) {
            toolboxEl.innerHTML = '';
            if (list.length === 0) {
                toolboxEl.innerHTML = `<div style="grid-column:span 2; text-align:center; padding:30px; color:#aaa; font-weight:700;">ğŸ‚<br>é€™è£¡ç©ºç©ºçš„</div>`;
                return;
            }
            list.forEach(feature => {
                const isFav = favorites.includes(feature.id);
                const card = document.createElement('div');
                card.className = 'feature-card';
                // é€™è£¡å‘¼å« getFeatureIcon
                card.innerHTML = `
                    <div class="card-fav-btn ${isFav ? 'is-active' : ''}" onclick="toggleCardFav(event, '${feature.id}')">
                        ${isFav ? 'â¤ï¸' : 'ğŸ¤'}
                    </div>
                    <div class="card-visual">${getFeatureIcon(feature.id)}</div>
                    <div class="card-title">${feature.name}</div>
                    <div class="card-tag">${feature.tag}</div>
                `;
                card.onclick = (e) => {
                    if(e.target.classList.contains('card-fav-btn')) return;
                    openFeature(feature);
                };
                toolboxEl.appendChild(card);
            });
        }

        function toggleMood(moodId) {
            if (selectedMoods.has(moodId)) selectedMoods.delete(moodId);
            else selectedMoods.add(moodId);
            ensureHistoryState();
            updateResults();
        }

        function toggleFavFilter() {
            isFavFilterActive = !isFavFilterActive;
            ensureHistoryState();
            updateResults();
        }

        function toggleCardFav(event, id) {
            event.stopPropagation();
            if (favorites.includes(id)) favorites = favorites.filter(favId => favId !== id);
            else favorites.push(id);
            localStorage.setItem('safeSpaceFavs', JSON.stringify(favorites));
            if(isFavFilterActive) updateResults();
            else {
                const btn = event.currentTarget;
                const isNowFav = favorites.includes(id);
                btn.innerHTML = isNowFav ? 'â¤ï¸' : 'ğŸ¤';
                btn.classList.toggle('is-active');
            }
        }

        searchInput.addEventListener('input', (e) => {
            searchKeyword = e.target.value.toLowerCase().trim();
            if(searchKeyword !== "") ensureHistoryState();
            updateResults();
        });

        function resetAllFilters() {
            selectedMoods.clear();
            isFavFilterActive = false;
            searchKeyword = "";
            searchInput.value = "";
            updateResults();
        }

        function ensureHistoryState() {
            if (window.location.hash !== '#filter' && window.location.hash !== '#feature') {
                history.pushState({ type: 'filter' }, null, '#filter');
            }
        }
        
        const modal = document.getElementById('active-feature-container');
        const title = document.getElementById('feature-title-display');
        function openFeature(feature) {
            modal.style.display = 'flex';
            title.innerText = feature.name;
            history.pushState({ type: 'modal' }, null, "#feature");
        }
        window.addEventListener('popstate', function(event) {
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
                return;
            }
            resetAllFilters();
        });


        // ============================================
        // 4. éºµåœ˜ç²¾éˆç³»çµ± (å«é˜²é€£é»èˆ‡å‘¼å¸è²)
        // ============================================
        const petEl = document.getElementById('spirit-pet');
        const petToggleBtn = document.getElementById('pet-toggle-btn');
        const petToggleLabel = document.getElementById('pet-toggle-label');
        const petSpeech = document.getElementById('pet-speech');
        
        let isPetActive = JSON.parse(localStorage.getItem('safeSpacePetActive')) ?? true; 
        let petMoveInterval;
        let isDragging = false;
        let audioCtx = null;
        let speechTimeout;
        let lastInteractionTime = 0;

        const comfortMessages = [
            'è¨˜å¾—å–æ°´å–” <span class="kaomoji">( Ë˜ Â³Ë˜)â™¥</span>', 
            'æ·±å‘¼å¸ï½ <span class="kaomoji">( Â´ â–½ ` )ï¾‰</span>', 
            'æˆ‘åœ¨é€™è£¡é™ªä½  <span class="kaomoji">(Â´â€¢ Ï‰ â€¢`)</span>', 
            'ä½ åšå¾—å¾ˆå¥½ <span class="kaomoji">(à¹‘â€¢Ì€ã…‚â€¢Ì)Ùˆâœ§</span>', 
            'ä¼‘æ¯ä¸€ä¸‹å§ <span class="kaomoji">_(:3 ã€âˆ  )_</span>', 
            'æ…¢æ…¢ä¾†ï¼Œæ²’é—œä¿‚ <span class="kaomoji">(ãƒ»âˆ€ãƒ»)</span>', 
            'ä»Šå¤©å¤©ç©ºå¾ˆç¾å—ï¼Ÿ <span class="kaomoji">(âÂ´â—¡`â)</span>', 
            'æŠ±æŠ± <span class="kaomoji">(ã¤Â´Ï‰`)ã¤</span>', 
            'æ”¾è¼•é¬†ï½ <span class="kaomoji">(ï¿£â–½ï¿£)~*</span>', 
            'ä½ çš„æ„Ÿå—å¾ˆé‡è¦ <span class="kaomoji">(ï½¡â€¢Ìï¸¿â€¢Ì€ï½¡)</span>', 
            'æˆ‘æœƒä¸€ç›´é™ªè‘—ä½  <span class="kaomoji">( >Ï‰<)</span>'
        ];

        function initPetSystem() {
            const savedX = localStorage.getItem('petX');
            const savedY = localStorage.getItem('petY');
            
            if (savedX && savedY) {
                petEl.style.left = savedX + 'px';
                petEl.style.top = savedY + 'px';
            } else {
                petEl.style.left = (window.innerWidth - 100) + 'px';
                petEl.style.top = '100px';
            }

            petToggleBtn.onclick = togglePetSystem;
            setupPetInteraction();
            updatePetVisibility();
            if (isPetActive) startPetBehavior();
        }

        function togglePetSystem() {
            isPetActive = !isPetActive;
            localStorage.setItem('safeSpacePetActive', isPetActive);
            updatePetVisibility();
            
            if (isPetActive) {
                startPetBehavior();
                playExhaleSound();
                showSpeech('æˆ‘å›ä¾†äº†ï¼<span class="kaomoji">(â‰§âˆ‡â‰¦)/</span>', 3500);
            } else {
                stopPetBehavior();
            }
        }

        function updatePetVisibility() {
            if (isPetActive) {
                petEl.style.display = 'block';
                petToggleLabel.innerText = 'å¬å–šéºµåœ˜';
                petToggleBtn.classList.remove('off');
            } else {
                petEl.style.display = 'none';
                petToggleLabel.innerText = 'ä¼‘æ¯ä¸­';
                petToggleBtn.classList.add('off');
            }
        }

        function startPetBehavior() {
            petMoveInterval = setInterval(() => {
                if(!isDragging) movePetRandomly();
            }, 12000);
        }

        function stopPetBehavior() {
            clearInterval(petMoveInterval);
        }

        function movePetRandomly() {
            petEl.classList.add('auto-moving');
            const maxX = window.innerWidth - 90;
            const maxY = window.innerHeight - 90;
            const randomX = Math.max(20, Math.random() * maxX);
            const randomY = Math.max(80, Math.random() * maxY);

            petEl.style.left = randomX + 'px';
            petEl.style.top = randomY + 'px';

            localStorage.setItem('petX', randomX);
            localStorage.setItem('petY', randomY);
        }

        function setupPetInteraction() {
            let startX, startY, initialLeft, initialTop;
            let moveDistance = 0;

            const startDrag = (e) => {
                if(!isPetActive) return;
                isDragging = true;
                petEl.classList.remove('auto-moving'); 
                
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                startX = clientX;
                startY = clientY;
                initialLeft = petEl.offsetLeft;
                initialTop = petEl.offsetTop;
                moveDistance = 0;

                resumeAudioContext(); // ç¢ºä¿éŸ³è¨Šç’°å¢ƒå·²å•Ÿå‹•
            };

            const doDrag = (e) => {
                if (!isDragging) return;
                e.preventDefault(); 
                
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                const dx = clientX - startX;
                const dy = clientY - startY;
                
                moveDistance += Math.abs(dx) + Math.abs(dy);

                petEl.style.left = (initialLeft + dx) + 'px';
                petEl.style.top = (initialTop + dy) + 'px';
            };

            const endDrag = (e) => {
                if (!isDragging) return;
                isDragging = false;
                
                localStorage.setItem('petX', parseInt(petEl.style.left));
                localStorage.setItem('petY', parseInt(petEl.style.top));

                if (moveDistance < 10) {
                    const now = Date.now();
                    if (now - lastInteractionTime > 300) { 
                        triggerInteraction();
                        lastInteractionTime = now;
                    }
                }
            };

            petEl.addEventListener('mousedown', startDrag);
            window.addEventListener('mousemove', doDrag);
            window.addEventListener('mouseup', endDrag);

            petEl.addEventListener('touchstart', startDrag, {passive: false});
            window.addEventListener('touchmove', doDrag, {passive: false});
            window.addEventListener('touchend', endDrag);
        }

        function triggerInteraction() {
            if (navigator.vibrate) navigator.vibrate(50);
            playExhaleSound();
            const body = petEl.querySelector('.pet-svg-body');
            body.classList.remove('pet-shake');
            void petEl.offsetWidth; 
            body.classList.add('pet-shake');
            const msg = comfortMessages[Math.floor(Math.random() * comfortMessages.length)];
            showSpeech(msg, 3500);
        }

        function playExhaleSound() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const duration = 4.0; 
            const bufferSize = audioCtx.sampleRate * duration;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);

            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }

            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;

            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(400, audioCtx.currentTime);
            filter.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + duration);

            const gainNode = audioCtx.createGain();
            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.15, audioCtx.currentTime + 0.5); 
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration); 

            noise.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            noise.start();
            noise.stop(audioCtx.currentTime + duration);
        }

        function showSpeech(text, duration) {
            if (speechTimeout) clearTimeout(speechTimeout);
            petSpeech.innerHTML = text; 
            petSpeech.classList.add('show');
            speechTimeout = setTimeout(() => {
                petSpeech.classList.remove('show');
            }, duration);
        }

        function resumeAudioContext() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        // ============================================
        // 5. èƒŒæ™¯éŸ³æ¨‚å¼•æ“ (Generative BGM)
        // ============================================
        
        const musicToggleBtn = document.getElementById('music-toggle-btn');
        const musicLabel = document.getElementById('music-label');
        let isMusicOn = JSON.parse(localStorage.getItem('safeSpaceMusicOn')) ?? true; // é è¨­é–‹å•Ÿ
        let bgmTimeout;
        let lastFreq = 220; // åˆå§‹é »ç‡ (A3)
        
        // äº”è²éŸ³éš (Pentatonic Scale) C Major: C, D, E, G, A
        // é »ç‡è¡¨ (ä½æ²ˆç‰ˆ)
        const scaleFreqs = [
            130.81, 146.83, 164.81, 196.00, 220.00, // C3 - A3
            261.63, 293.66, 329.63, 392.00, 440.00  // C4 - A4
        ];

        function initMusicSystem() {
            updateMusicBtn();
            musicToggleBtn.onclick = () => {
                isMusicOn = !isMusicOn;
                localStorage.setItem('safeSpaceMusicOn', isMusicOn);
                updateMusicBtn();
                
                if (isMusicOn) {
                    resumeAudioContext();
                    playNextNote();
                } else {
                    clearTimeout(bgmTimeout);
                }
            };
            
            // å¦‚æœé è¨­é–‹å•Ÿï¼Œç­‰å¾…ç¬¬ä¸€æ¬¡é»æ“Šé é¢å¾Œé–‹å§‹æ’­æ”¾ (ç€è¦½å™¨æ”¿ç­–)
            if (isMusicOn) {
                const startAudio = () => {
                    resumeAudioContext();
                    playNextNote();
                    document.removeEventListener('click', startAudio);
                    document.removeEventListener('touchstart', startAudio);
                };
                document.addEventListener('click', startAudio);
                document.addEventListener('touchstart', startAudio);
            }
        }

        function updateMusicBtn() {
            if (isMusicOn) {
                musicLabel.innerText = 'éŸ³æ¨‚é–‹å•Ÿ';
                musicToggleBtn.classList.remove('off');
            } else {
                musicLabel.innerText = 'éŸ³æ¨‚é—œé–‰';
                musicToggleBtn.classList.add('off');
            }
        }

        function playNextNote() {
            if (!isMusicOn) return;
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            // 1. é¸æ“‡ä¸‹ä¸€å€‹éŸ³ (ä¸é‡è¤‡ï¼Œä¸”éŸ³é«˜ç›¸è¿‘)
            let possibleIndices = [];
            const currentIdx = scaleFreqs.indexOf(lastFreq);
            
            // å…è¨±ä¸Šä¸‹ç§»å‹• 1 æˆ– 2 å€‹éŸ³éšï¼Œé˜²æ­¢å¤§è·³èº
            [-2, -1, 1, 2].forEach(step => {
                const idx = currentIdx + step;
                if (idx >= 0 && idx < scaleFreqs.length) possibleIndices.push(idx);
            });
            
            // å¦‚æœæ‰¾ä¸åˆ° (æ¯”å¦‚ç¬¬ä¸€æ¬¡åŸ·è¡Œ)ï¼Œå°±éš¨æ©Ÿé¸
            if (possibleIndices.length === 0) possibleIndices = [3, 4, 5, 6];

            const nextIdx = possibleIndices[Math.floor(Math.random() * possibleIndices.length)];
            const freq = scaleFreqs[nextIdx];
            lastFreq = freq;

            // 2. æ’­æ”¾é€™å€‹éŸ³
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            const filter = audioCtx.createBiquadFilter(); // ç”¨ filter è®“è²éŸ³è®Šåš

            // ä½¿ç”¨ Triangle æ³¢å½¢æ¯” Sine åšå¯¦ï¼Œæ¯” Square æŸ”å’Œ
            osc.type = 'triangle';
            osc.frequency.value = freq;

            // æ¿¾æ³¢å™¨è¨­å®šï¼šè®“é«˜é »ç¨å¾®è¢«åˆ‡æ‰ï¼Œè²éŸ³æ›´æº«æš–
            filter.type = 'lowpass';
            filter.frequency.value = 400; 

            // éŸ³é‡åŒ…çµ¡ (Envelope)ï¼šæ·¡å…¥ -> æŒçºŒ -> æ·¡å‡º
            const now = audioCtx.currentTime;
            const duration = 2.5; // æ¯å€‹éŸ³æŒçºŒä¹…ä¸€é»ï¼Œé€ æˆé‡ç–Šæ„Ÿ

            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.08, now + 0.5); // Attack
            gain.gain.exponentialRampToValueAtTime(0.001, now + duration); // Release

            osc.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);

            osc.start();
            osc.stop(now + duration);

            // 3. é ç´„ä¸‹ä¸€å€‹éŸ³ (éš¨æ©Ÿæ™‚é–“é–“éš” 1.5s - 2.5s)
            const nextTime = 1500 + Math.random() * 1000;
            bgmTimeout = setTimeout(playNextNote, nextTime);
        }

        initApp();
    </script>
</body>
</html>